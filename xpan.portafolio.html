<!DOCTYPE html>
<html lang="es">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>xpan — portafolio</title>

  <!-- preconnects habituales -->
  <link rel="preconnect" href="https://attachments.are.na" crossorigin>
  <link rel="preconnect" href="https://d2w9rnfcy7mm78.cloudfront.net" crossorigin>

  <style>
    :root { --gap: .5rem; }
    html { scroll-behavior: smooth; }
    body { margin:0; background:#fff; color:#000; font-family:"Times New Roman", serif; overflow-x:hidden; }

    /* header “falso”: el logo que viaja se vuelve fixed y sustituye el header visual */
    header { position: fixed; top: 1rem; left: 1rem; z-index: 40; pointer-events: none; }
    /* no mostramos nada aquí; el logo real es el del hero que viaja */
    header::after { content:''; display:block; width:50px; height:1px; }

    /* selector de idioma */
    .lang-select{ position:fixed; top:1rem; right:1rem; z-index:40; display:flex; gap:.5rem; }
    .lang-select button{
      background:none; border:none; font:inherit; font-size:.9rem; padding:.25rem .5rem; cursor:pointer; opacity:.5;
    }
    .lang-select button.active{ opacity:1; background:#00000032; color:#fff; }

    /* hero */
    .hero{ position:relative; width:100%; height:100svh; display:grid; place-items:center; overflow:clip; }
    .hero a{ display:inline-block; }
    .hero-logo{
    width:min(55vw, 420px);
    height:auto;
    max-width:80vw;
    display:block;                /* evita baseline “brincos” */
    will-change: transform;       /* solo transform, no opacity */
    transform-origin:center center;
    cursor:pointer;
    /* quitamos la transición CSS para evitar “pelea” con JS */
    }
    /* estado pegado como “header” */
    .hero-logo.stuck{
      position:fixed !important;
      top:1rem; left:1rem;
      width:50px; max-width:none;
      transform:none !important;
      z-index:50;
    }

    /* descripción + aei */
    .desc-wrap{ position:relative; padding:6rem 1rem 4rem; display:grid; place-items:center; overflow:clip; }
    .desc-inner{ max-width:820px; border-left:4px solid #000; padding-left:1rem; transition: opacity .5s ease, filter .5s ease; }
    .desc-inner h2{ font-size:1.35rem; margin:0 0 1rem; text-transform:lowercase; }
    .desc-inner p{ font-size:1rem; line-height:1.7; margin:0 0 .9rem; }
    .description{ display:none; }
    .description.active{ display:block; }

    .aei-bg{ position:absolute; inset:0; z-index:-1; pointer-events:none; opacity:.85; transition:opacity .4s ease, filter .4s ease; }
    .aei-bg .layer{ position:absolute; inset:0; }
    .aei-bg svg.lines{ position:absolute; inset:0; width:100%; height:100%; }
    .aei-sym{ position:absolute; width:clamp(56px, 8vw, 120px); filter:grayscale(100%); opacity:.9; will-change:transform; }

    .fade-away{ opacity:0; filter:blur(2px); }

    /* título de sección traducible */
    .section-title{ max-width:800px; padding-left:1rem; margin:0 0 1.25rem; font-weight:bold; text-transform:lowercase; opacity:.6; }

    /* entradas inyectadas */
    .entry{ margin-bottom:3.5rem; max-width:800px; position:relative; padding-left:1rem; content-visibility:auto; contain-intrinsic-size: 1px 900px; }
    .entry::before{ content:''; position:absolute; left:0; top:.4rem; width:4px; height:100%; background:#000; opacity:.1; }
    .entry strong{ font-size:1.1rem; font-weight:bold; text-transform:lowercase; display:block; margin-bottom:.25rem; }
    .entry span{ font-size:.85rem; opacity:.5; font-style:italic; display:block; margin-bottom:.25rem; }
    .entry a{ color:#000; text-decoration:underline; font-size:.9rem; }
    .entry a:hover{ background:#000; color:#fff; transition:.2s; }

    .carousel-wrapper{ margin-top:.5rem; overflow:hidden; width:100%; position:relative; }
    .carousel-track{ display:flex; gap:var(--gap); will-change:transform; touch-action:none; cursor:grab; }
    .carousel-track img, .carousel-track video, .carousel-video{
      width:calc((100% - 2*var(--gap))/3); aspect-ratio:4/3; object-fit:cover; border-radius:4px;
      opacity:.3; flex-shrink:0; transition:opacity .5s ease-in-out; display:block; height:auto;
    }
    .carousel-track img.highlight, .carousel-track video.highlight, .carousel-video.highlight{ opacity:1 !important; }
    .carousel-track video{ width:100%; height:100%; object-fit:cover; display:block; }
    @media (max-width:768px){ .carousel-track img, .carousel-track video, .carousel-video{ width:calc((100% - var(--gap))/2); } }
    @media (max-width:480px){ .carousel-track img, .carousel-track video, .carousel-video{ width:100%; } }

    @media (prefers-reduced-motion:reduce){
      .hero-logo{ transition:none; }
      .aei-bg{ transition:none; }
    }
  </style>
    <script src="/assets/js/video-autoplay-mobile.js" defer></script>
<script src="/assets/js/media-proxy.js" defer></script>
</head>
<body>
  <header aria-hidden="true"></header>

  <!-- selector multilingüe -->
  <nav class="lang-select" id="langSelect" aria-label="idioma">
    <button type="button" data-lang="es" class="active">es</button>
    <button type="button" data-lang="en">en</button>
    <button type="button" data-lang="fr">fr</button>
    <button type="button" data-lang="jp">jp</button>
  </nav>

  <!-- hero (logo que viaja y queda fijo con link al inicio) -->
  <section class="hero" id="hero">
    <a href="https://xpan.earth" aria-label="inicio xpan" id="homeLink">
      <img src="xpan.svg" alt="xpan" id="heroLogo" class="hero-logo" decoding="async" fetchpriority="high">
    </a>
  </section>

  <!-- descripción + aei -->
  <section class="desc-wrap" id="descWrap">
    <div class="aei-bg" id="aeiBg">
      <div class="layer" id="aeiLayer"></div>
      <svg class="lines" id="aeiLines"></svg>
    </div>

    <div class="desc-inner">
      <div class="description active" lang="es">
        <h2>xpan</h2>
        <p>xpan es un sistema independiente que desarrolla infraestructura cultural: arquitectura, sonido y tecnología integrados en estructuras modulares e intervenibles. opera como plataforma de investigación y producción, generando activaciones espaciales, sistemas de escucha y prototipos técnicos para contextos diversos.</p>
        <p>su práctica articula diseño, ingeniería y comunidad en procesos de larga duración, conectando nodos que rara vez coexisten en un mismo espacio. el resultado: dispositivos y espacios vivos, pensados para activar y archivar.</p>
      </div>
      <div class="description" lang="en">
        <h2>xpan</h2>
        <p>xpan is an independent system developing cultural infrastructure: architecture, sound, and technology integrated into modular, intervenable structures. it operates as a platform for research and production, generating spatial activations, listening systems, and technical prototypes across contexts.</p>
        <p>its practice articulates design, engineering, and community through long-term processes, connecting nodes that rarely coexist in the same space. the result: living devices and spaces, built to activate and to archive.</p>
      </div>
      <div class="description" lang="fr">
        <h2>xpan</h2>
        <p>xpan est un système indépendant qui développe une infrastructure culturelle : architecture, son et technologie intégrés dans des structures modulaires et intervenables. il fonctionne comme une plateforme de recherche et de production, générant des activations spatiales, des systèmes d’écoute et des prototypes techniques.</p>
        <p>sa pratique articule design, ingénierie et communauté dans des processus au long cours, connectant des nœuds qui coexistent rarement dans un même espace. résultat : des dispositifs et des espaces vivants, faits pour activer et archiver.</p>
      </div>
      <div class="description" lang="jp">
        <h2>xpan</h2>
        <p>xpan は、文化的インフラを開発する独立したシステムです。建築・音・テクノロジーを統合し、モジュール式で介入可能な構造として実装します。研究と制作のプラットフォームとして機能し、空間的アクティベーション、リスニング・システム、技術プロトタイプを生み出します。</p>
        <p>その実践は、長期的なプロセスの中でデザイン・エンジニアリング・コミュニティを編成し、通常は共存しないノード同士を結び合わせます。結果として、アクティベートとアーカイブのために設計された「生きた」装置と空間が生まれます。</p>
      </div>
    </div>
  </section>

  <!-- título traducible -->
  <h3 class="section-title" id="portfolio-title">proyectos destacados</h3>

  <!-- entradas (se inyectan desde arquitectura.index.html y mdtc.index.html) -->
  <div id="all-entries"></div>

  <script>
/* ================== i18n ================== */
const I18N = {
  es: { featured: 'proyectos destacados' },
  en: { featured: 'featured projects' },
  fr: { featured: 'projets sélectionnés' },
  jp: { featured: '主要プロジェクト' }
};
function setLang(lang){
  document.querySelectorAll('.lang-select button').forEach(b=>{
    b.classList.toggle('active', b.dataset.lang===lang);
  });
  document.querySelectorAll('.description').forEach(d=>d.classList.remove('active'));
  document.querySelectorAll(`.description[lang="${lang}"]`).forEach(d=>d.classList.add('active'));
  const t=document.getElementById('portfolio-title'); if(t&&I18N[lang]) t.textContent=I18N[lang].featured;
  try{ localStorage.setItem('xpan.lang',lang); }catch(e){}
}

/* ================== HERO: el mismo logo viaja y queda fijo ================== */
function initHero(){
  const heroLogo = document.getElementById('heroLogo');
  const hero = document.getElementById('hero');
  if(!heroLogo || !hero) return;

  // destino en header (coincide con 1rem, 50px)
  const TARGET_SIZE = 50;        // px
  const TARGET = { x: 16, y: 16 }; // top-left (1rem)

  // baseline (medido una vez, sin transform)
  let fromCenter = null; // {x,y}
  let fromWidth  = null; // number
  let stuck = false;

  // espera a que el layout estabilice un frame
  requestAnimationFrame(()=>{
    const r = heroLogo.getBoundingClientRect();
    fromCenter = { x: r.left + r.width/2, y: r.top + r.height/2 };
    fromWidth  = r.width;
    // primer sync
    onScroll();
  });

  // easing continuo, sin “curva barata”
  const smoothstep = t => t*t*(3 - 2*t);

  function sync(){
    if(!fromCenter || !fromWidth) return;

    const heroH = Math.max(hero.offsetHeight || 0, window.innerHeight || 0);
    // progreso basado en el alto del hero, con margen de seguridad
    const raw = window.scrollY / (heroH * 0.9);
    const t = Math.min(1, Math.max(0, raw));
    const e = smoothstep(t);

    // centro destino (centro del rectángulo final de 50px)
    const toCenter = { x: TARGET.x + TARGET_SIZE/2, y: TARGET.y + TARGET_SIZE/2 };

    // escala final deseada
    const targetScale = TARGET_SIZE / Math.max(1, fromWidth);
    const s = 1 + (targetScale - 1) * e;

    // delta de posición (del centro inicial al centro destino)
    const tx = (toCenter.x - fromCenter.x) * e;
    const ty = (toCenter.y - fromCenter.y) * e;

    // durante el viaje: todo por transform
    if(e < 0.9995){
      if(stuck){ heroLogo.classList.remove('stuck'); stuck = false; }
      heroLogo.style.transform = `translate3d(${tx}px, ${ty}px, 0) scale(${s})`;
    } else {
      // aterrizaje: fija en header una vez, sin parpadeo
      if(!stuck){
        heroLogo.classList.add('stuck');
        heroLogo.style.transform = 'none';
        stuck = true;
      }
    }
  }

  let ticking = false;
  function onScroll(){
    if(!ticking){
      ticking = true;
      requestAnimationFrame(()=>{ sync(); ticking = false; });
    }
  }

  window.addEventListener('scroll', onScroll, { passive:true });
  window.addEventListener('resize', onScroll);
}


/* ================== AEI: símbolos y líneas ================== */
function initAEI(){
  const layer = document.getElementById('aeiLayer');
  const svg   = document.getElementById('aeiLines');
  const wrap  = document.getElementById('descWrap');
  if(!layer || !svg || !wrap) return;

  const urls = [
    "https://d2w9rnfcy7mm78.cloudfront.net/40745994/original_77a7afa258aa463a8c945e0b55b0ead8.png?1761881049&bc=0",
    "https://d2w9rnfcy7mm78.cloudfront.net/40745991/original_98ebeabf5a4b3e7622c7f357502e2217.png?1761881049&bc=0",
    "https://d2w9rnfcy7mm78.cloudfront.net/40745993/original_6d0449268d243af2fe98b069ef0df687.png?1761881049&bc=0",
    "https://d2w9rnfcy7mm78.cloudfront.net/40745995/original_d77cd22950a8a1e2ddd6e6e6283e1dc8.png?1761881049&bc=0",
    "https://d2w9rnfcy7mm78.cloudfront.net/40745992/original_1fc9933b2f8ce7925a5aae9c88b34813.png?1761881049&bc=0",
    "https://d2w9rnfcy7mm78.cloudfront.net/40745990/original_ca4f1fd040fe036fd3768bddd9487fd7.png?1761881049&bc=0",
    "https://d2w9rnfcy7mm78.cloudfront.net/40745988/original_2978ffd117332e5c884c826f681d6285.png?1761881049&bc=0",
    "https://d2w9rnfcy7mm78.cloudfront.net/40745989/original_f6ed552681cba118f73eb07cf24cbabc.png?1761881049&bc=0",
    "https://d2w9rnfcy7mm78.cloudfront.net/40745986/original_996fe49af0bdd77d341f9ed4891ea560.png?1761881049&bc=0",
    "https://d2w9rnfcy7mm78.cloudfront.net/40745987/original_a6019cb169d907ed522ab3aeb54b3742.png?1761881049&bc=0",
    "https://d2w9rnfcy7mm78.cloudfront.net/40745985/original_5aca1ecbb74e237ef28935d767f71210.png?1761881049&bc=0",
    "https://d2w9rnfcy7mm78.cloudfront.net/40745984/original_af5265452a5470d4fe75afc90d4ad58b.png?1761881049&bc=0",
    "https://d2w9rnfcy7mm78.cloudfront.net/40745983/original_f339212296815e0f1e1bc31ea02d58aa.png?1761881049&bc=0",
    "https://d2w9rnfcy7mm78.cloudfront.net/40745982/original_d26303661dd70e30ca93cdf01f486460.png?1761881049&bc=0",
    "https://d2w9rnfcy7mm78.cloudfront.net/40745981/original_bb999e4d7e729d5b750aa9107f2afe59.png?1761881049&bc=0",
    "https://d2w9rnfcy7mm78.cloudfront.net/40745980/original_d4885e4a7e28ce7b6200bdcca06066c2.png?1761881049&bc=0",
    "https://d2w9rnfcy7mm78.cloudfront.net/40745979/original_73af61b88cf5587b191cc026065190c5.png?1761881049&bc=0",
    "https://d2w9rnfcy7mm78.cloudfront.net/40745978/original_fe5100aac4e7cf8ec0e36f576bb26e7a.png?1761881049&bc=0",
    "https://d2w9rnfcy7mm78.cloudfront.net/40745977/original_5792f551846a6f3c230cd60ab193a2d0.png?1761881049&bc=0",
    "https://d2w9rnfcy7mm78.cloudfront.net/40745975/original_b713d72b437a1004289079db57c9219e.png?1761881049&bc=0",
    "https://d2w9rnfcy7mm78.cloudfront.net/40745976/original_ec32858a5e4a7e391a994faa781f96b8.png?1761881048&bc=0",
    "https://d2w9rnfcy7mm78.cloudfront.net/40745974/original_3b74abdfaec2e208ac9d9cd013a96edf.png?1761881048&bc=0",
    "https://d2w9rnfcy7mm78.cloudfront.net/40745973/original_7207e2fc863a0cfe2af6689503545510.png?1761881048&bc=0",
    "https://d2w9rnfcy7mm78.cloudfront.net/40745972/original_11b16bc1a913438e9162c007bf99a095.png?1761881048&bc=0",
    "https://d2w9rnfcy7mm78.cloudfront.net/40745971/original_7e65b99cfb02801b165310d48f11f001.png?1761881048&bc=0"
  ];
  const nodes=[];
  const speed=0.08, repel=90, k=2;

  urls.forEach(src=>{
    const img=document.createElement('img');
    img.src=src; img.alt='xpan symbol'; img.className='aei-sym'; img.decoding='async'; img.loading='eager';
    layer.appendChild(img);
    const W=layer.clientWidth||window.innerWidth, H=layer.clientHeight||window.innerHeight, pad=40;
    nodes.push({el:img, x:Math.random()*(W-2*pad)+pad, y:Math.random()*(H-2*pad)+pad, vx:(Math.random()-.5)*speed, vy:(Math.random()-.5)*speed});
  });

  function drawEdges(){
    svg.innerHTML='';
    for(let i=0;i<nodes.length;i++){
      const d=[];
      for(let j=0;j<nodes.length;j++){
        if(i===j) continue;
        const dx=nodes[j].x-nodes[i].x, dy=nodes[j].y-nodes[i].y;
        d.push([j, dx*dx+dy*dy]);
      }
      d.sort((a,b)=>a[1]-b[1]);
      for(let m=0;m<Math.min(k, d.length); m++){
        const j=d[m][0], a=nodes[i], b=nodes[j];
        const ln=document.createElementNS('http://www.w3.org/2000/svg','line');
        ln.setAttribute('x1', a.x + a.el.clientWidth/2);
        ln.setAttribute('y1', a.y + a.el.clientHeight/2);
        ln.setAttribute('x2', b.x + b.el.clientWidth/2);
        ln.setAttribute('y2', b.y + b.el.clientHeight/2);
        ln.setAttribute('stroke','black');
        ln.setAttribute('stroke-width','0.6');
        ln.setAttribute('opacity','.28');
        svg.appendChild(ln);
      }
    }
  }

  let paused=false;
  new IntersectionObserver(([e])=>{ paused=!e.isIntersecting; },{threshold:.05}).observe(wrap);

  function step(){
    if(!paused){
      const W=layer.clientWidth||window.innerWidth, H=layer.clientHeight||window.innerHeight;
      nodes.forEach(n=>{
        let ax=0, ay=0;
        nodes.forEach(m=>{
          if(m===n) return;
          const dx=n.x-m.x, dy=n.y-m.y, d2=dx*dx+dy*dy, d=Math.sqrt(d2)||1;
          if(d<repel){ ax+=dx/d; ay+=dy/d; }
        });
        n.vx+=0.0006*ax; n.vy+=0.0006*ay;
        n.x+=n.vx; n.y+=n.vy;
        if(n.x<0||n.x>W-n.el.clientWidth) n.vx*=-1;
        if(n.y<0||n.y>H-n.el.clientHeight) n.vy*=-1;
        n.el.style.transform=`translate(${n.x}px, ${n.y}px)`;
      });
    }
    requestAnimationFrame(step);
  }
  drawEdges();
  setInterval(drawEdges, 1200);
  step();

  // fade del bloque
  const fadeIO = new IntersectionObserver(([entry])=>{
    const bg=document.getElementById('aeiBg');
    const inner=document.querySelector('.desc-inner');
    if(entry.intersectionRatio<.25){ bg.classList.add('fade-away'); inner.classList.add('fade-away'); }
    else { bg.classList.remove('fade-away'); inner.classList.remove('fade-away'); }
  }, {threshold:[0,.25,.5,.75,1]});
  fadeIO.observe(wrap);

  if(window.matchMedia('(prefers-reduced-motion: reduce)').matches){
    nodes.forEach(n=>{ n.vx=0; n.vy=0; });
  }
}

/* ================== inyección de entradas ================== */
function setupLazyObserver(scope=document){
  if(!('IntersectionObserver'in window)){
    scope.querySelectorAll('img[data-src]').forEach(i=>{i.src=i.dataset.src;});
    scope.querySelectorAll('source[data-src]').forEach(s=>{s.src=s.dataset.src;});
    return;
  }
  const io=new IntersectionObserver((ents,obs)=>{
    for(const e of ents){
      if(!e.isIntersecting) continue;
      const el=e.target;
      if(el.tagName==='IMG'&&el.dataset.src){el.src=el.dataset.src;el.removeAttribute('data-src');}
      if(el.tagName==='SOURCE'&&el.dataset.src){el.src=el.dataset.src;el.removeAttribute('data-src');el.parentElement?.load?.();}
      obs.unobserve(el);
    }
  },{rootMargin:'200px'});
  scope.querySelectorAll('img[data-src],source[data-src]').forEach(el=>io.observe(el));
}

function initCarousels(scope=document){
  const isDesktop=window.innerWidth>768;

  scope.querySelectorAll('.carousel-track').forEach(track=>{
    const kids=[...track.children];
    if(!track.dataset.duped){
      kids.forEach(el=>{
        if(el.tagName==='IMG'||el.classList.contains('carousel-video')||el.tagName==='VIDEO'){
          track.appendChild(el.cloneNode(true));
        }
      });
      track.dataset.duped="1";
    }
  });

  scope.querySelectorAll('.carousel-track').forEach(track=>{
    let scrollX=0; const speed=.3;
    let isDragging=false,startX=0,scrollStart=0; let active=true;

    function animate(){
      if(active&&!isDragging){
        scrollX+=speed; if(scrollX>=track.scrollWidth/2) scrollX=0;
        track.style.transform=`translateX(${(-scrollX)}px)`;
      }
      requestAnimationFrame(animate);
    }
    requestAnimationFrame(animate);

    track.addEventListener('pointerdown',e=>{isDragging=true;startX=e.clientX;scrollStart=scrollX;track.setPointerCapture(e.pointerId);track.style.cursor='grabbing';});
    track.addEventListener('pointermove',e=>{
      if(!isDragging) return;
      const dx=e.clientX-startX; scrollX=scrollStart-dx;
      if(scrollX>=track.scrollWidth/2) scrollX=0; if(scrollX<0) scrollX=track.scrollWidth/2+scrollX;
      track.style.transform=`translateX(${(-scrollX)}px)`;
    });
    ['pointerup','pointerleave'].forEach(ev=>track.addEventListener(ev,()=>{isDragging=false;track.style.cursor='grab';}));

    function highlight(){
      const items=track.querySelectorAll('img,.carousel-video,video');
      const wrap=track.parentElement; const r=wrap.getBoundingClientRect();
      let best=null,min=Infinity;
      items.forEach(it=>{ const d=Math.abs(it.getBoundingClientRect().left-r.left); if(d<min){min=d;best=it;}});
      items.forEach(i=>i.classList.remove('highlight')); if(best) best.classList.add('highlight');
    }
    setInterval(highlight,120);

    const tgt=track.closest('.carousel-wrapper')||track;
    new IntersectionObserver(ents=>{ ents.forEach(en=>{active=en.isIntersecting;}); },{rootMargin:'100px 0px',threshold:.01}).observe(tgt);
  });

  if(!isDesktop){ scope.querySelectorAll('video[autoplay]').forEach(v=>v.removeAttribute('autoplay')); }
}

async function injectEntries({sourceUrl,targetId,excludeSelectors=[]}){
  try{
    const res=await fetch(sourceUrl,{credentials:'same-origin'});
    if(!res.ok) throw new Error(`${sourceUrl} → ${res.status}`);
    const html=await res.text();
    const doc=new DOMParser().parseFromString(html,'text/html');
    let entries=[...doc.querySelectorAll('.entry')];
    if(excludeSelectors.length){
      entries=entries.filter(el=>!excludeSelectors.some(sel=>el.matches(sel)||el.querySelector(sel)));
    }
    const mount=document.getElementById(targetId);
    entries.forEach(n=>{
      n.querySelectorAll('img:not([alt])').forEach(i=>i.alt='xpan project');
      mount.appendChild(document.importNode(n,true));
    });
    setupLazyObserver(mount); initCarousels(mount);
    return entries.length;
  }catch(err){
    console.error('error al inyectar',sourceUrl,err);
    const mount=document.getElementById(targetId);
    const p=document.createElement('p'); p.textContent=`error cargando ${sourceUrl}`; p.style.opacity='0.6'; mount.appendChild(p);
    return 0;
  }
}

/* ================== orden opcional ================== */
function norm(str){
  return (str||'').toLowerCase().normalize('NFD').replace(/\p{Diacritic}/gu,'').replace(/[_—–-]/g,' ').replace(/[^\p{L}\p{N}\s\.]/gu,'').replace(/\s+/g,' ').trim();
}
function entryKey(entry){
  const title=entry.querySelector('strong')?.textContent||'';
  const href=entry.querySelector('a[href]')?.getAttribute('href')||'';
  const slug=href.split('/').pop()?.replace(/\.html$/,'')||'';
  return norm(title)||norm(slug);
}
function reorderManual(containerId, desired){
  const c=document.getElementById(containerId);
  const items=[...c.querySelectorAll('.entry')];
  const keys=items.map(e=>({el:e, key:entryKey(e), title:norm(e.querySelector('strong')?.textContent||''), slug:norm(e.querySelector('a[href]')?.getAttribute('href')||'')}));
  const used=new Set(); const out=document.createDocumentFragment(); const want=desired.map(norm).filter(Boolean);
  want.forEach(token=>{
    const i=keys.findIndex(o=>!used.has(o.el)&&(o.key.includes(token)||o.title.includes(token)||o.slug.includes(token)));
    if(i>=0){ used.add(keys[i].el); out.appendChild(keys[i].el); }
  });
  items.forEach(el=>{ if(!used.has(el)) out.appendChild(el); });
  c.appendChild(out);
}

/* ================== boot ================== */
document.addEventListener('DOMContentLoaded',()=>{
  initHero();
  initAEI();

  Promise.all([
    injectEntries({sourceUrl:'arquitectura.index.html',targetId:'all-entries'}),
    injectEntries({sourceUrl:'mdtc.index.html',targetId:'all-entries'})
  ]).then(()=>{
    const desiredOrder=[
      'arq.xpan.ep.1','arq.xpan.ep.t','arq.xpan.12e',
      'arq.xpan.espacio.gdl','espacio gdl','espacio.gdl',
      'atlas','xpan.atlas',
      'arq.xpan.mdl.1','mdl.1','xpan.mdl.1',
      'arq.xpan.desidia','desidia',
      'arq.xpan.hex_666','hex 666','hex_666',
      'arq.xpan.i8oppa','i8oppa',
      'mdtc.4','mdtc.04','mdtc4',
      'estructuras auxiliares','auxiliares',
      'hipersensoria','torre de los vientos','mdtc.hipersensoria',
      'anahuacalli','sound+ anahuacalli'
    ];
    reorderManual('all-entries', desiredOrder);
  });

  // idioma inicial
  const savedLang=(()=>{ try{ return localStorage.getItem('xpan.lang'); }catch(e){ return null; }})();
  const browserLang=(navigator.language||'es').slice(0,2).toLowerCase();
  const initialLang=['es','en','fr','jp'].includes(savedLang)?savedLang:(['es','en','fr','jp'].includes(browserLang)?browserLang:'es');
  setLang(initialLang);

  // clicks del selector
  document.getElementById('langSelect').addEventListener('click',e=>{
    const btn=e.target.closest('button[data-lang]'); if(!btn) return; setLang(btn.dataset.lang);
  });
});
  </script>
</body>
</html>
