<!DOCTYPE html>

<html lang="es">
<head>
<meta charset="utf-8"/>
<meta content="width=device-width, initial-scale=1.0" name="viewport"/>
<title>xpan — portafolio</title>
<!-- preconnects -->
<link crossorigin="" href="https://attachments.are.na" rel="preconnect"/>
<link crossorigin="" href="https://d2w9rnfcy7mm78.cloudfront.net" rel="preconnect"/>
<style>
    :root { --gap:.5rem; }
    html { scroll-behavior:smooth; }
    body { margin:0; background:#fff; color:#000; font-family:"Times New Roman", serif; overflow-x:hidden; }

    /* header “dummy”: el logo visible es el del hero (fijo y único) */
    header { position:fixed; top:1rem; left:1rem; z-index:40; pointer-events:none; }
    header::after { content:''; display:block; width:50px; height:1px; }

    /* selector de idioma */
    .lang-select{ position:fixed; top:1rem; right:1rem; z-index:40; display:flex; gap:.5rem; }
    .lang-select button{ background:none; border:none; font:inherit; font-size:.9rem; padding:.25rem .5rem; cursor:pointer; opacity:.5; }
    .lang-select button.active{ opacity:1; background:#00000030; color:#fff; }

    /* hero */
    .hero{ position:relative; width:100%; height:100svh; }
    .hero a{ display:block; }

    /* LOGO: SIEMPRE FIXED (UN SOLO ELEMENTO) */
    .hero-logo{
      position:fixed;               /* clave: nunca cambia a relative/sticky */
      top:50%;
      left:50%;
      width:min(55vw,420px);
      height:auto;
      max-width:80vw;
      display:block;
      z-index:50;
      transform-origin:center center;
      will-change:transform;
      /* del centro (-50%,-50%) hacia destino con variables CSS */
      transform:
        translate3d(-50%, -50%, 0)
        translate3d(var(--tx, 0px), var(--ty, 0px), 0)
        scale(var(--s, 1));
      /* sin transition: suavidad la da el easing por JS (scroll) */
    }

    /* descripción + AEI */
    .desc-wrap{ position:relative; padding:6rem 1rem 4rem; display:grid; place-items:center; overflow:clip; }
    .desc-inner{ max-width:820px; border-left:4px solid #000; padding-left:1rem; transition:opacity .5s ease, filter .5s ease; }
    .desc-inner h2{ font-size:1.35rem; margin:0 0 1rem; text-transform:lowercase; }
    .desc-inner p{ font-size:1rem; line-height:1.7; margin:0 0 .9rem; }
    .description{ display:none; }
    .description.active{ display:block; }

    .aei-bg{ position:absolute; inset:0; z-index:-1; pointer-events:none; opacity:.85; transition:opacity .4s ease, filter .4s ease; }
    .aei-bg .layer{ position:absolute; inset:0; }
    .aei-bg svg.lines{ position:absolute; inset:0; width:100%; height:100%; }
    .aei-sym{ position:absolute; width:clamp(56px, 8vw, 120px); filter:grayscale(100%); opacity:.9; will-change:transform; }

    .fade-away{ opacity:0; filter:blur(2px); }

    /* título de sección traducible */
    .section-title{ max-width:800px; padding-left:1rem; margin:0 0 1.25rem; font-weight:bold; text-transform:lowercase; opacity:.6; }

    /* entradas inyectadas */
    .entry{ margin-bottom:3.5rem; max-width:800px; position:relative; padding-left:1rem; content-visibility:auto; contain-intrinsic-size:1px 900px; }
    .entry::before{ content:''; position:absolute; left:0; top:.4rem; width:4px; height:100%; background:#000; opacity:.1; }
    .entry strong{ font-size:1.1rem; font-weight:bold; text-transform:lowercase; display:block; margin-bottom:.25rem; }
    .entry span{ font-size:.85rem; opacity:.5; font-style:italic; display:block; margin-bottom:.25rem; }
    .entry a{ color:#000; text-decoration:underline; font-size:.9rem; }
    .entry a:hover{ background:#000; color:#fff; transition:.2s; }

    .carousel-wrapper{ margin-top:.5rem; overflow:hidden; width:100%; position:relative; }
    .carousel-track{ display:flex; gap:var(--gap); will-change:transform; touch-action:none; cursor:grab; }
    .carousel-track img, .carousel-track video, .carousel-video{
      width:calc((100% - 2*var(--gap))/3); aspect-ratio:4/3; object-fit:cover; border-radius:4px;
      opacity:.3; flex-shrink:0; transition:opacity .5s ease-in-out; display:block; height:auto;
    }
    .carousel-track img.highlight, .carousel-track video.highlight, .carousel-video.highlight{ opacity:1 !important; }
    .carousel-track video{ width:100%; height:100%; object-fit:cover; display:block; }
    @media (max-width:768px){ .carousel-track img, .carousel-track video, .carousel-video{ width:calc((100% - var(--gap))/2); } }
    @media (max-width:480px){ .carousel-track img, .carousel-track video, .carousel-video{ width:100%; } }

    @media (prefers-reduced-motion:reduce){
      .aei-bg{ transition:none; }
    }

    /* asegurar lienzo visible para las líneas */
    #aeiLines{
      position:absolute; inset:0;
      width:100%; height:100%;
      display:block; pointer-events:none;
    }
  </style>
<script defer="" src="/assets/js/video-autoplay-mobile.js"></script>
<script defer="" src="/assets/js/media-proxy.js"></script>
<style id="hero-final-fix-css">
/* === HERO FINAL FIX (owns transform) === */
.hero-logo{
  backface-visibility:hidden;
  will-change:transform;
}
</style></head>
<body>
<header aria-hidden="true"></header>
<!-- selector multilingüe -->
<nav aria-label="idioma" class="lang-select" id="langSelect">
<button class="active" data-lang="es" type="button">es</button>
<button data-lang="en" type="button">en</button>
<button data-lang="fr" type="button">fr</button>
<button data-lang="jp" type="button">jp</button>
</nav>
<!-- hero -->
<section class="hero" id="hero">
<a aria-label="inicio xpan" href="https://xpan.earth" id="homeLink">
<img alt="xpan" class="hero-logo" decoding="async" fetchpriority="high" id="heroLogo" src="xpan.svg"/>
</a>
</section>
<!-- descripción + aei -->
<section class="desc-wrap" id="descWrap">
<div class="aei-bg" id="aeiBg">
<div class="layer" id="aeiLayer"></div>
<svg class="lines" id="aeiLines"></svg>
</div>
<div class="desc-inner">

  <!-- ESPAÑOL -->
  <div class="description active" lang="es">
    <h2>xpan</h2>

    <p><strong>xpan</strong> es un estudio independiente de origen mexicano que diseña y construye <strong>sistemas espaciales, culturales y tecnológicos</strong>. Trabaja en la intersección entre <strong>arquitectura, sonido y tecnología</strong>, desarrollando tanto proyectos culturales como soluciones a la medida para instituciones, empresas y organizaciones.</p>

    <p>Por un lado, xpan opera como una <strong>plataforma cultural</strong>:</p>
    <p>Produce activaciones espaciales, programas públicos, instalaciones sonoras, sistemas de escucha, publicaciones y proyectos de investigación.  
    A la fecha ha realizado <strong>más de sesenta activaciones espaciales</strong> y colaborado con <strong>más de 1,200 artistas, curadores, instituciones y agentes</strong> en ciudades como <strong>Tokio, París, Nueva York y Ciudad de México</strong>.  
    Cada proyecto se documenta y se integra a un archivo en crecimiento que alimenta nuevas investigaciones y formatos.</p>

    <p>Por otro lado, xpan desarrolla <strong>proyectos y servicios especializados</strong> para contextos muy distintos, siempre desde la misma lógica de sistema:</p>

    <ul>
      <li>Diseño y desarrollo de <strong>espacios y arquitecturas experimentales</strong>.</li>
      <li>Diseño de <strong>sistemas espaciales y estructuras modulares</strong>.</li>
      <li><strong>Ingeniería y diseño de sonido</strong> (sistemas de audio, multicanal, experiencias inmersivas).</li>
      <li><strong>Dirección creativa y conceptual</strong>.</li>
      <li><strong>Consultoría</strong> para proyectos culturales, urbanos o corporativos.</li>
      <li>Diseño y desarrollo de <strong>herramientas tecnológicas y digitales</strong> vinculadas a estos sistemas.</li>
    </ul>

    <p><strong>xpan</strong> construye <strong>infraestructuras adaptativas</strong> que operan en múltiples escalas: desde espacios independientes y programas públicos, hasta museos, marcas e instituciones educativas.  
    Estos sistemas articulan lo cultural y lo técnico, lo independiente y lo institucional, y crean un marco común donde artistas, comunidades, equipos internos y audiencias diversas colaboran manteniendo su propia identidad.</p>

    <p>Cada intervención —una estructura modular, una instalación sonora, un sistema de escucha o una plataforma editorial— forma parte de un <strong>ecosistema en evolución continua</strong>.  
    Investigación, archivo y práctica material se retroalimentan, de modo que los proyectos escalan, se replican y se adaptan a nuevos contextos.  
    Para futuros colaboradores, esto abre un sistema probado, flexible y riguroso, capaz de generar experiencias culturales relevantes y de resolver necesidades espaciales, técnicas y comunicativas de forma integral.</p>
  </div>

  <!-- ENGLISH -->
  <div class="description" lang="en">
    <h2>xpan</h2>

    <p><strong>xpan</strong> is an independent Mexican studio that designs and builds <strong>spatial, cultural, and technological systems</strong>. It operates at the intersection of <strong>architecture, sound, and technology</strong>, developing both cultural projects and tailor-made solutions for institutions, companies, and organizations.</p>

    <p>On one hand, xpan functions as a <strong>cultural platform</strong>:</p>
    <p>It produces spatial activations, public programs, sound installations, listening systems, publications, and research projects.  
    To date, it has carried out <strong>over sixty spatial activations</strong> and collaborated with <strong>more than 1,200 artists, curators, institutions, and agents</strong> in cities such as <strong>Tokyo, Paris, New York, and Mexico City</strong>.  
    Each project is documented and integrated into a growing archive that fuels new research and formats.</p>

    <p>On the other hand, xpan develops <strong>specialized projects and services</strong> for diverse contexts, always following the same systemic logic:</p>

    <ul>
      <li>Design and development of <strong>experimental spaces and architectures</strong>.</li>
      <li>Design of <strong>spatial systems and modular structures</strong>.</li>
      <li><strong>Sound design and engineering</strong> (audio systems, multichannel, immersive experiences).</li>
      <li><strong>Creative and conceptual direction</strong>.</li>
      <li><strong>Consulting</strong> for cultural, urban, or corporate projects.</li>
      <li>Design and development of <strong>technological and digital tools</strong> connected to these systems.</li>
    </ul>

    <p><strong>xpan</strong> builds <strong>adaptive infrastructures</strong> that operate on multiple scales: from independent spaces and public programs to museums, brands, and educational institutions.  
    These systems connect the cultural and the technical, the independent and the institutional, creating a shared framework where artists, communities, internal teams, and audiences collaborate while maintaining their own identity.</p>

    <p>Each intervention —a modular structure, a sound installation, a listening system, or an editorial platform— is part of an <strong>evolving ecosystem</strong>.  
    Research, archiving, and material practice feed one another, allowing projects to scale, replicate, and adapt to new contexts.  
    For future collaborators, this opens a proven, flexible, and rigorous system capable of generating relevant cultural experiences and addressing spatial, technical, and communicative needs integrally.</p>
  </div>

  <!-- FRANÇAIS -->
  <div class="description" lang="fr">
    <h2>xpan</h2>

    <p><strong>xpan</strong> est un studio indépendant d’origine mexicaine qui conçoit et construit des <strong>systèmes spatiaux, culturels et technologiques</strong>. Il opère à l’intersection de <strong>l’architecture, du son et de la technologie</strong>, développant à la fois des projets culturels et des solutions sur mesure pour des institutions, des entreprises et des organisations.</p>

    <p>D’une part, xpan agit comme une <strong>plateforme culturelle</strong> :</p>
    <p>Il produit des activations spatiales, des programmes publics, des installations sonores, des systèmes d’écoute, des publications et des projets de recherche.  
    À ce jour, il a réalisé <strong>plus de soixante activations spatiales</strong> et collaboré avec <strong>plus de 1 200 artistes, commissaires, institutions et agents</strong> dans des villes comme <strong>Tokyo, Paris, New York et Mexico</strong>.  
    Chaque projet est documenté et intégré dans une archive en expansion qui alimente de nouvelles recherches et formats.</p>

    <p>D’autre part, xpan développe des <strong>projets et services spécialisés</strong> pour des contextes variés, toujours selon la même logique systémique :</p>

    <ul>
      <li>Conception et développement d’<strong>espaces et architectures expérimentaux</strong>.</li>
      <li>Conception de <strong>systèmes spatiaux et de structures modulaires</strong>.</li>
      <li><strong>Ingénierie et design sonore</strong> (systèmes audio, multicanal, expériences immersives).</li>
      <li><strong>Direction créative et conceptuelle</strong>.</li>
      <li><strong>Conseil</strong> pour des projets culturels, urbains ou institutionnels.</li>
      <li>Conception et développement d’<strong>outils technologiques et numériques</strong> liés à ces systèmes.</li>
    </ul>

    <p><strong>xpan</strong> construit des <strong>infrastructures adaptatives</strong> qui opèrent à plusieurs échelles : des espaces indépendants et programmes publics jusqu’aux musées, marques et institutions éducatives.  
    Ces systèmes articulent le culturel et le technique, l’indépendant et l’institutionnel, créant un cadre commun où artistes, communautés, équipes et publics collaborent tout en préservant leur identité propre.</p>

    <p>Chaque intervention —structure modulaire, installation sonore, système d’écoute ou plateforme éditoriale— fait partie d’un <strong>écosystème en évolution continue</strong>.  
    Recherche, archivage et pratique matérielle se nourrissent mutuellement, permettant aux projets de s’étendre, de se reproduire et de s’adapter à de nouveaux contextes.  
    Pour les futurs collaborateurs, cela ouvre un système éprouvé, flexible et rigoureux, capable de générer des expériences culturelles pertinentes et de répondre de manière intégrée aux besoins spatiaux, techniques et communicationnels.</p>
  </div>

  <!-- 日本語 -->
  <div class="description" lang="jp">
    <h2>xpan</h2>

    <p><strong>xpan</strong> はメキシコを拠点とする独立スタジオであり、<strong>空間・文化・テクノロジーのシステム</strong>を設計・構築しています。<strong>建築・音・テクノロジー</strong>の交差点で活動し、文化プロジェクトから企業・教育機関向けの特注ソリューションまでを展開しています。</p>

    <p>一方で、xpan は <strong>文化的プラットフォーム</strong>として機能します。</p>
    <p>空間アクティベーション、パブリックプログラム、音響インスタレーション、リスニングシステム、出版物、リサーチプロジェクトを制作しています。  
    これまでに<strong>60件を超える空間アクティベーション</strong>を実現し、<strong>1,200名以上のアーティスト、キュレーター、機関、関係者</strong>と東京・パリ・ニューヨーク・メキシコシティで協働してきました。  
    各プロジェクトは記録・アーカイブ化され、新たな研究や形式へと発展します。</p>

    <p>また、xpan は多様な文脈に向けて、常に同じシステム的思考に基づいた <strong>専門的なプロジェクトとサービス</strong>を展開しています。</p>

    <ul>
      <li><strong>実験的な空間や建築</strong>の設計・開発。</li>
      <li><strong>空間システムとモジュラー構造</strong>のデザイン。</li>
      <li><strong>音響設計とエンジニアリング</strong>（オーディオシステム、マルチチャンネル、イマーシブ体験）。</li>
      <li><strong>クリエイティブおよびコンセプトディレクション</strong>。</li>
      <li>文化・都市・企業プロジェクト向けの<strong>コンサルティング</strong>。</li>
      <li>これらのシステムに関連する<strong>テクノロジーおよびデジタルツール</strong>の設計・開発。</li>
    </ul>

    <p><strong>xpan</strong> は、独立スペースやパブリックプログラムから、ミュージアム、ブランド、教育機関まで、<strong>多層的に機能する適応型インフラ</strong>を構築します。  
    これらのシステムは文化と技術、独立性と制度性をつなぎ、アーティスト、コミュニティ、チーム、観客がそれぞれのアイデンティティを保ちながら協働できる共通の枠組みを形成します。</p>

    <p>各プロジェクト — モジュラー構造、音響インスタレーション、リスニングシステム、編集プラットフォーム — は <strong>進化し続けるエコシステム</strong>の一部です。  
    リサーチ、アーカイブ、実践が相互に作用し、プロジェクトは拡張・展開し、新しい文脈に適応します。  
    これにより、柔軟で精緻かつ信頼性の高いシステムが構築され、文化的価値を生み出し、空間的・技術的・コミュニケーション的課題を統合的に解決します。</p>
  </div>

</div>




</section>
<!-- título traducible y contenedor de proyectos -->
<h3 class="section-title" id="portfolio-title">proyectos destacados</h3>
<div id="all-entries"></div>
<script>
/* ================== i18n ================== */
const I18N = {
  es: { featured:'proyectos destacados' },
  en: { featured:'featured projects' },
  fr: { featured:'projets sélectionnés' },
  jp: { featured:'主要プロジェクト' }
};
function setLang(lang){
  document.querySelectorAll('.lang-select button').forEach(b=>{
    b.classList.toggle('active', b.dataset.lang===lang);
  });
  document.querySelectorAll('.description').forEach(d=>d.classList.remove('active'));
  document.querySelectorAll('.description[lang="'+lang+'"]').forEach(d=>d.classList.add('active'));
  const t=document.getElementById('portfolio-title'); if(t && I18N[lang]) t.textContent=I18N[lang].featured;
  try{ localStorage.setItem('xpan.lang',lang); }catch(e){}
}

/* ================== HERO — logo fijo que interpola (sin desaparecer) ================== */
function initHero(){
  const logo = document.getElementById('heroLogo');
  const hero = document.getElementById('hero');
  if(!logo || !hero) return;

  const TARGET_SIZE = 50;               // tamaño final (px)
  const TARGET = { x:16, y:16 };        // esquina (1rem,1rem)

  let base = null; // { w0, dxTot, dyTot, heroH }

  function computeBase(){
    // tamaño inicial real del logo (en centro)
    const r = logo.getBoundingClientRect();
    const w0 = r.width;                             // ancho inicial (para la escala)
    const heroH = hero.offsetHeight || window.innerHeight || 0;

    // centros
    const fromCx = window.innerWidth / 2;
    const fromCy = window.innerHeight / 2;
    const toCx   = TARGET.x + TARGET_SIZE/2;
    const toCy   = TARGET.y + TARGET_SIZE/2;

    // delta total del viaje (centro a centro)
    const dxTot = toCx - fromCx;
    const dyTot = toCy - fromCy;

    base = { w0, dxTot, dyTot, heroH };
    sync(); // primera posición
  }

  function easeOutCubic(t){ return 1 - Math.pow(1 - t, 3); }

  function sync(){
    if(!base) return;
    const { w0, dxTot, dyTot, heroH } = base;

    // progreso ligado al 92% del alto del hero (margen para no “cortar” el final)
    const raw = window.scrollY / (heroH * 0.92);
    const t = Math.max(0, Math.min(1, raw));
    const e = easeOutCubic(t);

    // posición y escala
    const tx = dxTot * e;
    const ty = dyTot * e;
    const s  = 1 + ((TARGET_SIZE / Math.max(1,w0)) - 1) * e;

    // volcamos a variables CSS (un mismo elemento, sin clases ni jumps)
    logo.style.setProperty('--tx', tx + 'px');
    logo.style.setProperty('--ty', ty + 'px');
    logo.style.setProperty('--s',  s);
  }

  // listeners optimizados
  let ticking=false;
  function onScroll(){ if(!ticking){ ticking=true; requestAnimationFrame(()=>{ sync(); ticking=false; }); } }
  function onResize(){ computeBase(); }

  window.addEventListener('scroll', onScroll, {passive:true});
  window.addEventListener('resize', onResize, {passive:true});

  // baseline inicial tras un frame (layout estable)
  requestAnimationFrame(computeBase);
}

/* ================== AEI ================== */
function initAEI(){
  const layer = document.getElementById('aeiLayer');
  const svg   = document.getElementById('aeiLines');
  const wrap  = document.getElementById('descWrap');
  if(!layer || !svg || !wrap) return;

  const urls = [
    "https://d2w9rnfcy7mm78.cloudfront.net/40745994/original_77a7afa258aa463a8c945e0b55b0ead8.png?1761881049&bc=0",
    "https://d2w9rnfcy7mm78.cloudfront.net/40745991/original_98ebeabf5a4b3e7622c7f357502e2217.png?1761881049&bc=0",
    "https://d2w9rnfcy7mm78.cloudfront.net/40745993/original_6d0449268d243af2fe98b069ef0df687.png?1761881049&bc=0",
    "https://d2w9rnfcy7mm78.cloudfront.net/40745995/original_d77cd22950a8a1e2ddd6e6e6283e1dc8.png?1761881049&bc=0",
    "https://d2w9rnfcy7mm78.cloudfront.net/40745992/original_1fc9933b2f8ce7925a5aae9c88b34813.png?1761881049&bc=0",
    "https://d2w9rnfcy7mm78.cloudfront.net/40745990/original_ca4f1fd040fe036fd3768bddd9487fd7.png?1761881049&bc=0",
    "https://d2w9rnfcy7mm78.cloudfront.net/40745988/original_2978ffd117332e5c884c826f681d6285.png?1761881049&bc=0",
    "https://d2w9rnfcy7mm78.cloudfront.net/40745989/original_f6ed552681cba118f73eb07cf24cbabc.png?1761881049&bc=0",
    "https://d2w9rnfcy7mm78.cloudfront.net/40745986/original_996fe49af0bdd77d341f9ed4891ea560.png?1761881049&bc=0",
    "https://d2w9rnfcy7mm78.cloudfront.net/40745987/original_a6019cb169d907ed522ab3aeb54b3742.png?1761881049&bc=0",
    "https://d2w9rnfcy7mm78.cloudfront.net/40745985/original_5aca1ecbb74e237ef28935d767f71210.png?1761881049&bc=0",
    "https://d2w9rnfcy7mm78.cloudfront.net/40745984/original_af5265452a5470d4fe75afc90d4ad58b.png?1761881049&bc=0",
    "https://d2w9rnfcy7mm78.cloudfront.net/40745983/original_f339212296815e0f1e1bc31ea02d58aa.png?1761881049&bc=0",
    "https://d2w9rnfcy7mm78.cloudfront.net/40745982/original_d26303661dd70e30ca93cdf01f486460.png?1761881049&bc=0",
    "https://d2w9rnfcy7mm78.cloudfront.net/40745981/original_bb999e4d7e729d5b750aa9107f2afe59.png?1761881049&bc=0",
    "https://d2w9rnfcy7mm78.cloudfront.net/40745980/original_d4885e4a7e28ce7b6200bdcca06066c2.png?1761881049&bc=0",
    "https://d2w9rnfcy7mm78.cloudfront.net/40745979/original_73af61b88cf5587b191cc026065190c5.png?1761881049&bc=0",
    "https://d2w9rnfcy7mm78.cloudfront.net/40745978/original_fe5100aac4e7cf8ec0e36f576bb26e7a.png?1761881049&bc=0",
    "https://d2w9rnfcy7mm78.cloudfront.net/40745977/original_5792f551846a6f3c230cd60ab193a2d0.png?1761881049&bc=0",
    "https://d2w9rnfcy7mm78.cloudfront.net/40745975/original_b713d72b437a1004289079db57c9219e.png?1761881049&bc=0",
    "https://d2w9rnfcy7mm78.cloudfront.net/40745976/original_ec32858a5e4a7e391a994faa781f96b8.png?1761881048&bc=0",
    "https://d2w9rnfcy7mm78.cloudfront.net/40745974/original_3b74abdfaec2e208ac9d9cd013a96edf.png?1761881048&bc=0",
    "https://d2w9rnfcy7mm78.cloudfront.net/40745973/original_7207e2fc863a0cfe2af6689503545510.png?1761881048&bc=0",
    "https://d2w9rnfcy7mm78.cloudfront.net/40745972/original_11b16bc1a913438e9162c007bf99a095.png?1761881048&bc=0",
    "https://d2w9rnfcy7mm78.cloudfront.net/40745971/original_7e65b99cfb02801b165310d48f11f001.png?1761881048&bc=0"
  ];

  const nodes=[]; const speed=0.08, repel=90, k=2;

  urls.forEach(src=>{
    const img=document.createElement('img');
    img.src=src; img.alt='xpan symbol'; img.className='aei-sym'; img.decoding='async'; img.loading='eager';
    layer.appendChild(img);
    const W=layer.clientWidth||window.innerWidth, H=layer.clientHeight||window.innerHeight, pad=40;
    nodes.push({el:img, x:Math.random()*(W-2*pad)+pad, y:Math.random()*(H-2*pad)+pad, vx:(Math.random()-.5)*speed, vy:(Math.random()-.5)*speed});
  });

  /* === asegurar que el SVG tenga tamaño real (atributos + viewBox) === */
  function sizeSvg(){
    const r = svg.getBoundingClientRect();
    const w = Math.max(1, Math.round(r.width));
    const h = Math.max(1, Math.round(r.height));
    svg.setAttribute('width',  w);
    svg.setAttribute('height', h);
    svg.setAttribute('viewBox', `0 0 ${w} ${h}`);
  }
  sizeSvg();
  window.addEventListener('resize', sizeSvg, {passive:true});

  function drawEdges(){
    svg.innerHTML='';
    for(let i=0;i<nodes.length;i++){
      const d=[];
      for(let j=0;j<nodes.length;j++){
        if(i===j) continue;
        const dx=nodes[j].x-nodes[i].x, dy=nodes[j].y-nodes[i].y;
        d.push([j, dx*dx+dy*dy]);
      }
      d.sort((a,b)=>a[1]-b[1]);
      for(let m=0;m<Math.min(k, d.length); m++){
        const j=d[m][0], a=nodes[i], b=nodes[j];
        const ln=document.createElementNS('http://www.w3.org/2000/svg','line');
        ln.setAttribute('x1', a.x + a.el.clientWidth/2);
        ln.setAttribute('y1', a.y + a.el.clientHeight/2);
        ln.setAttribute('x2', b.x + b.el.clientWidth/2);
        ln.setAttribute('y2', b.y + b.el.clientHeight/2);
        ln.setAttribute('stroke','black');
        ln.setAttribute('stroke-width','0.6');
        ln.setAttribute('opacity','.28');
        svg.appendChild(ln);
      }
    }
  }

  let paused=false;
  new IntersectionObserver(([e])=>{ paused=!e.isIntersecting; },{threshold:.05}).observe(wrap);

  function step(){
    if(!paused){
      const W=layer.clientWidth||window.innerWidth, H=layer.clientHeight||window.innerHeight;
      nodes.forEach(n=>{
        let ax=0, ay=0;
        nodes.forEach(m=>{
          if(m===n) return;
          const dx=n.x-m.x, dy=n.y-m.y, d2=dx*dx+dy*dy, d=Math.sqrt(d2)||1;
          if(d<repel){ ax+=dx/d; ay+=dy/d; }
        });
        n.vx+=0.0006*ax; n.vy+=0.0006*ay;
        n.x+=n.vx; n.y+=n.vy;
        if(n.x<0||n.x>W-n.el.clientWidth) n.vx*=-1;
        if(n.y<0||n.y>H-n.el.clientHeight) n.vy*=-1;
        n.el.style.transform='translate('+n.x+'px,'+n.y+'px)';
      });

      /* líneas actualizadas en este mismo frame (SIN setInterval) */
      drawEdges();
    }
    requestAnimationFrame(step);
  }

  /* primera pintura y arranque */
  drawEdges();
  /* ELIMINADO: setInterval(drawEdges, 1200);  → se recalcula cada frame */
  step();

  // fade del bloque
  const fadeIO = new IntersectionObserver(([entry])=>{
    const bg=document.getElementById('aeiBg');
    const inner=document.querySelector('.desc-inner');
    if(entry.intersectionRatio<.25){ bg.classList.add('fade-away'); inner.classList.add('fade-away'); }
    else { bg.classList.remove('fade-away'); inner.classList.remove('fade-away'); }
  }, {threshold:[0,.25,.5,.75,1]});
  fadeIO.observe(wrap);

  if(window.matchMedia('(prefers-reduced-motion: reduce)').matches){
    nodes.forEach(n=>{ n.vx=0; n.vy=0; });
  }
}

/* ================== lazy + carruseles ================== */
function setupLazyObserver(scope=document){
  if(!('IntersectionObserver'in window)){
    scope.querySelectorAll('img[data-src]').forEach(i=>{i.src=i.dataset.src;});
    scope.querySelectorAll('source[data-src]').forEach(s=>{s.src=s.dataset.src;});
    return;
  }
  const io=new IntersectionObserver((ents,obs)=>{
    for(const e of ents){
      if(!e.isIntersecting) continue;
      const el=e.target;
      if(el.tagName==='IMG'&&el.dataset.src){el.src=el.dataset.src;el.removeAttribute('data-src');}
      if(el.tagName==='SOURCE'&&el.dataset.src){el.src=el.dataset.src;el.removeAttribute('data-src');el.parentElement?.load?.();}
      obs.unobserve(el);
    }
  },{rootMargin:'200px'});
  scope.querySelectorAll('img[data-src],source[data-src]').forEach(el=>io.observe(el));
}

function initCarousels(scope=document){
  const isDesktop=window.innerWidth>768;

  scope.querySelectorAll('.carousel-track').forEach(track=>{
    const kids=[...track.children];
    if(!track.dataset.duped){
      kids.forEach(el=>{
        if(el.tagName==='IMG'||el.classList.contains('carousel-video')||el.tagName==='VIDEO'){
          track.appendChild(el.cloneNode(true));
        }
      });
      track.dataset.duped="1";
    }
  });

  scope.querySelectorAll('.carousel-track').forEach(track=>{
    let scrollX=0; const speed=.3;
    let isDragging=false,startX=0,scrollStart=0; let active=true;

    function animate(){
      if(active&&!isDragging){
        scrollX+=speed; if(scrollX>=track.scrollWidth/2) scrollX=0;
        track.style.transform='translateX('+(-scrollX)+'px)';
      }
      requestAnimationFrame(animate);
    }
    requestAnimationFrame(animate);

    track.addEventListener('pointerdown',e=>{isDragging=true;startX=e.clientX;scrollStart=scrollX;track.setPointerCapture(e.pointerId);track.style.cursor='grabbing';});
    track.addEventListener('pointermove',e=>{
      if(!isDragging) return;
      const dx=e.clientX-startX; scrollX=scrollStart-dx;
      if(scrollX>=track.scrollWidth/2) scrollX=0; if(scrollX<0) scrollX=track.scrollWidth/2+scrollX;
      track.style.transform='translateX('+(-scrollX)+'px)';
    });
    ['pointerup','pointerleave'].forEach(ev=>track.addEventListener(ev,()=>{isDragging=false;track.style.cursor='grab';}));

    function highlight(){
      const items=track.querySelectorAll('img,.carousel-video,video');
      const wrap=track.parentElement; const r=wrap.getBoundingClientRect();
      let best=null,min=Infinity;
      items.forEach(it=>{ const d=Math.abs(it.getBoundingClientRect().left-r.left); if(d<min){min=d;best=it;}});
      items.forEach(i=>i.classList.remove('highlight')); if(best) best.classList.add('highlight');
    }
    setInterval(highlight,120);

    const tgt=track.closest('.carousel-wrapper')||track;
    new IntersectionObserver(ents=>{ ents.forEach(en=>{active=en.isIntersecting;}); },{rootMargin:'100px 0px',threshold:.01}).observe(tgt);
  });

  if(!isDesktop){ scope.querySelectorAll('video[autoplay]').forEach(v=>v.removeAttribute('autoplay')); }
}

/* ================== inyección de entries ================== */
async function injectEntries({sourceUrl,targetId,excludeSelectors=[]}){
  try{
    const res=await fetch(sourceUrl,{credentials:'same-origin'});
    if(!res.ok) throw new Error(sourceUrl+' → '+res.status);
    const html=await res.text();
    const doc=new DOMParser().parseFromString(html,'text/html');
    let entries=[...doc.querySelectorAll('.entry')];
    if(excludeSelectors.length){
      entries=entries.filter(el=>!excludeSelectors.some(sel=>el.matches(sel)||el.querySelector(sel)));
    }
    const mount=document.getElementById(targetId);
    entries.forEach(n=>{
      n.querySelectorAll('img:not([alt])').forEach(i=>i.alt='xpan project');
      mount.appendChild(document.importNode(n,true));
    });
    setupLazyObserver(mount); initCarousels(mount);
    return entries.length;
  }catch(err){
    console.error('error al inyectar',sourceUrl,err);
    const mount=document.getElementById(targetId);
    const p=document.createElement('p'); p.textContent='error cargando '+sourceUrl; p.style.opacity='0.6'; mount.appendChild(p);
    return 0;
  }
}

/* ================== orden opcional ================== */
function norm(str){
  return (str||'').toLowerCase().normalize('NFD').replace(/\p{Diacritic}/gu,'').replace(/[_—–-]/g,' ').replace(/[^\p{L}\p{N}\s\.]/gu,'').replace(/\s+/g,' ').trim();
}
function entryKey(entry){
  const title=entry.querySelector('strong')?.textContent||'';
  const href=entry.querySelector('a[href]')?.getAttribute('href')||'';
  const slug=href.split('/').pop()?.replace(/\.html$/,'')||'';
  return norm(title)||norm(slug);
}
function reorderManual(containerId, desired){
  const c=document.getElementById(containerId);
  const items=[...c.querySelectorAll('.entry')];
  const keys=items.map(e=>({el:e, key:entryKey(e), title:norm(e.querySelector('strong')?.textContent||''), slug:norm(e.querySelector('a[href]')?.getAttribute('href')||'')}));
  const used=new Set(); const out=document.createDocumentFragment(); const want=desired.map(norm).filter(Boolean);
  want.forEach(token=>{
    const i=keys.findIndex(o=>!used.has(o.el)&&(o.key.includes(token)||o.title.includes(token)||o.slug.includes(token)));
    if(i>=0){ used.add(keys[i].el); out.appendChild(keys[i].el); }
  });
  items.forEach(el=>{ if(!used.has(el)) out.appendChild(el); });
  c.appendChild(out);
}

/* ================== boot ================== */
document.addEventListener('DOMContentLoaded',()=>{
  initHero();
  initAEI();

  Promise.all([
    injectEntries({sourceUrl:'arquitectura.index.html',targetId:'all-entries'}),
    injectEntries({sourceUrl:'mdtc.index.html',targetId:'all-entries'})
  ]).then(()=>{
    const desiredOrder=[
      'arq.xpan.ep.1','arq.xpan.ep.t','arq.xpan.12e',
      'arq.xpan.espacio.gdl','espacio gdl','espacio.gdl',
      'atlas','xpan.atlas',
      'arq.xpan.mdl.1','mdl.1','xpan.mdl.1',
      'arq.xpan.desidia','desidia',
      'arq.xpan.hex_666','hex 666','hex_666',
      'arq.xpan.i8oppa','i8oppa',
      'mdtc.4','mdtc.04','mdtc4',
      'estructuras auxiliares','auxiliares',
      'hipersensoria','torre de los vientos','mdtc.hipersensoria',
      'anahuacalli','sound+ anahuacalli'
    ];
    reorderManual('all-entries', desiredOrder);
  });

  // idioma inicial
  const savedLang=(()=>{ try{ return localStorage.getItem('xpan.lang'); }catch(e){ return null; }})();
  const browserLang=(navigator.language||'es').slice(0,2).toLowerCase();
  const initialLang=['es','en','fr','jp'].includes(savedLang)?savedLang:(['es','en','fr','jp'].includes(browserLang)?browserLang:'es');
  setLang(initialLang);

  // clicks del selector
  document.getElementById('langSelect').addEventListener('click',e=>{
    const btn=e.target.closest('button[data-lang]'); if(!btn) return; setLang(btn.dataset.lang);
  });
});
  </script>
<script id="hero-final-fix-js">
(function(){
  var hero = document.querySelector('.hero');
  var logo = document.querySelector('.hero-logo');
  if(!hero || !logo) return;

  // Kill any inline style variables that other scripts might be writing
  logo.style.removeProperty('--tx');
  logo.style.removeProperty('--ty');
  logo.style.removeProperty('--s');

  var PAD = 16;
  var FINAL_W_DESKTOP = 64, FINAL_W_MOBILE = 56;
  var DESKTOP_BREAK = 768;
  var baseWidth = null; // measured once to avoid feedback loops

  function easeOutCubic(t){ return 1 - Math.pow(1 - t, 3); }

  function getHeaderRect(){
    var el = document.querySelector('[data-hero-target]') ||
             document.querySelector('header img[src*="xpan.svg"]') ||
             document.querySelector('header .site-logo img') ||
             document.querySelector('header a[href="/"] img') ||
             null;
    if(!el) return null;
    var r = el.getBoundingClientRect();
    if(!r.width || !r.height) return null;
    return r;
  }

  function compute(){
    // establish baseWidth once (CSS width before any scaling), using computedStyle
    if(baseWidth == null){
      var cs = getComputedStyle(logo);
      var parsed = parseFloat(cs.width);
      baseWidth = (parsed && isFinite(parsed)) ? parsed : (logo.naturalWidth || 200);
    }

    var isMobile = innerWidth < DESKTOP_BREAK;
    var heroH = Math.max(1, hero.offsetHeight || innerHeight);

    var headerR = getHeaderRect();
    var finalW = headerR ? Math.max(28, Math.min(160, headerR.width)) : (isMobile ? FINAL_W_MOBILE : FINAL_W_DESKTOP);

    // from: center of viewport
    var fromCx = innerWidth / 2;
    var fromCy = innerHeight / 2;

    // to: header logo center (or fallback corner)
    var toCx = headerR ? (headerR.left + headerR.width/2) : (PAD + finalW/2);
    var toCy = headerR ? (headerR.top  + headerR.height/2) : (PAD + finalW/2);

    var dx = toCx - fromCx;
    var dy = toCy - fromCy;

    var t = Math.max(0, Math.min(1, scrollY / (heroH * 0.92)));
    var e = easeOutCubic(t);

    var s = 1 + ((finalW / baseWidth) - 1) * e;
    var tx = dx * e;
    var ty = dy * e;

    // Write transform directly; this owns the visual state.
    logo.style.transform = 'translate3d(-50%,-50%,0) translate3d('+tx+'px,'+ty+'px,0) scale('+s+')';
    logo.style.position = 'fixed';
    logo.style.top = '50%';
    logo.style.left = '50%';
    logo.style.margin = '0';
    logo.style.zIndex = '60';
  }

  var ticking = false;
  addEventListener('scroll', function(){ if(!ticking){ ticking = true; requestAnimationFrame(function(){ compute(); ticking=false; }); } }, {passive:true});
  addEventListener('resize', function(){ requestAnimationFrame(function(){ baseWidth=null; compute(); }); }, {passive:true});
  addEventListener('orientationchange', function(){ requestAnimationFrame(function(){ baseWidth=null; compute(); }); }, {passive:true});

  var mo = new MutationObserver(function(){ requestAnimationFrame(function(){ compute(); }); });
  mo.observe(document.documentElement, { childList:true, subtree:true });

  // First frame
  requestAnimationFrame(compute);
})();
</script></body>
</html>
