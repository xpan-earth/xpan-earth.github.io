<!DOCTYPE html>
<html lang="es" data-xpan>
<head>
<meta charset="utf-8"/>
<meta name="viewport" content="width=device-width, initial-scale=1.0"/>
<meta name="color-scheme" content="light dark"/>
<title>xpan — portafolio</title>

<!-- preconnects preservados -->
<link rel="preconnect" href="https://attachments.are.na" crossorigin>
<link rel="preconnect" href="https://d2w9rnfcy7mm78.cloudfront.net" crossorigin>

<style>
  /* ===== tokens post-tech ===== */
  :root{
    --bg:#000; --fg:#E0E3E6; --fg-dim:#AEB4BA; --accent:#1860FF;
    --line:#2A2E31; --line-weak:#1A1D20; --b1:1px solid var(--line);
    --font-ui:-apple-system,BlinkMacSystemFont,"Inter","Segoe UI",Roboto,Helvetica,Arial,sans-serif;
    --font-mono:"IBM Plex Mono","SFMono-Regular",Menlo,Consolas,Monaco,monospace;
    --maxw:1160px; --pad-x:clamp(16px,4vw,48px); --header-h:64px;
    --gap:.5rem;
  }
  @media (prefers-color-scheme:light){
    :root{ --bg:#fff; --fg:#0E1113; --fg-dim:#4A5158; --accent:#1860FF; --line:#D9DEE2; --line-weak:#ECEFF2; }
  }

  /* ===== base ===== */
  *,*::before,*::after{box-sizing:border-box}
  html{scroll-behavior:smooth}
  html,body{margin:0;background:var(--bg);color:var(--fg);font-family:var(--font-ui)}
  img,video{display:block;max-width:100%;height:auto;background:transparent}
  a{color:var(--accent);text-decoration:none;border-bottom:1px solid transparent;transition:border-color .15s linear}
  a:hover{border-bottom-color:var(--accent)}

  /* ===== header “dummy” preservado (hero posee el logo visible) ===== */
  header{position:fixed;top:12px;left:var(--pad-x);z-index:40;pointer-events:none}
  header::after{content:"";display:block;width:50px;height:1px}

  /* ===== selector idioma ===== */
  .lang-select{position:fixed;top:12px;right:var(--pad-x);z-index:120;display:flex;gap:8px;text-transform:lowercase}
  .lang-select button{appearance:none;background:transparent;border:var(--b1);border-radius:0;padding:.35rem .6rem;cursor:pointer;font:600 .9rem/1 var(--font-ui);color:var(--fg-dim)}
  .lang-select button.active{color:var(--fg);border-color:var(--accent);background:rgba(24,96,255,.06)}

  /* ===== hero ===== */
  .hero{position:relative;width:100%;height:100svh}
  .hero a{display:block}
  .hero-logo{
    position:fixed;top:50%;left:50%;z-index:60;margin:0;
    width:min(55vw,420px);height:auto;max-width:80vw;
    transform:translate3d(-50%,-50%,0) translate3d(var(--tx,0px),var(--ty,0px),0) scale(var(--s,1));
    transform-origin:center center;backface-visibility:hidden;will-change:transform;mix-blend-mode:difference;filter:invert(1) saturate(100%)
  }
  /* fix: logo negro en esquema claro */
@media (prefers-color-scheme: light){
  .hero-logo{
    mix-blend-mode: normal; /* evita invertir sobre fondo blanco */
    filter: none;           /* usa el SVG tal cual (negro) */
  }
}

  @media (prefers-color-scheme:light){ .hero-logo{filter:none} }

  /* ===== descripción + AEI ===== */
  .desc-wrap{position:relative;padding:6rem var(--pad-x) 4rem;display:grid;place-items:center;overflow:clip}
  .desc-inner{max-width:820px;border-left:var(--b1);padding-left:1rem;transition:opacity .4s linear,filter .4s linear}
  .desc-inner h2{font:700 1.35rem/1.25 var(--font-ui);text-transform:lowercase;margin:0 0 1rem}
  .desc-inner p{font:400 1rem/1.7 var(--font-ui);margin:.9rem 0}
  .description{display:none}
  .description.active{display:block}

  .aei-bg{position:absolute;inset:0;z-index:-1;pointer-events:none;opacity:.9;transition:opacity .4s linear,filter .4s linear}
  .aei-bg .layer{position:absolute;inset:0}
  .aei-bg svg.lines{position:absolute;inset:0;width:100%;height:100%}
  .aei-sym{position:absolute;width:clamp(56px,8vw,120px);filter:grayscale(100%);opacity:.9;will-change:transform}
  .fade-away{opacity:0;filter:blur(2px)}
  #aeiLines{position:absolute;inset:0;width:100%;height:100%;display:block;pointer-events:none}

  /* ===== título de sección ===== */
  .section-title{max-width:800px;padding-left:1rem;margin:0 var(--pad-x) 1.25rem;font:700 1rem/1.2 var(--font-ui);text-transform:lowercase;color:var(--fg-dim)}

  /* ===== entries inyectadas ===== */
  #all-entries{max-width:1160px;margin:0 auto 64px;padding:0 var(--pad-x)}
  .entry{margin-bottom:3.5rem;max-width:800px;position:relative;padding-left:1rem;border-left:var(--b1);content-visibility:auto;contain-intrinsic-size:1px 900px}
  .entry strong{font:700 1.1rem/1.25 var(--font-ui);text-transform:lowercase;display:block;margin-bottom:.25rem}
  .entry span{font:400 .85rem/1.5 var(--font-ui);color:var(--fg-dim);font-style:italic;display:block;margin-bottom:.25rem}
  .entry a{font:600 .9rem/1 var(--font-ui)}

  /* ===== carruseles ===== */
  .carousel-wrapper{margin-top:.5rem;overflow:hidden;width:100%;position:relative;border:var(--b1)}
  .carousel-track{display:flex;gap:var(--gap);will-change:transform;touch-action:none;cursor:grab;padding:var(--gap)}
  .carousel-track img,.carousel-track video,.carousel-video{
    width:calc((100% - 2*var(--gap))/3);aspect-ratio:4/3;object-fit:cover;border:var(--b1);
    opacity:.5;flex-shrink:0;transition:opacity .35s linear;display:block;height:auto
  }
  .carousel-video{overflow:hidden}
  .carousel-video video{width:100%;height:100%;object-fit:cover;background:transparent}
  .carousel-track img.highlight,.carousel-track video.highlight,.carousel-video.highlight{opacity:1}

  @media (max-width:768px){
    .desc-wrap{padding:4.5rem var(--pad-x) 3rem}
    .carousel-track img,.carousel-track video,.carousel-video{width:calc((100% - var(--gap))/2)}
  }
  @media (max-width:480px){
    .carousel-track img,.carousel-track video,.carousel-video{width:100%}
  }

  /* ===== lightbox ===== */
  #xpan-lightbox{position:fixed;inset:0;z-index:9999;display:none;align-items:center;justify-content:center;background:rgba(0,0,0,.55);backdrop-filter:blur(10px) saturate(120%);-webkit-backdrop-filter:blur(10px) saturate(120%);touch-action:none;overscroll-behavior:contain}
  #xpan-lightbox.open{display:flex}
  #xpan-lightbox .sheet{max-width:92vw;max-height:92vh;margin:0;transform:scale(.985);opacity:0;transition:transform .18s linear,opacity .18s linear}
  #xpan-lightbox.open .sheet{transform:scale(1);opacity:1}
  #xpan-lightbox img,#xpan-lightbox video{max-width:92vw;max-height:92vh;object-fit:contain;display:block;background:transparent}
  html.lb-open,body.lb-open{overflow:hidden;touch-action:none}
  @media (prefers-color-scheme:light){#xpan-lightbox{background:rgba(255,255,255,.55)}}

  /* ===== perf hints (preservados) ===== */
  .intro-block,.entry{content-visibility:auto;contain-intrinsic-size:1px 900px}
  .carousel-track img,.carousel-video{height:auto}
</style>

<!-- utils preservados -->
<script src="/assets/js/video-autoplay-mobile.js" defer></script>
<script src="/assets/js/media-proxy.js" defer></script>
</head>

<body>
<header aria-hidden="true"></header>

<!-- selector multilingüe -->
<nav class="lang-select" id="langSelect" aria-label="idioma">
  <button class="active" data-lang="es" type="button" aria-pressed="true">es</button>
  <button data-lang="en" type="button" aria-pressed="false">en</button>
  <button data-lang="fr" type="button" aria-pressed="false">fr</button>
  <button data-lang="jp" type="button" aria-pressed="false">jp</button>
</nav>

<!-- hero -->
<section class="hero" id="hero">
  <a id="homeLink" href="https://xpan.earth" aria-label="inicio xpan">
    <img id="heroLogo" class="hero-logo" src="xpan.svg" alt="xpan" decoding="async" fetchpriority="high"/>
  </a>
</section>

<!-- descripción + AEI -->
<section class="desc-wrap" id="descWrap">
  <div class="aei-bg" id="aeiBg">
    <div class="layer" id="aeiLayer"></div>
    <svg class="lines" id="aeiLines"></svg>
  </div>

<div class="desc-inner intro-block">

  <!-- ES -->
  <div class="description active" lang="es">
    <h2>xpan</h2>
    <p><strong>xpan</strong> desarrolla sistemas espaciales y conceptuales a partir de diseño, investigación y composición de estructuras adaptativas. su práctica combina conceptualización y construcción material, generando un ecosistema donde arquitecturas, dispositivos, objetos, publicaciones y herramientas operan como un mismo conjunto estructural, consolidando a xpan como una infraestructura cultural autónoma y contemporánea.</p>

    <p>el proyecto desarrolla sistemas propios que se activan en contextos reales, junto con soluciones especializadas para instituciones, empresas y organizaciones. ha producido activaciones culturales, programas públicos, instalaciones sonoras, intervenciones espaciales, publicaciones y proyectos de investigación.</p>

    <p>a la fecha, xpan ha realizado más de sesenta activaciones y colaborado con más de 1,200 agentes, artistas, curadores e instituciones en ciudades como tokio, parís, nueva york y ciudad de méxico.</p>

    <p>xpan despliega procesos experimentales y operaciones en distintas geografías, desarrollando soluciones y servicios capaces de operar en múltiples niveles, siempre bajo la misma lógica de sistema:</p>
    <ul>
      <li>diseño y desarrollo de espacios y arquitecturas experimentales.</li>
      <li>diseño de sistemas espaciales y estructuras modulares.</li>
      <li>dirección creativa y conceptual.</li>
      <li>consultoría para proyectos culturales, conceptuales, urbanos o corporativos.</li>
      <li>desarrollo de herramientas tecnológicas y metodológicas vinculadas a estos sistemas.</li>
    </ul>

    <p>cada proyecto se aborda desde una lectura crítica del contexto, resolviendo necesidades complejas mediante infraestructuras adaptativas que se insertan en el sistema operativo de xpan.</p>

    <p>los proyectos escalan y se reconfiguran en nuevos territorios a partir de sistemas precisos y adaptativos, ofreciendo a colaboradores e instituciones una base flexible y probada capaz de resolver necesidades espaciales, técnicas y conceptuales de forma integral.</p>
  </div>

  <!-- EN -->
  <div class="description" lang="en">
    <h2>xpan</h2>
    <p><strong>xpan</strong> develops spatial and conceptual systems through design, research, and the composition of adaptive structures. its practice combines conceptualization and material construction, generating an ecosystem where architectures, devices, objects, publications, and tools operate as components of a single structural framework, consolidating xpan as an autonomous and contemporary cultural infrastructure.</p>

    <p>the project develops its own systems that activate in real contexts, alongside specialized solutions for institutions, companies, and organizations. it has produced cultural activations, public programs, sound installations, spatial interventions, publications, and research projects.</p>

    <p>to date, xpan has carried out more than sixty activations and collaborated with over 1,200 agents, artists, curators, and institutions in cities such as tokyo, paris, new york, and mexico city.</p>

    <p>xpan deploys experimental processes and operations across different geographies, developing solutions and services capable of operating at multiple scales, always within the same systemic logic:</p>
    <ul>
      <li>design and development of experimental spaces and architectures.</li>
      <li>design of spatial systems and modular structures.</li>
      <li>creative and conceptual direction.</li>
      <li>consulting for cultural, conceptual, urban, or corporate projects.</li>
      <li>development of technological and methodological tools linked to these systems.</li>
    </ul>

    <p>each project is approached through a critical reading of its context, resolving complex needs through adaptive infrastructures that integrate into xpan’s operating system.</p>

    <p>projects scale and reconfigure across new territories through precise and adaptive systems, offering collaborators and institutions a proven and flexible foundation capable of resolving spatial, technical, and conceptual needs in an integrated way.</p>
  </div>

  <!-- FR -->
  <div class="description" lang="fr">
    <h2>xpan</h2>
    <p><strong>xpan</strong> développe des systèmes spatiaux et conceptuels à partir du design, de la recherche et de la composition de structures adaptatives. sa pratique combine conceptualisation et construction matérielle, générant un écosystème où architectures, dispositifs, objets, publications et outils opèrent comme les éléments d’un même ensemble structurel, consolidant xpan comme une infrastructure culturelle autonome et contemporaine.</p>

    <p>le projet développe ses propres systèmes, activés dans des contextes réels, parallèlement à des solutions spécialisées pour des institutions, entreprises et organisations. il a réalisé des activations culturelles, des programmes publics, des installations sonores, des interventions spatiales, des publications et des projets de recherche.</p>

    <p>à ce jour, xpan a réalisé plus de soixante activations et collaboré avec plus de 1 200 agents, artistes, curateurs et institutions dans des villes comme tokyo, paris, new york et mexico.</p>

    <p>xpan déploie des processus expérimentaux et des opérations dans différentes géographies, développant des solutions et services capables d’opérer à plusieurs échelles, toujours selon la même logique systémique :</p>
    <ul>
      <li>conception et développement d’espaces et d’architectures expérimentales.</li>
      <li>conception de systèmes spatiaux et de structures modulaires.</li>
      <li>direction créative et conceptuelle.</li>
      <li>conseil pour des projets culturels, conceptuels, urbains ou corporatifs.</li>
      <li>développement d’outils technologiques et méthodologiques liés à ces systèmes.</li>
    </ul>

    <p>chaque projet est abordé à partir d’une lecture critique du contexte, résolvant des besoins complexes à travers des infrastructures adaptatives qui s’intègrent au système opérationnel de xpan.</p>

    <p>les projets évoluent et se reconfigurent dans de nouveaux territoires grâce à des systèmes précis et adaptatifs, offrant aux collaborateurs et institutions une base flexible et éprouvée, capable de répondre de manière intégrée aux besoins spatiaux, techniques et conceptuels.</p>
  </div>

  <!-- JP -->
  <div class="description" lang="jp">
    <h2>xpan</h2>
    <p><strong>xpan</strong> は、デザイン、リサーチ、そして適応的構造の構成を通じて空間的・概念的システムを開発しています。建築物・デバイス・オブジェクト・出版物・ツールが単一の構造的フレームワークとして機能するエコシステムを形成し、概念化と物質的構築を統合することで、自律的で現代的な文化インフラとして確立されています。</p>

    <p>本プロジェクトは独自のシステムを開発し実際の文脈で作動させる一方で、機関・企業・組織向けの専門的ソリューションも展開しています。文化的アクティベーション、公共プログラム、サウンドインスタレーション、空間介入、出版物、研究プロジェクトを手がけてきました。</p>

    <p>xpan はこれまでに 60 件以上のアクティベーションを実施し、東京・パリ・ニューヨーク・メキシコシティなどで 1,200 名以上のアーティスト、キュレーター、機関と協働しています。</p>

    <p>xpan は複数地域で実験的プロセスとオペレーションを展開し、常に同一のシステム論的ロジックに基づき、複数スケールで機能するソリューションとサービスを開発しています:</p>
    <ul>
      <li>実験的な空間・建築の設計および開発。</li>
      <li>空間システムおよびモジュラー構造の設計。</li>
      <li>クリエイティブおよびコンセプトディレクション。</li>
      <li>文化的・概念的・都市的・企業的プロジェクトのコンサルティング。</li>
      <li>これらのシステムに関連する技術的・方法論的ツールの開発。</li>
    </ul>

    <p>各プロジェクトは文脈への批評的アプローチを基盤とし、適応的インフラを通じて複雑な要求を解決し、xpan のオペレーティングシステムへ統合されます。</p>

    <p>プロジェクトは精度の高い適応的システムによって新領域へ拡張・再構成され、空間的・技術的・概念的要求に統合的に対応できる柔軟で実証済みの基盤を協働者や機関に提供します。</p>
  </div>

</div>

</section>

<h3 id="portfolio-title" class="section-title">proyectos destacados</h3>
<div id="all-entries"></div>

<!-- lightbox -->
<div id="xpan-lightbox" role="dialog" aria-modal="true"><div class="sheet"></div></div>

<script>
/* ================== i18n ================== */
const I18N={ es:{featured:"proyectos destacados"}, en:{featured:"featured projects"}, fr:{featured:"projets sélectionnés"}, jp:{featured:"主要プロジェクト"} };
function setLang(lang){
  document.querySelectorAll('.lang-select button').forEach(b=>{ const on=b.dataset.lang===lang; b.classList.toggle('active',on); b.setAttribute('aria-pressed',on?'true':'false'); });
  document.querySelectorAll('.description').forEach(d=> d.classList.toggle('active', d.getAttribute('lang')===lang));
  const t=document.getElementById('portfolio-title'); if(t && I18N[lang]) t.textContent=I18N[lang].featured;
  try{ localStorage.setItem('xpan.lang',lang); }catch{}
  document.documentElement.setAttribute('lang',lang);
}
document.getElementById('langSelect').addEventListener('click',e=>{ const btn=e.target.closest('button[data-lang]'); if(btn) setLang(btn.dataset.lang); });

/* ================== HERO — interpolación (preservada) ================== */
(function initHero(){
  const logo=document.getElementById('heroLogo'); const hero=document.getElementById('hero'); if(!logo||!hero) return;
  const PAD=16, FINAL_W_DESKTOP=64, FINAL_W_MOBILE=56, DESKTOP_BREAK=768; let baseWidth=null;
  const easeOut=t=>1-Math.pow(1-t,3);
  function headerRect(){
    const el=document.querySelector('[data-hero-target]')||document.querySelector('header img[src*="xpan.svg"]')||document.querySelector('header .site-logo img')||document.querySelector('header a[href="/"] img'); if(!el) return null;
    const r=el.getBoundingClientRect(); return (r.width&&r.height)?r:null;
  }
  function compute(){
    if(baseWidth==null){ const cs=getComputedStyle(logo); const w=parseFloat(cs.width); baseWidth=(w&&isFinite(w))?w:(logo.naturalWidth||200); }
    const isMob=innerWidth<DESKTOP_BREAK, heroH=Math.max(1, hero.offsetHeight||innerHeight);
    const hr=headerRect(); const finalW=hr?Math.max(28,Math.min(160,hr.width)):(isMob?FINAL_W_MOBILE:FINAL_W_DESKTOP);
    const fromCx=innerWidth/2, fromCy=innerHeight/2;
    const toCx=hr?(hr.left+hr.width/2):(PAD+finalW/2), toCy=hr?(hr.top+hr.height/2):(PAD+finalW/2);
    const dx=toCx-fromCx, dy=toCy-fromCy;
    const t=Math.max(0,Math.min(1, scrollY/(heroH*.92))), e=easeOut(t);
    const s=1+((finalW/baseWidth)-1)*e, tx=dx*e, ty=dy*e;
    logo.style.transform=`translate3d(-50%,-50%,0) translate3d(${tx}px,${ty}px,0) scale(${s})`;
    logo.style.position='fixed'; logo.style.top='50%'; logo.style.left='50%'; logo.style.zIndex='60';
  }
  let ticking=false;
  addEventListener('scroll',()=>{ if(!ticking){ ticking=true; requestAnimationFrame(()=>{ compute(); ticking=false; }); } },{passive:true});
  addEventListener('resize',()=>{ requestAnimationFrame(()=>{ baseWidth=null; compute(); }); },{passive:true});
  addEventListener('orientationchange',()=>{ requestAnimationFrame(()=>{ baseWidth=null; compute(); }); },{passive:true});
  new MutationObserver(()=> requestAnimationFrame(compute)).observe(document.documentElement,{childList:true,subtree:true});
  requestAnimationFrame(compute);
})();

/* ================== AEI (preservado y afinado) ================== */
(function initAEI(){
  const layer=document.getElementById('aeiLayer'); const svg=document.getElementById('aeiLines'); const wrap=document.getElementById('descWrap'); if(!layer||!svg||!wrap) return;
  const urls=[
    "https://d2w9rnfcy7mm78.cloudfront.net/40745994/original_77a7afa258aa463a8c945e0b55b0ead8.png?1761881049&bc=0",
    "https://d2w9rnfcy7mm78.cloudfront.net/40745991/original_98ebeabf5a4b3e7622c7f357502e2217.png?1761881049&bc=0",
    "https://d2w9rnfcy7mm78.cloudfront.net/40745993/original_6d0449268d243af2fe98b069ef0df687.png?1761881049&bc=0",
    "https://d2w9rnfcy7mm78.cloudfront.net/40745995/original_d77cd22950a8a1e2ddd6e6e6283e1dc8.png?1761881049&bc=0",
    "https://d2w9rnfcy7mm78.cloudfront.net/40745992/original_1fc9933b2f8ce7925a5aae9c88b34813.png?1761881049&bc=0",
    "https://d2w9rnfcy7mm78.cloudfront.net/40745990/original_ca4f1fd040fe036fd3768bddd9487fd7.png?1761881049&bc=0",
    "https://d2w9rnfcy7mm78.cloudfront.net/40745988/original_2978ffd117332e5c884c826f681d6285.png?1761881049&bc=0",
    "https://d2w9rnfcy7mm78.cloudfront.net/40745989/original_f6ed552681cba118f73eb07cf24cbabc.png?1761881049&bc=0",
    "https://d2w9rnfcy7mm78.cloudfront.net/40745986/original_996fe49af0bdd77d341f9ed4891ea560.png?1761881049&bc=0",
    "https://d2w9rnfcy7mm78.cloudfront.net/40745987/original_a6019cb169d907ed522ab3aeb54b3742.png?1761881049&bc=0",
    "https://d2w9rnfcy7mm78.cloudfront.net/40745985/original_5aca1ecbb74e237ef28935d767f71210.png?1761881049&bc=0",
    "https://d2w9rnfcy7mm78.cloudfront.net/40745984/original_af5265452a5470d4fe75afc90d4ad58b.png?1761881049&bc=0",
    "https://d2w9rnfcy7mm78.cloudfront.net/40745983/original_f339212296815e0f1e1bc31ea02d58aa.png?1761881049&bc=0",
    "https://d2w9rnfcy7mm78.cloudfront.net/40745982/original_d26303661dd70e30ca93cdf01f486460.png?1761881049&bc=0",
    "https://d2w9rnfcy7mm78.cloudfront.net/40745981/original_bb999e4d7e729d5b750aa9107f2afe59.png?1761881049&bc=0",
    "https://d2w9rnfcy7mm78.cloudfront.net/40745980/original_d4885e4a7e28ce7b6200bdcca06066c2.png?1761881049&bc=0",
    "https://d2w9rnfcy7mm78.cloudfront.net/40745979/original_73af61b88cf5587b191cc026065190c5.png?1761881049&bc=0",
    "https://d2w9rnfcy7mm78.cloudfront.net/40745978/original_fe5100aac4e7cf8ec0e36f576bb26e7a.png?1761881049&bc=0",
    "https://d2w9rnfcy7mm78.cloudfront.net/40745977/original_5792f551846a6f3c230cd60ab193a2d0.png?1761881049&bc=0",
    "https://d2w9rnfcy7mm78.cloudfront.net/40745975/original_b713d72b437a1004289079db57c9219e.png?1761881049&bc=0",
    "https://d2w9rnfcy7mm78.cloudfront.net/40745976/original_ec32858a5e4a7e391a994faa781f96b8.png?1761881048&bc=0",
    "https://d2w9rnfcy7mm78.cloudfront.net/40745974/original_3b74abdfaec2e208ac9d9cd013a96edf.png?1761881048&bc=0",
    "https://d2w9rnfcy7mm78.cloudfront.net/40745973/original_7207e2fc863a0cfe2af6689503545510.png?1761881048&bc=0",
    "https://d2w9rnfcy7mm78.cloudfront.net/40745972/original_11b16bc1a913438e9162c007bf99a095.png?1761881048&bc=0",
    "https://d2w9rnfcy7mm78.cloudfront.net/40745971/original_7e65b99cfb02801b165310d48f11f001.png?1761881048&bc=0"
  ];
  const nodes=[]; const speed=0.08, repel=90, k=2;
  urls.forEach(src=>{
    const img=document.createElement('img'); img.src=src; img.alt='xpan symbol'; img.className='aei-sym'; img.decoding='async'; img.loading='eager';
    layer.appendChild(img);
    const W=layer.clientWidth||innerWidth, H=layer.clientHeight||innerHeight, pad=40;
    nodes.push({el:img,x:Math.random()*(W-2*pad)+pad,y:Math.random()*(H-2*pad)+pad,vx:(Math.random()-.5)*speed,vy:(Math.random()-.5)*speed});
  });
  function sizeSvg(){ const r=svg.getBoundingClientRect(), w=Math.max(1,Math.round(r.width)), h=Math.max(1,Math.round(r.height)); svg.setAttribute('width',w); svg.setAttribute('height',h); svg.setAttribute('viewBox',`0 0 ${w} ${h}`); }
  sizeSvg(); addEventListener('resize',sizeSvg,{passive:true});
  function drawEdges(){
    svg.innerHTML='';
    for(let i=0;i<nodes.length;i++){
      const d=[]; for(let j=0;j<nodes.length;j++){ if(i===j) continue; const dx=nodes[j].x-nodes[i].x, dy=nodes[j].y-nodes[i].y; d.push([j, dx*dx+dy*dy]);}
      d.sort((a,b)=>a[1]-b[1]);
      for(let m=0;m<Math.min(k,d.length);m++){
        const j=d[m][0], a=nodes[i], b=nodes[j], ln=document.createElementNS('http://www.w3.org/2000/svg','line');
        ln.setAttribute('x1',a.x+a.el.clientWidth/2); ln.setAttribute('y1',a.y+a.el.clientHeight/2);
        ln.setAttribute('x2',b.x+b.el.clientWidth/2); ln.setAttribute('y2',b.y+b.el.clientHeight/2);
        ln.setAttribute('stroke', getComputedStyle(document.documentElement).color || '#000'); ln.setAttribute('stroke-width','.6'); ln.setAttribute('opacity','.28');
        svg.appendChild(ln);
      }
    }
  }
  let paused=false; new IntersectionObserver(([e])=>{ paused=!e.isIntersecting; },{threshold:.05}).observe(wrap);
  function step(){
    if(!paused){
      const W=layer.clientWidth||innerWidth, H=layer.clientHeight||innerHeight;
      nodes.forEach(n=>{
        let ax=0,ay=0; nodes.forEach(m=>{ if(m===n) return; const dx=n.x-m.x, dy=n.y-m.y, d=Math.hypot(dx,dy)||1; if(d<repel){ ax+=dx/d; ay+=dy/d; } });
        n.vx+=0.0006*ax; n.vy+=0.0006*ay; n.x+=n.vx; n.y+=n.vy;
        if(n.x<0||n.x>W-n.el.clientWidth) n.vx*=-1; if(n.y<0||n.y>H-n.el.clientHeight) n.vy*=-1;
        n.el.style.transform=`translate(${n.x}px,${n.y}px)`;
      });
      drawEdges();
    }
    requestAnimationFrame(step);
  }
  drawEdges(); step();
  const fadeIO=new IntersectionObserver(([entry])=>{
    const bg=document.getElementById('aeiBg'); const inner=document.querySelector('.desc-inner');
    if(entry.intersectionRatio<.25){ bg.classList.add('fade-away'); inner.classList.add('fade-away'); }
    else { bg.classList.remove('fade-away'); inner.classList.remove('fade-away'); }
  },{threshold:[0,.25,.5,.75,1]});
  fadeIO.observe(wrap);
  if(matchMedia('(prefers-reduced-motion: reduce)').matches){ nodes.forEach(n=>{ n.vx=0; n.vy=0; }); }
})();

/* ================== lazy + carruseles ================== */
function setupLazy(scope=document){
  const io=new IntersectionObserver((es,obs)=>{
    es.forEach(en=>{
      if(!en.isIntersecting) return;
      const el=en.target;
      if(el.tagName==='IMG' && el.dataset.src){ el.src=el.dataset.src; el.removeAttribute('data-src'); }
      if(el.tagName==='SOURCE' && el.dataset.src){ el.src=el.dataset.src; el.removeAttribute('data-src'); el.parentElement?.load?.(); }
      obs.unobserve(el);
    });
  },{rootMargin:'600px 0px'});
  scope.querySelectorAll('img[data-src],source[data-src]').forEach(el=> io.observe(el));
}
function initCarousels(scope=document){
  scope.querySelectorAll('.carousel-track').forEach(track=>{
    if(!track.dataset.duped){ [...track.children].forEach(el=> track.appendChild(el.cloneNode(true))); track.dataset.duped="1"; }
    let x=0, speed=.3, dragging=false, startX=0, startVal=0, active=true;
    function step(){ if(active && !dragging){ const w=track.scrollWidth/2; x+=speed; if(x>=w) x=0; track.style.transform=`translate3d(${-x}px,0,0)`; } requestAnimationFrame(step); }
    requestAnimationFrame(step);
    track.addEventListener('pointerdown',e=>{ dragging=true; startX=e.clientX; startVal=x; track.setPointerCapture(e.pointerId); track.style.cursor='grabbing'; });
    track.addEventListener('pointermove',e=>{ if(!dragging) return; const dx=e.clientX-startX; const w=track.scrollWidth/2; x=(startVal-dx); if(x>=w) x=0; if(x<0) x=w+x; track.style.transform=`translate3d(${-x}px,0,0)`; });
    ['pointerup','pointerleave'].forEach(ev=> track.addEventListener(ev,()=>{ dragging=false; track.style.cursor='grab'; }));
    function highlight(){
      const r=track.parentElement.getBoundingClientRect(); const items=track.querySelectorAll('img,.carousel-video,video');
      let best=null,min=Infinity; items.forEach(it=>{ const d=Math.abs(it.getBoundingClientRect().left-r.left); if(d<min){min=d; best=it;} });
      items.forEach(it=> it.classList.remove('highlight')); if(best) best.classList.add('highlight');
    }
    setInterval(highlight,120);
    const aoi=new IntersectionObserver(es=>{ es.forEach(en=> active=en.isIntersecting); },{rootMargin:'100px 0px',threshold:.01});
    aoi.observe(track.closest('.carousel-wrapper')||track);
  });
}

/* ================== inyección de entries ================== */
async function injectEntries({sourceUrl,targetId,excludeSelectors=[]}){
  try{
    const res=await fetch(sourceUrl,{credentials:'same-origin'}); if(!res.ok) throw new Error(sourceUrl+' → '+res.status);
    const html=await res.text(); const doc=new DOMParser().parseFromString(html,'text/html');
    let entries=[...doc.querySelectorAll('.entry')];
    if(excludeSelectors.length){ entries=entries.filter(el=> !excludeSelectors.some(sel=> el.matches(sel)||el.querySelector(sel))); }
    const mount=document.getElementById(targetId);
    entries.forEach(n=>{ n.querySelectorAll('img:not([alt])').forEach(i=> i.alt='xpan project'); mount.appendChild(document.importNode(n,true)); });
    setupLazy(mount); initCarousels(mount);
    return entries.length;
  }catch(err){
    console.error('error al inyectar', sourceUrl, err);
    const mount=document.getElementById(targetId); const p=document.createElement('p'); p.textContent='error cargando '+sourceUrl; p.style.opacity='.6'; mount.appendChild(p);
    return 0;
  }
}

/* ================== orden opcional ================== */
function norm(s){ return (s||'').toLowerCase().normalize('NFD').replace(/\p{Diacritic}/gu,'').replace(/[_—–-]/g,' ').replace(/[^\p{L}\p{N}\s\.]/gu,'').replace(/\s+/g,' ').trim(); }
function entryKey(entry){ const title=entry.querySelector('strong')?.textContent||''; const href=entry.querySelector('a[href]')?.getAttribute('href')||''; const slug=href.split('/').pop()?.replace(/\.html$/,'')||''; return norm(title)||norm(slug); }
function reorderManual(containerId, desired){
  const c=document.getElementById(containerId); const items=[...c.querySelectorAll('.entry')];
  const keys=items.map(el=>({el, key:entryKey(el), title:entryKey(el), slug:entryKey(el)}));
  const used=new Set(); const out=document.createDocumentFragment(); const want=desired.map(norm).filter(Boolean);
  want.forEach(token=>{ const i=keys.findIndex(o=> !used.has(o.el) && (o.key.includes(token)||o.title.includes(token)||o.slug.includes(token))); if(i>=0){ used.add(keys[i].el); out.appendChild(keys[i].el); }});
  items.forEach(el=>{ if(!used.has(el)) out.appendChild(el); });
  c.appendChild(out);
}

/* ================== boot ================== */
document.addEventListener('DOMContentLoaded', ()=>{
  // idioma inicial
  const saved=(()=>{ try{ return localStorage.getItem('xpan.lang'); }catch{ return null; }})();
  const br=(navigator.language||'es').slice(0,2).toLowerCase();
  const initial=['es','en','fr','jp'].includes(saved)?saved:(['es','en','fr','jp'].includes(br)?br:'es');
  document.querySelectorAll('#langSelect button').forEach(b=> b.dataset.lang=b.textContent.trim());
  setLang(initial);

  // inyección de índices
  Promise.all([
    injectEntries({sourceUrl:'arquitectura.index.html',targetId:'all-entries'}),
    injectEntries({sourceUrl:'mdtc.index.html',targetId:'all-entries'})
  ]).then(()=>{
    const desiredOrder=[
      'arq.xpan.s.e.e.v.s.12','c&c_xpan.s.e.e.v.s_12','s.e.e.v.s_12',
      'arq.xpan.ep.1', 'xpan.ep.1',
      'arq.xpan.ep.t','arq.xpan.12e',
      'arq.xpan.espacio.gdl','espacio gdl','espacio.gdl',
      'atlas','xpan.atlas',
      'arq.xpan.mdl.1','mdl.1','xpan.mdl.1',
      'arq.xpan.desidia','desidia',
      'arq.xpan.hex_666','hex 666','hex_666',
      'arq.xpan.i8oppa','i8oppa',
      'mdtc.4','mdtc.04','mdtc4',
      'estructuras auxiliares','auxiliares',
      'hipersensoria','torre de los vientos','mdtc.hipersensoria',
      'anahuacalli','sound+ anahuacalli'
    ];
    reorderManual('all-entries', desiredOrder);
  });

  // lazy para contenido ya presente (si lo hubiera)
  setupLazy(document);
  initCarousels(document);
});

/* ================== lightbox ================== */
(function(){
  const lb=document.getElementById('xpan-lightbox'); const sheet=lb.querySelector('.sheet');
  let items=[], idx=-1, t0=0, x0=0;
  function collect(){ items=[...document.querySelectorAll('img,video')].filter(el=> !el.closest('#xpan-lightbox') && !el.closest('a') && (el.currentSrc||el.src)); }
  function openAt(i){
    if(i<0||i>=items.length) return; idx=i; sheet.innerHTML='';
    const srcEl=items[idx]; const isV=srcEl.tagName.toLowerCase()==='video'; const el=document.createElement(isV?'video':'img');
    if(isV){ el.src=srcEl.currentSrc||srcEl.src; el.playsInline=true; el.controls=true; el.loop=!!srcEl.loop; el.muted=false; el.autoplay=true; }
    else { el.src=srcEl.currentSrc||srcEl.src; el.decoding='async'; el.loading='eager'; el.alt=''; }
    sheet.appendChild(el); lb.classList.add('open'); document.documentElement.classList.add('lb-open'); document.body.classList.add('lb-open');
  }
  function close(){ lb.classList.remove('open'); sheet.innerHTML=''; document.documentElement.classList.remove('lb-open'); document.body.classList.remove('lb-open'); idx=-1; }
  function openFrom(el){ collect(); const i=items.indexOf(el); if(i>-1) openAt(i); }
  document.body.addEventListener('click',e=>{ const el=e.target; if(!el) return; if(el.closest('a')) return; if(el.tagName==='IMG'||el.tagName==='VIDEO'){ e.preventDefault(); e.stopPropagation(); openFrom(el); } },{capture:true});
  lb.addEventListener('click',e=>{ if(e.target===lb) close(); });
  addEventListener('keydown',e=>{ if(!lb.classList.contains('open')) return; if(e.key==='Escape') return close(); if((e.key==='ArrowRight'||e.key==='l') && idx<items.length-1) return openAt(idx+1); if((e.key==='ArrowLeft'||e.key==='h') && idx>0) return openAt(idx-1); });
  lb.addEventListener('touchstart',e=>{ t0=Date.now(); x0=e.touches[0].clientX; },{passive:true});
  lb.addEventListener('touchend',e=>{ const dx=e.changedTouches[0].clientX-x0, dt=Date.now()-t0; if(Math.abs(dx)>50 && dt<600){ if(dx<0 && idx<items.length-1) openAt(idx+1); else if(dx>0 && idx>0) openAt(idx-1); } else { close(); } },{passive:true});
  new MutationObserver(()=>collect()).observe(document.documentElement,{subtree:true,childList:true});
  collect();
})();
</script>
</body>
</html>
