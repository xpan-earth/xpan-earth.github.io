<!DOCTYPE html>
<html lang="es" data-xpan>
<head>
  <meta charset="UTF-8"/>
  <meta name="viewport" content="width=device-width, initial-scale=1.0"/>
  <meta name="color-scheme" content="light dark"/>
  <title>mdtc.4 [ eden garden cinema ] — arquitectura</title>

  <!-- ===== tokens post-tech ===== -->
  <style>
    :root{
      --bg:#000; --fg:#E0E3E6; --fg-dim:#AEB4BA; --accent:#1860FF;
      --line:#2A2E31; --line-weak:#1A1D20; --b1:1px solid var(--line);
      --font-ui:-apple-system,BlinkMacSystemFont,"Inter","Segoe UI",Roboto,Helvetica,Arial,sans-serif;
      --font-mono:"IBM Plex Mono","SFMono-Regular",Menlo,Consolas,Monaco,monospace;
      --maxw:1000px; --g:24px; --pad-x:clamp(16px,4vw,48px); --header-h:64px;
    }
    @media (prefers-color-scheme:light){
      :root{
        --bg:#fff; --fg:#0E1113; --fg-dim:#4A5158; --accent:#1860FF;
        --line:#D9DEE2; --line-weak:#ECEFF2;
      }
    }

    /* ===== base ===== */
    *,*::before,*::after{box-sizing:border-box}
    html,body{
      margin:0; background:var(--bg); color:var(--fg);
      font-family:var(--font-ui); -webkit-font-smoothing:antialiased; -moz-osx-font-smoothing:grayscale;
      overflow-x:hidden;
    }
    img,video,iframe,object{display:block;max-width:100%;height:auto;background:transparent}
    a{color:var(--accent);text-decoration:none;border-bottom:1px solid transparent;transition:border-color .15s linear}
    a:hover{border-bottom-color:var(--accent)}

    /* ===== header + idioma ===== */
    header{position:fixed;top:12px;left:var(--pad-x);right:var(--pad-x);z-index:100;display:flex;align-items:center;justify-content:space-between;height:var(--header-h)}
    header a{display:inline-flex;align-items:center}
    header img{width:50px;height:auto;mix-blend-mode:difference;filter:invert(1) saturate(100%)}
    @media (prefers-color-scheme:light){ header img{ filter:none } }

    .language-selector{
      position:fixed;top:12px;right:var(--pad-x);z-index:120;
      display:flex;gap:8px;align-items:center;text-transform:lowercase
    }
    .language-selector button{
      appearance:none;background:transparent;border:var(--b1);border-radius:0;
      padding:.35rem .6rem;cursor:pointer;color:var(--fg-dim);
      font:600 .9rem/1 var(--font-ui);letter-spacing:.2px;
      transition:color .15s linear, border-color .15s linear, background-color .15s linear;
    }
    .language-selector button:hover{color:var(--fg)}
    .language-selector button.active{color:var(--fg);border-color:var(--accent);background:rgba(24,96,255,.06)}

    /* ===== layout ===== */
    .container{max-width:var(--maxw);margin:calc(var(--header-h) + 40px) auto 64px;padding:0 var(--pad-x)}
    h1{font:700 1.5rem/1.25 var(--font-ui);margin:0 0 .5rem;text-transform:lowercase}
    .meta{font:400 .9rem/1.5 var(--font-ui);color:var(--fg-dim);margin:0 0 1.5rem;font-style:italic}

    /* ===== descripciones multilenguaje (preservadas) ===== */
    .description{font:400 1rem/1.65 var(--font-ui);max-width:700px;margin:0 0 2rem;display:none}
    .description.active{display:block}

    /* ===== galería ===== */
    .gallery{display:grid;grid-template-columns:repeat(auto-fit,minmax(250px,1fr));gap:.5rem;margin-bottom:2rem}
    .gallery img,.gallery video{width:100%;max-height:300px;object-fit:contain;border:var(--b1)}
    .gallery video{background:transparent}

    /* ===== PDF ===== */
    .pdf-embed iframe{width:100%;height:600px;border:var(--b1);background:#0C0D0F;margin-bottom:2rem}
    @media (max-width:768px){ .pdf-embed iframe{height:auto;aspect-ratio:4/3} }

    /* ===== audio block ===== */
    .xpan-audio-block{border:var(--b1);padding:1rem;margin-bottom:3rem}
    .audio-meta .title{font:700 1rem/1 var(--font-ui);text-transform:lowercase;margin:0 0 .25rem}
    .audio-meta .info{font:400 .9rem/1.4 var(--font-ui);color:var(--fg-dim);margin:0 0 1rem}
    .audio-controls{display:flex;align-items:center;gap:1rem;flex-wrap:wrap}
    .play-button{appearance:none;background:transparent;border:var(--b1);border-radius:0;padding:.4rem .6rem;cursor:pointer;color:var(--fg)}
    .time-display{font:400 .85rem/1 var(--font-ui);min-width:72px;color:var(--fg-dim)}
    .progress-container{position:relative;flex-grow:1;height:2px;background:var(--line);cursor:pointer;touch-action:none}
    .progress-fill{height:2px;background:var(--fg);width:0%}
    canvas{width:100%;height:100px;display:block;margin-top:1rem;background:transparent}
    .tooltip{position:absolute;font:.75rem/1 var(--font-ui);background:var(--fg);color:var(--bg);padding:.2rem .4rem;transform:translateX(-50%);top:-1.5rem;display:none;pointer-events:none;z-index:100}

    /* ===== lightbox (preservado) ===== */
    #xpan-lightbox{position:fixed;inset:0;z-index:9999;display:none;align-items:center;justify-content:center;background:rgba(10,10,10,.45);backdrop-filter:blur(10px) saturate(120%);-webkit-backdrop-filter:blur(10px) saturate(120%);touch-action:none;overscroll-behavior:contain}
    #xpan-lightbox.open{display:flex}
    #xpan-lightbox .sheet{position:relative;max-width:100vw;max-height:100vh;overflow:hidden;transform:scale(.985);opacity:0;transition:transform .18s linear,opacity .18s linear}
    #xpan-lightbox.open .sheet{transform:scale(1);opacity:1}
    #xpan-lightbox img,#xpan-lightbox video{display:block;width:auto;height:auto;max-width:100vw;max-height:100vh;object-fit:contain;margin:0;background:transparent}
    html.lb-open,body.lb-open{overflow:hidden;touch-action:none}
    @media (prefers-color-scheme:light){#xpan-lightbox{background:rgba(255,255,255,.55)}}

    @media (max-width:768px){
      .container{margin:calc(var(--header-h) + 28px) auto 40px;padding:0 var(--pad-x)}
      .audio-controls{flex-direction:column;align-items:flex-start}
    }
  </style>

  <!-- util existente preservado -->
  <script src="/assets/js/media-proxy.js" defer></script>
</head>

<body>
  <!-- header normalizado -->
  <header>
    <a href="https://xpan.earth" target="_blank" rel="noopener">
      <img src="xpan.svg" alt="xpan logo" fetchpriority="high"/>
    </a>
    <nav class="language-selector" aria-label="selector de idioma">
      <button type="button" data-lang="es" class="active" aria-pressed="true">es</button>
      <button type="button" data-lang="en" aria-pressed="false">en</button>
      <button type="button" data-lang="fr" aria-pressed="false">fr</button>
      <button type="button" data-lang="jp" aria-pressed="false">jp</button>
    </nav>
  </header>

  <!-- lightbox preservado -->
  <div id="xpan-lightbox" role="dialog" aria-modal="true"><div class="sheet"></div></div>

  <div class="container">
    <h1>mdtc.4 [ eden garden cinema ]</h1>
    <div class="meta">abril 2025 — hotel reforma, ciudad de méxico</div>

    <!-- descripciones multilenguaje preservadas -->
    <div class="description active" lang="es">[
      intervención espacial desarrollada por xpan junto a mario alore y eli pastore.<br><br>
      estructura principal: estrella de seis puntas construida con 132 reflectores de alta intensidad, unidos mediante cable de acero. el conjunto —de más de 3 metros de diámetro— fue suspendido en el centro del espacio. su trazo continuo forma una figura cerrada y expansiva. la proyección lumínica es directa, sin dispersión: genera un volumen denso, agresivo y frontal.<br><br>
      el sistema se completa con una lámina de aluminio pulido alineada al centro geométrico de la estrella, y un mixtape en reproducción continua.<br><br>
      el público accede a memorias usb metálicas con el audio. cada unidad está diseñada con una punta afilada, permitiendo inscribir trazos sobre la lámina. los desplazamientos físicos durante la escucha activan un protocolo de intervención: gesto, vibración y registro convergen en un único plano.<br><br>
      este proyecto define una plataforma de exposición extrema, donde la memoria se acumula como residuo material.
    ]</div>

    <div class="description" lang="en">[
      spatial intervention developed by xpan with mario alore and eli pastore.<br><br>
      main structure: six-pointed star built with 132 high-intensity reflectors, connected by steel cable. the assembly —over 3 meters in diameter— was suspended at the center of the space. its continuous stroke forms a closed and expansive figure. light projection is direct, without dispersion: it generates a dense, aggressive, and frontal volume.<br><br>
      the system is completed by a polished aluminum sheet aligned to the geometric center of the star, and a mixtape in continuous playback.<br><br>
      the audience receives metallic usb drives with the audio. each unit is designed with a sharp tip, enabling inscriptions on the sheet. physical movement during listening activates an intervention protocol: gesture, vibration, and trace converge on a single plane.<br><br>
      this project defines a platform of extreme exhibition, where memory accumulates as material residue.
    ]</div>

    <div class="description" lang="fr">[
      intervention spatiale développée par xpan avec mario alore et eli pastore.<br><br>
      structure principale : étoile à six branches construite avec 132 projecteurs haute intensité, reliés par des câbles en acier. l’ensemble — de plus de 3 mètres de diamètre — était suspendu au centre de l’espace. son tracé continu forme une figure fermée et expansive. la projection lumineuse est directe, sans dispersion : elle génère un volume dense, agressif et frontal.<br><br>
      le système est complété par une feuille d’aluminium poli alignée au centre géométrique de l’étoile, et une mixtape diffusée en boucle.<br><br>
      le public reçoit des clés usb métalliques contenant l’audio. chaque unité est conçue avec une pointe acérée, permettant de tracer sur la feuille. les déplacements physiques pendant l’écoute activent un protocole d’intervention : geste, vibration et inscription convergent sur un même plan.<br><br>
      ce projet définit une plateforme d’exposition extrême, où la mémoire s’accumule en tant que résidu matériel.
    ]</div>

    <div class="description" lang="jp">[
      空間インスタレーションは、xpanがmario aloreおよびeli pastoreと共同で開発。<br><br>
      主構造は132個の高強度リフレクターで構成され、スチールケーブルで接続された六芒星。直径3メートル以上の構造体が空間中央に吊るされ、連続的な軌跡が閉じた拡張形態を形成する。光の投影は拡散せず直接的で、密度が高く攻撃的で正面から迫るようなボリュームを生み出す。<br><br>
      システムは、幾何学的中心に配置された研磨アルミニウム板と、連続再生されるミックステープで構成される。<br><br>
      観客は音源が収録された金属製USBを受け取り、それぞれのデバイスには鋭い先端があり、アルミ板に刻みを入れることができる。鑑賞中の身体的な移動が、介入のプロトコルを起動させる：ジェスチャー、振動、記録が一つの平面に収束する。<br><br>
      本プロジェクトは、記憶が物質的残滓として蓄積される極限的展示プラットフォームを提示する。
    ]</div>

    <!-- audio block 1 (original) -->
    <div class="xpan-audio-block audio-local">
      <div class="audio-meta">
        <div class="title">mdtc.4 — mixtape</div>
        <div class="info">eden garden cinema</div>
      </div>
      <div class="audio-controls">
        <button class="play-button">play</button>
        <div class="time-display">0:00 / 0:00</div>
        <div class="progress-container"><div class="progress-fill"></div></div>
        <audio crossorigin="anonymous">
          <source src="https://ia601404.us.archive.org/15/items/mixtape-mdtc.-4/mixtape%20mdtc.4%20.wav" type="audio/wav"/>
        </audio>
      </div>
      <canvas></canvas>
    </div>



    <!-- galería: src -> data-src para lazy -->
    <div class="gallery" id="gallery">
      <video muted loop playsinline preload="none" data-src="https://attachments.are.na/38029171/c70f2ec676db10432d4df5e8b4edfda3.mov?1752183654"></video>
      <img alt="" data-src="https://d2w9rnfcy7mm78.cloudfront.net/38029070/original_e7b6d2edeaec7c33f7e398a967b4ff0c.jpg?1752183429&bc=0"/>
      <video muted loop playsinline preload="none" data-src="https://attachments.are.na/38029238/3f48480f6d82c26d60073d5b95e9f7ce.mov?1752183909"></video>
      <img alt="" data-src="https://d2w9rnfcy7mm78.cloudfront.net/38029309/original_9b731ba68e2eee8f5fc5a7f7c2ae1aa1.jpg?1752184198&bc=0"/>
      <img alt="" data-src="https://d2w9rnfcy7mm78.cloudfront.net/38029073/original_8efbcaddd954b94114d53a98103ae916.png?1752183431&bc=0"/>
      <video muted loop playsinline preload="none" data-src="https://attachments.are.na/38029305/0b03a0fcd3349e3340a51dee746606a2.mov?1752184195"></video>
      <img alt="" data-src="https://d2w9rnfcy7mm78.cloudfront.net/38029063/original_6dc8153cd9404303dbb7d10b4b2ba71e.jpg?1752183401&bc=0"/>
      <img alt="" data-src="https://d2w9rnfcy7mm78.cloudfront.net/38029530/original_b2473108c7785c385e659428680d3887.jpg?1752184871&bc=0"/>
      <img alt="" data-src="https://d2w9rnfcy7mm78.cloudfront.net/38029298/original_6383db92fd1058962f1855501f3dc537.jpg?1752184179&bc=0"/>
      <img alt="" data-src="https://d2w9rnfcy7mm78.cloudfront.net/38029526/original_e141e42e930bcc010214eaddaa87222d.jpg?1752184858&bc=0"/>
      <img alt="" data-src="https://d2w9rnfcy7mm78.cloudfront.net/38029065/original_4f9cd38172ebf608aba3bdf4cde8dbdd.jpg?1752183404&bc=0"/>
      <video muted loop playsinline preload="none" data-src="https://attachments.are.na/38029479/51a54b5ed88d49310f98303da9d81377.mov?1752184717"></video>
      <img alt="" data-src="https://d2w9rnfcy7mm78.cloudfront.net/38029310/original_980215c234f48d7c0ecfd74acccdd07c.jpg?1752184199&bc=0"/>
      <img alt="" data-src="https://d2w9rnfcy7mm78.cloudfront.net/38029306/original_63036ac71993e962e9701801d37e9a9b.jpg?1752184196&bc=0"/>
      <img alt="" data-src="https://d2w9rnfcy7mm78.cloudfront.net/38029522/original_fc49d4c595fec3f3769bf235fa116d2d.png?1752184840&bc=0"/>
      <video muted loop playsinline preload="none" data-src="https://attachments.are.na/38029066/b88d096a5dcffba1eb922cba46b7fa27.mov?1752183405"></video>
      <img alt="" data-src="https://d2w9rnfcy7mm78.cloudfront.net/38029524/original_37675df1822eca5b1ec28d3e8df188fa.png?1752184848&bc=0"/>
      <img alt="" data-src="https://d2w9rnfcy7mm78.cloudfront.net/38029529/original_9d6908ca7a8a3e6a89a1492fd4499c28.jpg?1752184864&bc=0"/>
      <img alt="" data-src="https://d2w9rnfcy7mm78.cloudfront.net/38029062/original_136f026e2847b72a83d20ab88a090049.jpg?1752183401&bc=0"/>
      <img alt="" data-src="https://d2w9rnfcy7mm78.cloudfront.net/38029061/original_7627c13569114443cb23dc40f1f47fff.jpg?1752183400&bc=0"/>
      <img alt="" data-src="https://d2w9rnfcy7mm78.cloudfront.net/38029311/original_9cffb18cbf52c14e9a010d3040181b8b.jpg?1752184200&bc=0"/>
    </div>

    <!-- PDF -->
    <div class="pdf-embed">
      <iframe loading="lazy" title="mdtc.4 — planos" data-src="https://attachments.are.na/38029628/56538178c853b0114f35557bb16f250e.pdf?1752185245"></iframe>
    </div>
  </div>

  <!-- ===== scripts ===== -->
  <script>
    // idioma: usa atributos [lang] existentes
    function setLang(lang){
      try{
        localStorage.setItem('lang',lang);
        document.documentElement.setAttribute('lang',lang);
        document.querySelectorAll('.description[lang]').forEach(el=>{
          el.classList.toggle('active', el.getAttribute('lang')===lang);
        });
        document.querySelectorAll('.language-selector button').forEach(btn=>{
          const on = btn.dataset.lang===lang;
          btn.classList.toggle('active', on);
          btn.setAttribute('aria-pressed', on?'true':'false');
        });
      }catch{}
    }
    (function initLang(){
      document.querySelectorAll('.language-selector button').forEach(b=> b.dataset.lang=b.textContent.trim());
      const saved = localStorage.getItem('lang') || (navigator.language||'es').slice(0,2);
      setLang(saved);
      document.querySelectorAll('.language-selector button').forEach(btn=>{
        btn.addEventListener('click', ()=> setLang(btn.dataset.lang));
      });
    })();

    // normaliza urls '?ts?bc=0' -> '?ts&bc=0'
    function fixUrl(u){ return typeof u==='string' ? u.replace(/\?(\d+)\?bc=0$/,'?$1&bc=0') : u; }

    // lazy: img/video/iframe con data-src
    (function lazy(){
      const io = new IntersectionObserver((es)=>{
        es.forEach(en=>{
          if(!en.isIntersecting) return;
          const el=en.target, src=fixUrl(el.dataset.src||'');
          if(!src){ io.unobserve(el); return; }
          if(el.tagName==='VIDEO'){
            el.src = src; // para .mov o .mp4 directos
            el.load();
          }else{
            el.src = src;
          }
          el.removeAttribute('data-src');
          io.unobserve(el);
        });
      },{rootMargin:'600px 0px',threshold:0});
      document.querySelectorAll('img[data-src],video[data-src],iframe[data-src]').forEach(el=> io.observe(el));
    })();

    // autoplay/pause en viewport para videos de galería
    (function videoVisibility(){
      const reduce = matchMedia('(prefers-reduced-motion: reduce)').matches;
      const io = new IntersectionObserver((es)=>{
        es.forEach(async en=>{
          const v=en.target;
          if(en.isIntersecting){ try{ await v.play(); }catch{} }
          else { try{ v.pause(); }catch{} }
        });
      },{rootMargin:'200px 0px',threshold:.25});
      document.querySelectorAll('.gallery video').forEach(v=>{
        if(!reduce) io.observe(v);
      });
      document.addEventListener('visibilitychange',()=>{
        const vids=document.querySelectorAll('.gallery video');
        if(document.hidden){ vids.forEach(v=>{try{v.pause();}catch{}}); }
        else if(!reduce){ vids.forEach(v=>{ try{v.play();}catch{} }); }
      });
    })();

    // lightbox preservado
    (function(){
      const lb=document.getElementById("xpan-lightbox"), sheet=lb.querySelector(".sheet");
      let items=[], idx=-1, t0=0, x0=0;
      function collect(){ items=[...document.querySelectorAll("img,video")].filter(el=>!el.closest("#xpan-lightbox")&&!el.closest("a")&&(el.currentSrc||el.src));}
      function openAt(i){
        if(i<0||i>=items.length) return; idx=i; sheet.innerHTML="";
        const srcEl=items[idx], isV=srcEl.tagName.toLowerCase()==="video"; const el=document.createElement(isV?"video":"img");
        if(isV){ el.src=srcEl.currentSrc||srcEl.src; el.playsInline=true; el.controls=true; el.loop=!!srcEl.loop; el.muted=srcEl.muted??true; el.autoplay=true; }
        else { el.src=srcEl.currentSrc||srcEl.src; el.decoding="async"; el.loading="eager"; el.alt=""; }
        sheet.appendChild(el); lb.classList.add("open"); document.documentElement.classList.add("lb-open"); document.body.classList.add("lb-open");
      }
      function close(){ lb.classList.remove("open"); sheet.innerHTML=""; document.documentElement.classList.remove("lb-open"); document.body.classList.remove("lb-open"); idx=-1; }
      function openFrom(el){ collect(); const i=items.indexOf(el); if(i>-1) openAt(i); }
      document.body.addEventListener("click",e=>{ const el=e.target; if(!el) return; if(el.closest("a")) return;
        if(el.tagName==="IMG"||el.tagName==="VIDEO"){ e.preventDefault(); e.stopPropagation(); openFrom(el); }
      },{capture:true});
      lb.addEventListener("click",e=>{ if(e.target===lb) close(); });
      window.addEventListener("keydown",e=>{ if(!lb.classList.contains("open")) return;
        if(e.key==="Escape") return close();
        if((e.key==="ArrowRight"||e.key==="l") && idx<items.length-1) return openAt(idx+1);
        if((e.key==="ArrowLeft"||e.key==="h") && idx>0) return openAt(idx-1);
      });
      lb.addEventListener("touchstart",e=>{ t0=Date.now(); x0=e.touches[0].clientX; },{passive:true});
      lb.addEventListener("touchend",e=>{ const dx=e.changedTouches[0].clientX-x0, dt=Date.now()-t0;
        if(Math.abs(dx)>50 && dt<600){ if(dx<0 && idx<items.length-1) openAt(idx+1); else if(dx>0 && idx>0) openAt(idx-1); } else { close(); }
      },{passive:true});
      new MutationObserver(()=>collect()).observe(document.documentElement,{subtree:true,childList:true});
      collect();
    })();

    // reproductor de audio con visualizador (preservado y normalizado)
    (function(){
      let globalAudioContext=null;
      document.querySelectorAll('.audio-local').forEach((block, index, allBlocks)=>{
        const audio = block.querySelector('audio');
        const button = block.querySelector('.play-button');
        const fill = block.querySelector('.progress-fill');
        const canvas = block.querySelector('canvas');
        const ctx = canvas.getContext('2d');
        const timeDisplay = block.querySelector('.time-display');
        const progressContainer = block.querySelector('.progress-container');

        const tooltip = document.createElement('div');
        tooltip.className = 'tooltip';
        progressContainer.appendChild(tooltip);

        let audioContext=null, source, analyser, dataArray, animationId;

        const formatTime = (s)=>{ const m=Math.floor(s/60), ss=Math.floor(s%60); return `${m}:${ss<10?'0':''}${ss}`; };
        const resizeCanvas = ()=>{ canvas.width=canvas.clientWidth; canvas.height=canvas.clientHeight; };

        const draw = ()=>{
          if(!analyser) return;
          analyser.getByteTimeDomainData(dataArray);
          ctx.clearRect(0,0,canvas.width,canvas.height);
          ctx.beginPath();
          const slice = canvas.width / dataArray.length; let x=0;
          for(let i=0;i<dataArray.length;i++){
            const v=dataArray[i]/128.0; const y=(v*canvas.height)/2;
            i===0?ctx.moveTo(x,y):ctx.lineTo(x,y); x+=slice;
          }
          ctx.strokeStyle = getComputedStyle(document.body).color; // usa color actual
          ctx.lineWidth = 1; ctx.stroke();
          animationId = requestAnimationFrame(draw);
        };

        function stopOthers(){
          document.querySelectorAll('.audio-local audio').forEach(a=>{ if(a!==audio) { try{ a.pause(); }catch{} } });
        }

        function setupVisualizer(){
          if(globalAudioContext && globalAudioContext.state!=='closed'){ try{ globalAudioContext.close(); }catch{} }
          audioContext = new (window.AudioContext||window.webkitAudioContext)();
          globalAudioContext = audioContext;
          source = audioContext.createMediaElementSource(audio);
          analyser = audioContext.createAnalyser();
          analyser.fftSize = 2048;
          dataArray = new Uint8Array(analyser.fftSize);
          source.connect(analyser);
          analyser.connect(audioContext.destination);
          resizeCanvas(); draw();
        }

        async function playAudio(){
          stopOthers();
          if(!audioContext) setupVisualizer();
          else if(audioContext.state==='suspended'){ await audioContext.resume(); animationId = requestAnimationFrame(draw); }
          else { animationId = requestAnimationFrame(draw); }
          try{ await audio.play(); }catch{}
          button.textContent='pause';
        }

        function pauseAudio(){
          audio.pause(); button.textContent='play';
          cancelAnimationFrame(animationId);
        }

        button.addEventListener('click', ()=>{ audio.paused ? playAudio() : pauseAudio(); });

        audio.addEventListener('timeupdate', ()=>{
          const d=audio.duration||0, ct=audio.currentTime||0;
          if(d>0){ fill.style.width = (ct/d)*100 + '%'; timeDisplay.textContent = `${formatTime(ct)} / ${formatTime(d)}`; }
        });

        audio.addEventListener('ended', ()=>{
          button.textContent='play'; fill.style.width='0%'; cancelAnimationFrame(animationId);
          const next = allBlocks[index+1]; if(next) next.querySelector('.play-button')?.click();
        });

        function seek(e){
          const r=progressContainer.getBoundingClientRect();
          const clientX = e.touches?.[0]?.clientX ?? e.clientX;
          const x = clientX - r.left; const p = Math.max(0,Math.min(1,x/r.width));
          audio.currentTime = p*(audio.duration||0);
        }
        function showTip(e){
          const r=progressContainer.getBoundingClientRect();
          const clientX = e.touches?.[0]?.clientX ?? e.clientX;
          const x = clientX - r.left; const p = Math.max(0,Math.min(1,x/r.width));
          const t = p*(audio.duration||0);
          tooltip.textContent = formatTime(t);
          tooltip.style.left = `${x}px`; tooltip.style.display='block';
        }
        function hideTip(){ tooltip.style.display='none'; }

        progressContainer.addEventListener('click', seek);
        progressContainer.addEventListener('mousemove', showTip);
        progressContainer.addEventListener('mouseleave', hideTip);
        progressContainer.addEventListener('touchstart', e=>{ seek(e); showTip(e); }, {passive:true});
        progressContainer.addEventListener('touchmove', showTip, {passive:true});
        progressContainer.addEventListener('touchend', hideTip);

        window.addEventListener('resize', resizeCanvas, {passive:true});
        resizeCanvas();
      });
    })();
  </script>
</body>
</html>
