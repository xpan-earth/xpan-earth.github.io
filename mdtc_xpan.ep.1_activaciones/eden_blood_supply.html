<!DOCTYPE html>
<html lang="es">
<head>
<meta charset="utf-8"/>
<meta content="width=device-width, initial-scale=1.0" name="viewport"/>
<title>eden blood supply — xpan — mdtc</title>

<link rel="preconnect" href="https://d2w9rnfcy7mm78.cloudfront.net" crossorigin>
<link rel="preconnect" href="https://attachments.are.na" crossorigin>

<style>
  :root{
    --bg:#ffffff; --fg:#0a0a0a; --line:rgba(0,0,0,.10);
    --radius:14px; --gap:.8rem; --gap-lg:1rem;
    --ease:cubic-bezier(.22,.61,.36,1);
    --tile-max-h:72vh;
    --aei-block:140px;
  }
  *{ box-sizing:border-box; }
  html,body{ margin:0; padding:0; background:var(--bg); color:var(--fg); font-family:"Times New Roman", serif; }
  a{ color:inherit; text-decoration:none; }
  img,video{ display:block; max-width:100%; height:auto; }
  body{ overflow-x:hidden; }

  header{ position:fixed; top:1rem; left:1rem; z-index:30; }
  header img{ width:50px; height:auto; display:block; }

  main{ max-width:1440px; margin:124px auto 5rem; padding:0 1.25rem; }

  .sr-only{ position:absolute !important; height:1px; width:1px; overflow:hidden; clip:rect(1px,1px,1px,1px); white-space:nowrap; }

  .info{ margin:0 0 1.6rem; }
  .info .title{ font-size:clamp(1.2rem,2.2vw,1.6rem); margin:0 0 .25rem; text-transform:lowercase; letter-spacing:.01em; }
  .info .meta{ font-size:.96rem; opacity:.85; font-style:italic; }

  .section{ margin:2.2rem 0; content-visibility:auto; contain-intrinsic-size:1px 800px; padding-top:1.2rem; border-top:1px solid var(--line); }
  .grid{ display:grid; gap:var(--gap); }
  .grid.uniform-3{ grid-template-columns: repeat(3, 1fr); }
  @media (max-width:1100px){ .grid.uniform-3{ grid-template-columns: repeat(2, 1fr); } }
  @media (max-width:640px){ .grid.uniform-3{ grid-template-columns: 1fr; } }

  .card{ background:#fff; border:1px solid var(--line); border-radius:var(--radius); overflow:hidden; opacity:0; transform:translateY(6px); transition:opacity .38s var(--ease), transform .5s var(--ease); }
  .card.ready{ opacity:1; transform:none; }
  .frame{ position:relative; background:#fff; }
  .frame::before{ content:""; display:block; aspect-ratio:var(--ar, 16/9); max-height:var(--tile-max-h); }
  .frame > *{ position:absolute; inset:0; width:100%; height:100%; object-fit:contain; background:#fff; }

  .tight-wrap{ border:1px solid var(--line); border-radius:var(--radius); overflow:hidden; }
  .tight-grid{ display:grid; gap:0 !important; }
  .tight-grid.cols-5{ grid-template-columns: repeat(5, 1fr); }
  @media (max-width:1100px){ .tight-grid.cols-5{ grid-template-columns: repeat(4, 1fr); } }
  @media (max-width:640px){ .tight-grid.cols-5{ grid-template-columns: repeat(2, 1fr); } }

  .tight-item{ position:relative; background:#fff; }
  .tight-item .media-box{ position:relative; }
  .tight-item .media-box::before{ content:""; display:block; aspect-ratio:var(--ar, 4/3); }
  .tight-item .media-box > *{ position:absolute; inset:0; width:100%; height:100%; object-fit:cover; background:#fff; }

  /* images15 vertical por defecto */
  [data-section="images15"] .media-box::before{ aspect-ratio:9/16; }

  /* lightbox */
  .lightbox{position:fixed;inset:0;background:rgba(255,255,255,.98);display:none;align-items:center;justify-content:center;z-index:50}
  .lightbox.open{display:flex}
  .lb-surface{position:relative;max-width:92vw;max-height:92vh;background:#fff;border:1px solid var(--line);border-radius:var(--radius);box-shadow:0 12px 40px rgba(0,0,0,.08);overflow:hidden}
  .lb-media{display:block;width:100%;height:100%;object-fit:contain;background:#fff;touch-action:manipulation}

  /* iOS/Safari: asegurar render */
  @supports (-webkit-touch-callout: none){
    .section{ content-visibility:visible; contain-intrinsic-size:auto; }
  }
  @media (max-width:640px){
    .card{ opacity:1; transform:none; }
  }
</style>
</head>
<body>
<header>
  <a href="../" aria-label="xpan"><img src="../xpan.svg" alt="xpan" fetchpriority="high"></a>
</header>

<main>
  <section class="info" aria-label="información">
    <h1 class="sr-only">eden blood supply</h1>
    <div class="title">eden blood supply</div>
    <div class="meta">17 de diciembre de 2024</div>
  </section>

  <!-- walkthrough / heroVideo -->
  <section class="section" id="recorridos" data-lazy-section>
    <h2 class="sr-only">recorridos</h2>
    <div class="grid uniform-3" data-section="walkthrough"></div>
  </section>

  <!-- retícula 15 (imágenes) -->
  <section class="section" id="img15" data-lazy-section>
    <h2 class="sr-only">retícula — 15 imágenes</h2>
    <div class="tight-wrap">
      <div class="tight-grid cols-5" data-section="images15" data-initial="15"></div>
    </div>
  </section>
</main>

<!-- lightbox -->
<div class="lightbox" id="lightbox" role="dialog" aria-modal="true">
  <div class="lb-surface">
    <figure id="lbFigure" style="margin:0"></figure>
  </div>
</div>

<script>
/* ===== media ===== */
const media = {
  walkthrough: [
    "https://attachments.are.na/38748974/c40fd9380617d2d999265d969b8aceb3.mp4?1755035781",
    "https://attachments.are.na/38748969/2c8b22530334939ac5e12164156be1e7.mov?1755035769"
  ],
  images15: [
    "https://d2w9rnfcy7mm78.cloudfront.net/38748990/original_58099ccd2ed6d7e2b1afcd1702f4db7d.jpg?1755035825?bc=0",
    "https://d2w9rnfcy7mm78.cloudfront.net/38748991/original_6ae1b9fef4f13e2873fd03f6a12d0b34.jpg?1755035825?bc=0",
    "https://d2w9rnfcy7mm78.cloudfront.net/38748993/original_20221d4695ccdf7b1b4261588f91da66.jpg?1755035826?bc=0",
    "https://d2w9rnfcy7mm78.cloudfront.net/38748994/original_8cf258f36b24f5e24048c33b102c8cac.jpg?1755035826?bc=0",
    "https://d2w9rnfcy7mm78.cloudfront.net/38748992/original_51ee839f5f9129032a0d39917b5d8236.jpg?1755035826?bc=0",
    "https://d2w9rnfcy7mm78.cloudfront.net/38748995/original_3812bc9c86db9e71b29de89b43dbe0b3.jpg?1755035826?bc=0",
    "https://d2w9rnfcy7mm78.cloudfront.net/38748996/original_27dcf1e74e214f3d4902904b5708e8ab.jpg?1755035826?bc=0",
    "https://d2w9rnfcy7mm78.cloudfront.net/38748997/original_ce1dbef43bb9e7311c3fdaf4f8b417e8.jpg?1755035826?bc=0",
    "https://d2w9rnfcy7mm78.cloudfront.net/38748998/original_7528278cde3a106dc2cbbb18ba709321.jpg?1755035826?bc=0",
    "https://d2w9rnfcy7mm78.cloudfront.net/38749001/original_d56c6b3348478552a716421f00ba07d1.jpg?1755035828?bc=0",
    "https://d2w9rnfcy7mm78.cloudfront.net/38749002/original_7e633a849d80c030fa28390d580a56d5.jpg?1755035829?bc=0",
    "https://d2w9rnfcy7mm78.cloudfront.net/38749003/original_5f0cdbe94b421cf952e291d1d22d6822.jpg?1755035829?bc=0",
    "https://d2w9rnfcy7mm78.cloudfront.net/38749004/original_f730998e0fcdcceda75c737220c39fc9.jpg?1755035830?bc=0",
    "https://d2w9rnfcy7mm78.cloudfront.net/38749061/original_840152698e89031589ecd5e31c92ee5d.jpg?1755036031?bc=0",
    "https://d2w9rnfcy7mm78.cloudfront.net/38749063/original_b8e7da0a4f072d4e6269e5cbc8e16fc4.jpg?1755036031?bc=0"
  ]
};

/* ===== utils ===== */
const $$ = (sel, ctx=document)=> Array.from(ctx.querySelectorAll(sel));
const BLANK_POSTER = 'data:image/svg+xml;utf8,<svg xmlns="http://www.w3.org/2000/svg" width="16" height="9" viewBox="0 0 16 9"><rect width="16" height="9" fill="white"/></svg>';

function wireVideoEl(v,{autoplay=true}={}){
  v.muted = true;
  v.loop = true;
  v.autoplay = !!autoplay;
  v.playsInline = true;
  v.setAttribute('muted','');
  v.setAttribute('playsinline','');
  v.setAttribute('webkit-playsinline','');
  v.poster = BLANK_POSTER;
  v.preload = /^((?!chrome|android).)*safari/i.test(navigator.userAgent) ? 'metadata' : 'none';
  if(autoplay) v.setAttribute('autoplay','');
}

function setArOnBoxFromWH(box,w,h){
  if(!box) return;
  const W = w || 16, H = h || 9;
  box.style.setProperty('--ar', `${W}/${H}`);
}
function setAspectFromVideo(v){
  const box = v.closest('.frame, .media-box');
  if(!box) return;
  setArOnBoxFromWH(box, v.videoWidth, v.videoHeight);
}

/* ===== loader limitado ===== */
const MAX_CONCURRENT = 4;
let activeLoads = 0;
const loadQueue = [];
function scheduleVideoLoad(el, url){ loadQueue.push({el,url}); pumpLoads(); }
function pumpLoads(){
  while(activeLoads<MAX_CONCURRENT && loadQueue.length){
    const {el,url}=loadQueue.shift();
    activeLoads++;
    el.src=url;
    el.preload='auto';
    const done=()=>{ activeLoads--; pumpLoads(); };
    el.addEventListener('loadedmetadata',done,{once:true});
    el.addEventListener('error',done,{once:true});
    el.load();
  }
}

/* ===== IO diferido para videos NO-eager ===== */
const ioLoad=new IntersectionObserver((entries,obs)=>{
  entries.forEach(en=>{
    if(!en.isIntersecting) return;
    const v=en.target;
    if(v.dataset.src && !v.src){
      scheduleVideoLoad(v, v.dataset.src);
      const markReady = () => {
        const c = v.closest('.card, .tight-item');
        if (!c || c.classList.contains('ready')) return;
        setAspectFromVideo(v);
        c.classList.add('ready');
      };
      v.addEventListener('loadedmetadata', markReady, { once:true });
      v.addEventListener('loadeddata',    markReady, { once:true });
      v.addEventListener('canplay',       markReady, { once:true });
      v.addEventListener('canplaythrough',markReady, { once:true });
      v.addEventListener('error',         markReady, { once:true });
      setTimeout(markReady, 1600);
    }
    obs.unobserve(v);
  });
},{rootMargin:'600px 0px', threshold:.08});

/* ===== autoplay en viewport ===== */
function autoPlayOnVisible(video){
  function tryPlay(){ video.play().catch(()=>{}); }
  const vio=new IntersectionObserver((ents)=>{
    ents.forEach(en=>{ if(en.isIntersecting){ video.muted=true; video.setAttribute('muted',''); tryPlay(); } else { video.pause(); } });
  },{threshold:.12});
  vio.observe(video);
  const t0=Date.now(); (function tick(){ if(!video.paused || Date.now()-t0>4000) return; tryPlay(); setTimeout(tick,300); })();
  document.addEventListener('visibilitychange',()=>{ if(document.visibilityState==='visible') tryPlay(); });
}

/* ===== creación de tarjetas ===== */
function makeVideo(url,{tight=false, eager=false}={}){
  const container=tight?document.createElement('div'):document.createElement('figure');
  container.className=tight?'tight-item':'card';
  const box=document.createElement('div'); box.className=tight?'media-box':'frame';
  container.appendChild(box);

  const v=document.createElement('video');
  wireVideoEl(v,{autoplay:true});
  v.controls=false;
  box.appendChild(v);

  // altura inmediata para evitar colapso antes de metadata
  setArOnBoxFromWH(box,16,9);

  const markReady=()=>{
    setAspectFromVideo(v);
    if(!container.classList.contains('ready')) container.classList.add('ready');
  };
  v.addEventListener('loadedmetadata', markReady, {once:true});
  v.addEventListener('loadeddata',    markReady, {once:true});
  v.addEventListener('canplay',       markReady, {once:true});
  setTimeout(markReady, 1600);

  if(eager){
    v.preload='auto';
    v.src=url;
    v.load();
    // dar visibilidad inicial inmediata
    container.classList.add('ready');
  }else{
    v.dataset.src=url;
    ioLoad.observe(v);
  }

  autoPlayOnVisible(v);
  if(!tight){ container.addEventListener('click', ()=> openLightboxSingle({type:'video', url})); }
  return container;
}

/* ===== render ===== */
(function render(){
  const walkthroughWrap=document.querySelector('[data-section="walkthrough"]');
  (media.walkthrough||[]).forEach(u=> walkthroughWrap.appendChild(makeVideo(u,{eager:true})));

  const wrapImages=document.querySelector('[data-section="images15"]');
  (media.images15||[]).forEach(url=>{
    const item=document.createElement('div'); item.className='tight-item';
    const box=document.createElement('div'); box.className='media-box'; item.appendChild(box);
    const img=document.createElement('img'); img.alt=''; img.decoding='async'; img.loading='lazy'; img.src=url;
    box.appendChild(img);
    img.addEventListener('load',()=> setArOnBoxFromWH(box, img.naturalWidth, img.naturalHeight),{once:true});
    wrapImages.appendChild(item);
  });
})();

/* ===== lightbox ===== */
const lb=document.getElementById('lightbox');
const lbFigure=document.getElementById('lbFigure');
let galleryItems=[], galleryIndex=0;

function openLightbox(items, index=0){
  galleryItems=items||[];
  galleryIndex=Math.max(0, Math.min(index, galleryItems.length-1));
  lbFigure.innerHTML='';
  renderLB();
  lb.classList.add('open');
  document.documentElement.style.overflow = 'hidden';
}
function openLightboxGroup(key, index){
  const arr=(media[key]||[]).map(url=>({type:/\.(mp4|mov)(\?|$)/i.test(url)?'video':'img', url}));
  openLightbox(arr, index);
}
function openLightboxSingle(item){ openLightbox([item], 0); }

function renderLB(){
  const item=galleryItems[galleryIndex]; if(!item) return;
  lbFigure.innerHTML='';
  const el=document.createElement(item.type==='img'?'img':'video');
  el.className='lb-media';
  if(item.type==='img'){
    el.alt=''; el.decoding='async'; el.loading='eager'; el.src=item.url;
  }else{
    el.controls=false; el.playsInline=true; el.setAttribute('playsinline',''); el.setAttribute('webkit-playsinline','');
    el.loop=true; el.preload='auto'; el.src=item.url;
    el.addEventListener('loadedmetadata',()=>{ el.play().catch(()=>{}); },{once:true});
  }
  lbFigure.appendChild(el);
}
function closeLightbox(){ lb.classList.remove('open'); lbFigure.innerHTML=''; document.documentElement.style.overflow=''; }
function nextLB(){ if(!galleryItems.length) return; galleryIndex=(galleryIndex+1)%galleryItems.length; renderLB(); }
function prevLB(){ if(!galleryItems.length) return; galleryIndex=(galleryIndex-1+galleryItems.length)%galleryItems.length; renderLB(); }

/* abrir grupo imágenes */
(function wireGallery(){
  const wrap=document.querySelector('[data-section="images15"]'); if(!wrap) return;
  wrap.addEventListener('click', e=>{
    const item=e.target.closest('.tight-item'); if(!item) return;
    const items=Array.from(wrap.querySelectorAll('.tight-item'));
    const index=items.indexOf(item); if(index<0) return;
    openLightboxGroup('images15', index);
  });
})();

/* cerrar lightbox */
const lightboxEl=document.getElementById('lightbox');
lightboxEl.addEventListener('click', e=>{
  const inside = e.target.closest('#lbFigure');
  if(inside || e.target===lightboxEl) closeLightbox();
});
window.addEventListener('keydown', e=>{
  if(!lightboxEl.classList.contains('open')) return;
  if(e.key==='Escape') return closeLightbox();
  if(e.key===' ' || e.key==='Spacebar' || e.key==='ArrowRight') return nextLB();
  if(e.key==='ArrowLeft') return prevLB();
});

/* pausa fuera de viewport */
const pauseIO=new IntersectionObserver((ents)=>{
  ents.forEach(en=>{ const v=en.target; if(!en.isIntersecting) v.pause(); else v.play().catch(()=>{}); });
},{threshold:.05});
const watch=setInterval(()=>{
  document.querySelectorAll('video').forEach(v=> pauseIO.observe(v));
  if(document.querySelectorAll('video').length>0) clearInterval(watch);
},160);

/* iOS unlock: primer gesto */
function unlockAllVideos(){
  document.removeEventListener('click', unlockAllVideos);
  document.removeEventListener('touchstart', unlockAllVideos);
  $$('video').forEach(v=>{
    if(!v.src && v.dataset.src){ v.src=v.dataset.src; v.load(); }
    v.muted=true; v.setAttribute('muted',''); v.play().catch(()=>{});
  });
}
document.addEventListener('click', unlockAllVideos, { once:true });
document.addEventListener('touchstart', unlockAllVideos, { once:true, passive:true });
</script>

<script src="../assets/js/video-autoplay-mobile.js" defer></script>

<!-- fallback global mínimo -->
<script>
(function(){
  function markReady(v){
    const box = v.closest('.frame, .media-box');
    if(box){
      const w = v.videoWidth || 16, h = v.videoHeight || 9;
      box.style.setProperty('--ar', `${w}/${h}`);
    }
    const c = v.closest('.card, .tight-item');
    if(c) c.classList.add('ready');
  }
  function wire(v){
    if(v.dataset._wired) return;
    v.dataset._wired='1';
    v.addEventListener('loadedmetadata', ()=>markReady(v), {once:true});
    v.addEventListener('loadeddata',    ()=>markReady(v), {once:true});
    v.addEventListener('canplay',       ()=>markReady(v), {once:true});
    setTimeout(()=>markReady(v), 1800);
  }
  function init(){
    document.querySelectorAll('video').forEach(wire);
    const mo = new MutationObserver(()=>document.querySelectorAll('video').forEach(wire));
    mo.observe(document.documentElement, {subtree:true, childList:true});
  }
  if(document.readyState==='loading') document.addEventListener('DOMContentLoaded', init);
  else init();
})();
</script>
<script>
(() => {
  const LB = document.getElementById('lightbox');            // contenedor de la galería
  const LBF = document.getElementById('lbFigure');            // figura donde insertas el <video>
  if (!LB || !LBF) return;

  // 0) Desbloqueo de audio en iOS con el mismo gesto
  let unlocked=false, AC;
  function unlock(){ if(unlocked) return;
    try{ AC=AC||new (window.AudioContext||window.webkitAudioContext)(); AC.resume&&AC.resume(); }catch(e){}
    unlocked=true;
  }

  // 1) Al hacer click en cualquier tile (captura antes de tu handler):
  //    espera a que la galería se abra y el <video> exista, luego desmutea+play
  document.addEventListener('click', (e) => {
    unlock(); // mismo gesto del usuario
    const wasClosed = !LB.classList.contains('open');
    // doble rAF para dejar que tu código pinte el lightbox y su <video>
    requestAnimationFrame(() => requestAnimationFrame(() => {
      if (wasClosed && LB.classList.contains('open')) {
        const v = LBF.querySelector('video');
        if (!v) return;
        v.muted = false; v.removeAttribute('muted'); v.volume = 1;
        v.setAttribute('playsinline',''); v.setAttribute('webkit-playsinline','');
        const play = () => v.play().catch(()=>{});
        play(); v.addEventListener('loadeddata', play, { once:true });
      }
    }));
  }, { capture:true });

  // 2) Si cambias de item dentro de la galería (siguiente/anterior),
  //    re-aplica audio al nuevo <video> insertado
  new MutationObserver(() => {
    const v = LBF.querySelector('video'); if (!v || !unlocked) return;
    v.muted = false; v.removeAttribute('muted'); v.volume = 1;
    const play = () => v.play().catch(()=>{});
    play(); v.addEventListener('loadeddata', play, { once:true });
  }).observe(LBF, { childList:true, subtree:true });

  // 3) Al cerrar la galería: solo mute, NO pause (retículas siguen)
  document.addEventListener('click', (e) => {
    if (e.target === LB || e.target.closest('.lb-close,.gallery-back,[data-close-gallery]')) {
      const v = LBF.querySelector('video'); if (v) v.muted = true; // no pause
    }
  });
})();
</script>
<script>(function(){const IMG_SEL='img[src*="cloudfront.net"]',PFX='https://images.weserv.nl/?url=',CFG='&q=70&we',W=[480,960,1600];function prox(u,w){if(!/^https?:\/\//i.test(u))return null;const c=u.replace(/^https?:\/\//,'');return`${PFX}${encodeURIComponent(c)}&w=${w}${CFG}`}function tuneImg(img){const o=img.getAttribute('src');if(!o)return;if(img.hasAttribute('srcset')||img.hasAttribute('data-no-proxy'))return;const m=prox(o,W[1]);if(!m)return;img.setAttribute('data-full',o);img.loading='lazy';img.decoding='async';img.src=m;img.srcset=`${prox(o,W[0])} 480w, ${m} 960w, ${prox(o,W[2])} 1600w`;img.sizes='(max-width:600px) 480px, (max-width:1200px) 960px, 1600px'}function prepareVideoLazy(){const vids=new Set;document.querySelectorAll('video[src*="attachments.are.na"]').forEach(v=>{v.setAttribute('data-src',v.src);v.removeAttribute('src');v.preload='metadata';v.playsInline=!0;vids.add(v)});document.querySelectorAll('video source[src*="attachments.are.na"]').forEach(s=>{const v=s.parentElement;s.setAttribute('data-src',s.src);s.removeAttribute('src');v.preload='metadata';v.playsInline=!0;vids.add(v)});const io=new IntersectionObserver(es=>{es.forEach(e=>{if(!e.isIntersecting)return;const v=e.target;if(!v.src&&v.dataset.src){v.src=v.dataset.src}v.querySelectorAll('source[data-src]').forEach(s=>{if(!s.src)s.src=s.dataset.src});v.load();io.unobserve(v)})},{rootMargin:'200px'});vids.forEach(v=>io.observe(v))}document.addEventListener('DOMContentLoaded',function(){document.querySelectorAll(IMG_SEL).forEach(tuneImg);prepareVideoLazy()})})();</script>

</body>
</html>
