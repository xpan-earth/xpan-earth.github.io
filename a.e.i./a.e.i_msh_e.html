<!DOCTYPE html>
<html lang="es" data-xpan>
<head>
  <meta charset="utf-8"/>
  <meta name="viewport" content="width=device-width, initial-scale=1, viewport-fit=cover"/>
  <meta name="color-scheme" content="light dark"/>
  <title>a.e.i_msh_e</title>

  <!-- orígenes ya usados en xpan -->
  <link rel="preconnect" href="https://d2w9rnfcy7mm78.cloudfront.net" crossorigin>
  <link rel="preconnect" href="https://attachments.are.na" crossorigin>

  <style>
    /* ================== tokens post-tech / defense-ops ================== */
    [data-xpan]{
      --bg:#0C0D0F; --fg:#E0E3E6; --fg-dim:#AEB4BA;
      --line:#2A2E31; --line-weak:#151A1F;
      --accent:#1860FF; --accent-2:#8CFF4D; --alert:#F9A800; --danger:#FF3666;

      /* layout base */
      --maxw:1440px;
      --pad:clamp(12px,4vw,48px);
      --header-h:clamp(52px, 6svh, 72px);

      /* tamaño de bloque: fluido por viewport */
      --aei-block:clamp(88px, 12vw, 180px);

      --ease:cubic-bezier(.22,.61,.36,1);
      --logo-invert:1;

      /* grid base */
      --grid:rgba(255,255,255,.05);
      --grid-strong:rgba(255,255,255,.10);
      --grid-cell:40px;
      --grid-cell-strong:200px;

      --scanline:rgba(0,0,0,.06);
      --corner:36px;
    }
    @media (prefers-color-scheme:light){
      [data-xpan]{
        --bg:#FFFFFF; --fg:#0E1113; --fg-dim:#4A5158;
        --line:#E6E8EA; --line-weak:#F3F5F7; --logo-invert:0;
        --grid:rgba(0,0,0,.05); --grid-strong:rgba(0,0,0,.10);
        --scanline:rgba(0,0,0,.035);
      }
    }

    /* container queries por ancho real del lienzo */
    .aei-embed{ container-type:inline-size; }
    @container (max-width: 520px){
      [data-xpan]{ --aei-block:clamp(72px, 22vw, 132px); --grid-cell:48px; --grid-cell-strong:220px; --corner:28px; }
    }
    @container (min-width: 1500px){
      [data-xpan]{ --aei-block:clamp(120px, 10vw, 220px); --grid-cell:48px; --grid-cell-strong:240px; }
    }

    *{ box-sizing:border-box; }
    html,body{ margin:0; height:100%; background:var(--bg); color:var(--fg); }
    a{ color:inherit; text-decoration:none; }
    img,video{ display:block; max-width:100%; height:auto; }
    body{
      font-family: Inter,-apple-system,BlinkMacSystemFont,"Segoe UI",Roboto,Helvetica,Arial,"Noto Sans",sans-serif;
      letter-spacing:-.2px; overflow-x:hidden;
      -webkit-tap-highlight-color:transparent;
      touch-action:manipulation;
      cursor:crosshair;
    }

    /* ================== header FLUSH ================== */
    header{
      position:fixed;
      top:env(safe-area-inset-top);
      left:env(safe-area-inset-left);
      z-index:40; display:flex; align-items:center;
      height:var(--header-h);
      padding:8px 10px;
      border:none; border-radius:0; background:transparent; backdrop-filter:none;
    }
    header img[alt="xpan"]{
      width:50px; height:auto; filter:invert(var(--logo-invert)) contrast(1) brightness(1);
    }

    /* ================== layout ================== */
    main{
      padding:calc(var(--header-h) + 16px + env(safe-area-inset-top)) var(--pad) calc(var(--pad) + env(safe-area-inset-bottom));
      margin:0 auto; max-width:var(--maxw);
    }

    .aei-embed{
      position:relative; width:100%;
      height:auto; min-height:100svh;
      background:var(--bg); border:1px solid var(--line); border-radius:12px; overflow:hidden;
      isolation:isolate;
    }
    .aei-stage{
      position:relative; width:100%; height:100%;
      touch-action:none; /* drag táctil preciso */
    }
    .aei-lines{ position:absolute; inset:0; width:100%; height:100%; pointer-events:none; }

    /* ================== HUD / grid / radar ================== */
    .hud-grid{
      position:absolute; inset:0; z-index:0; pointer-events:none;
      background:
        linear-gradient(transparent 49%, var(--scanline) 50%, transparent 51%) 0 0/100% 4px,
        linear-gradient(to right, var(--grid) 1px, transparent 1px) 0 0/var(--grid-cell) var(--grid-cell),
        linear-gradient(to bottom, var(--grid) 1px, transparent 1px) 0 0/var(--grid-cell) var(--grid-cell),
        linear-gradient(to right, var(--grid-strong) 1px, transparent 1px) 0 0/var(--grid-cell-strong) var(--grid-cell-strong),
        linear-gradient(to bottom, var(--grid-strong) 1px, transparent 1px) 0 0/var(--grid-cell-strong) var(--grid-cell-strong);
      mask-image: radial-gradient(120% 120% at 50% 50%, black 65%, transparent 100%);
      opacity:.9;
    }
    .hud-frame{
      position:absolute; inset:12px; pointer-events:none; z-index:2;
      border:1px solid color-mix(in oklab, var(--fg) 28%, transparent);
      border-radius:12px;
    }
    .hud-corners:before, .hud-corners:after{
      content:""; position:absolute; inset:0; pointer-events:none;
      background:
        conic-gradient(from 0deg at 0% 0%, color-mix(in oklab, var(--fg) 35%, transparent) 0 25%, transparent 0 100%) top left/var(--corner) var(--corner) no-repeat,
        conic-gradient(from 90deg at 100% 0%, color-mix(in oklab, var(--fg) 35%, transparent) 0 25%, transparent 0 100%) top right/var(--corner) var(--corner) no-repeat,
        conic-gradient(from 180deg at 100% 100%, color-mix(in oklab, var(--fg) 35%, transparent) 0 25%, transparent 0 100%) bottom right/var(--corner) var(--corner) no-repeat,
        conic-gradient(from 270deg at 0% 100%, color-mix(in oklab, var(--fg) 35%, transparent) 0 25%, transparent 0 100%) bottom left/var(--corner) var(--corner) no-repeat;
      opacity:.65;
    }
    .radar{
      position:absolute; inset:-10% -10%; z-index:1; pointer-events:none; opacity:.22;
      background:
        radial-gradient(circle at 50% 50%, transparent 0 46%, color-mix(in oklab, var(--fg) 16%, transparent) 47% 48%, transparent 49% 100%),
        conic-gradient(from 0deg, color-mix(in oklab, var(--accent) 24%, transparent) 0 8%, transparent 8% 100%);
      mix-blend-mode:soft-light;
      animation:radar-rotate 8s linear infinite;
    }
    @keyframes radar-rotate { to { transform:rotate(360deg)} }

    /* ================== bloques ================== */
    .aei-block{
      width:var(--aei-block); height:var(--aei-block);
      position:absolute; opacity:.78; transition:opacity .25s var(--ease), box-shadow .25s var(--ease);
      cursor:grab; user-select:none; display:flex; justify-content:center; align-items:center;
      touch-action:none; will-change:transform;
      border:1px solid var(--line-weak); background:transparent; border-radius:8px;
      box-shadow:0 0 0 0 rgba(24,96,255,0);
      outline:1px solid color-mix(in oklab, var(--fg) 8%, transparent);
    }
    .aei-block:hover{ opacity:.95; z-index:5; box-shadow:0 0 0 2px color-mix(in oklab, var(--accent) 36%, transparent); }
    .aei-block:active{ cursor:grabbing; }
    .aei-block img,.aei-block video{
      max-width:100%; max-height:100%; object-fit:contain; background:transparent; pointer-events:none;
    }

    @media (hover:none){
      .aei-block:hover{ box-shadow:none; }
    }

    /* ================== líneas ================== */
    .aei-lines line{
      stroke:var(--fg); stroke-width:.6; opacity:.0; shape-rendering:crispEdges;
      vector-effect:non-scaling-stroke;
    }
    .aei-lines line.fx{ animation:fadeLine .8s var(--ease) forwards; }
    @keyframes fadeLine{ 0%{opacity:0} 100%{opacity:.22} }

    .aei-hint{
      position:absolute; right:1rem; bottom:1rem; font-size:.8rem; opacity:.55;
      background:color-mix(in oklab, var(--bg) 85%, transparent);
      border:1px solid var(--line); padding:.35rem .5rem; border-radius:8px;
      user-select:none; backdrop-filter:blur(4px) saturate(120%);
    }

    /* ================== panel táctil + táctico ================== */
    .panel-toggle{
      position:absolute; top:12px; right:12px; z-index:60;
      display:none; padding:.35rem .55rem; border:1px solid var(--line); border-radius:8px;
      background:color-mix(in oklab, var(--bg) 82%, transparent); color:var(--fg-dim);
      font-size:.85rem; backdrop-filter:blur(6px) saturate(120%); -webkit-tap-highlight-color:transparent;
    }
    @media (hover:none){ .panel-toggle{ display:block; } }

    /* ===== panel táctico adaptable ===== */
    .tactical{
      position:absolute;
      top:calc(env(safe-area-inset-top) + 12px);
      right:calc(env(safe-area-inset-right) + 12px);
      z-index:50;
      display:none;
      gap:8px 10px;
      align-items:center;
      background:color-mix(in oklab, var(--bg) 82%, transparent);
      border:1px solid var(--line);
      border-radius:10px;
      padding:8px 10px;
      backdrop-filter:blur(6px) saturate(120%);
      font-size:.85rem; color:var(--fg-dim);

      max-width:min(92vw, 560px);
      max-height:calc(100svh - var(--header-h) - 24px - env(safe-area-inset-top) - env(safe-area-inset-bottom));
      overflow:auto;
      flex-wrap:wrap;
    }
    .tactical label{ display:flex; align-items:center; gap:8px; white-space:nowrap; width:100%; }
    .tactical input[type="range"]{ width:100%; accent-color:var(--accent); }
    .badge{
      display:inline-block; padding:.15rem .4rem; border:1px solid var(--line); border-radius:6px; font-variant-numeric:tabular-nums;
      background:color-mix(in oklab, var(--bg) 88%, transparent);
    }
    .tactical--stack{ display:flex; flex-direction:column; align-items:stretch; }
    @media (max-aspect-ratio: 3/4){
      .tactical{ max-width:92vw; }
    }

    @media (prefers-reduced-motion:reduce){
      .aei-block{ transition:none; }
      .radar{ animation:none; }
      .aei-lines line.fx{ animation:none; opacity:.22; }
    }

    /* ===== normalización global de LIGHTBOXES sin redondeo ===== */
    .lightbox, .lightbox * ,
    .media-lightbox, .media-lightbox *,
    .lb, .lb *, .modal, .modal *,
    [data-lightbox], [data-lightbox] * {
      border-radius:0 !important;
      overflow:visible;
    }
    :fullscreen img, :fullscreen video, :fullscreen canvas { border-radius:0 !important; }
    ::backdrop { background-color: rgba(0,0,0,.96); }

    /* low-power visuals */
    .aei-embed.lp .radar{ animation-duration:16s; opacity:.12; }
    .aei-embed.lp .hud-grid{ opacity:.6; }
  </style>

  <script src="/assets/js/media-proxy.js" defer></script>
</head>
<body>
  <header aria-label="xpan header">
    <a href="https://xpan.earth" aria-label="xpan">
      <img src="../xpan.svg" alt="xpan" fetchpriority="high">
    </a>
  </header>

  <main>
    <section class="aei-embed" id="aeiEmbed" aria-label="a.e.i">
      <!-- capas HUD -->
      <div class="hud-grid" aria-hidden="true"></div>
      <div class="radar" aria-hidden="true"></div>
      <div class="hud-frame hud-corners" aria-hidden="true"></div>

      <!-- escena y conexiones -->
      <svg class="aei-lines" id="aeiLines" aria-hidden="true"></svg>
      <div class="aei-stage" id="aeiStage" aria-label="escena a.e.i"></div>

      <!-- botón táctil del panel -->
      <button id="panelToggle" class="panel-toggle" aria-controls="tacticalPanel" aria-expanded="false" type="button">panel</button>

      <!-- panel táctico -->
      <div class="tactical" id="tacticalPanel" role="group" aria-label="panel táctico a.e.i">
        <span class="badge" id="statBlocks">blk:0</span>
        <span class="badge" id="statFPS">fps:0</span>
        <label>densidad
          <input id="densityRng" type="range" min="0" max="100" value="8" step="1" aria-label="densidad de líneas">
        </label>
        <label>vel
          <input id="speedRng" type="range" min="0" max="100" value="10" step="1" aria-label="velocidad de drift">
        </label>
        <button id="pauseBtn" type="button" class="badge" aria-pressed="false">pause</button>
        <button id="resetBtn" type="button" class="badge">reset</button>
      </div>

    </section>
  </main>

  <script>
    const $$ = (sel, ctx=document)=> Array.from(ctx.querySelectorAll(sel));
    const BLANK_POSTER = 'data:image/gif;base64,R0lGODlhAQABAAD/ACwAAAAAAQABAAACADs=';

    /* ================== viewport exacto ================== */
    function viewportH(){
      return (window.visualViewport && window.visualViewport.height) ? Math.round(window.visualViewport.height) : window.innerHeight;
    }
    function fitEmbedToViewport(){
      const embed = document.getElementById('aeiEmbed');
      if(!embed) return;
      const top = embed.getBoundingClientRect().top;
      const safety = 1;
      const available = Math.max(240, viewportH() - top - safety);
      embed.style.height = available + 'px';
      const stage = document.getElementById('aeiStage');
      stage.style.height = '100%';
      const lines = document.getElementById('aeiLines');
      lines.style.width = '100%';
      lines.style.height = '100%';
    }
    addEventListener('load', fitEmbedToViewport);
    addEventListener('resize', fitEmbedToViewport, {passive:true});
    addEventListener('orientationchange', fitEmbedToViewport);
    addEventListener('visibilitychange', ()=>{ if(document.visibilityState==='visible') fitEmbedToViewport(); });
    if(window.visualViewport){
      visualViewport.addEventListener('resize', fitEmbedToViewport);
      visualViewport.addEventListener('scroll', fitEmbedToViewport);
    }

    /* ================== z-stack para drag ================== */
    let Z_STACK = 100;

    /* ================== video utils ================== */
    function wireVideoEl(v,{autoplay=true}={}){
      v.muted=true; v.loop=true; v.autoplay=!!autoplay; v.playsInline=true; v.preload='none'; v.poster=BLANK_POSTER;
      v.setAttribute('muted',''); v.setAttribute('playsinline',''); v.setAttribute('webkit-playsinline','');
      if(autoplay) v.setAttribute('autoplay','');
    }
    const ioLoad = new IntersectionObserver((entries,obs)=>{
      entries.forEach(en=>{
        if(!en.isIntersecting) return;
        const v=en.target;
        if(v.dataset.src && !v.src){ v.src=v.dataset.src; v.load(); }
        obs.unobserve(v);
      });
    },{rootMargin:'600px 0px', threshold:.08});
    function autoPlayOnVisible(video){
      const tryPlay=()=> video.play().catch(()=>{});
      const vio=new IntersectionObserver((ents)=>{
        ents.forEach(en=>{ if(en.isIntersecting){ video.muted=true; video.setAttribute('muted',''); tryPlay(); } else { video.pause(); } });
      },{threshold:.12});
      vio.observe(video);
      const t0=Date.now(); (function tick(){ if(!video.paused || Date.now()-t0>4000) return; tryPlay(); setTimeout(tick,300); })();
      document.addEventListener('visibilitychange',()=>{ if(document.visibilityState==='visible') tryPlay(); });
    }
    function unlockAllVideos(){
      document.removeEventListener('click', unlockAllVideos);
      document.removeEventListener('touchstart', unlockAllVideos);
      $$('video').forEach(v=>{
        if(!v.src && v.dataset.src){ v.src=v.dataset.src; v.load(); }
        v.muted=true; v.setAttribute('muted',''); v.play().catch(()=>{});
      });
    }
    document.addEventListener('click', unlockAllVideos, { once:true });
    document.addEventListener('touchstart', unlockAllVideos, { once:true, passive:true });

    /* ================== links relativos desde /a.e.i/ ================== */
    function resolveLink(href){
      if(!href) return '#';
      if(/^(?:[a-z]+:)?\/\//i.test(href)) return href;
      if(href.startsWith('../')) return href;
      return '../' + href.replace(/^\.?\//,'');
    }

    /* ================== AEI motor ================== */
    function renderAEI(stage, linesSVG, urls){
      const embedRoot = document.getElementById('aeiEmbed');
      const panel = document.getElementById('tacticalPanel');
      const toggleBtn = document.getElementById('panelToggle');

      const blocks=[], MAX_BLOCKS_BASE=Math.min(urls.length,42);
      let idx=0, paused=false, currentPairs=[], nextLineTick=0;

      /* densidad y velocidad adaptativas por superficie */
      const area = ()=> {
        const r = stage.getBoundingClientRect();
        return Math.max(1, r.width * r.height);
      };
      let density = 8;   // 0..100
      let speed   = 0.10;

      // panel táctico
      const statB   = document.getElementById('statBlocks');
      const statF   = document.getElementById('statFPS');
      const rngD    = document.getElementById('densityRng');
      const rngS    = document.getElementById('speedRng');
      const pauseBt = document.getElementById('pauseBtn');
      const resetBt = document.getElementById('resetBtn');

      const setPaused=(v)=>{ paused=!!v; pauseBt.setAttribute('aria-pressed', String(paused)); pauseBt.textContent = paused ? 'resume' : 'pause'; };

      /* inicial adaptativo */
      const setAdaptiveParams = ()=>{
        const a = area();
        const targetD = a < 350000 ? 6 : a < 800000 ? 10 : 14;
        density = targetD;
        rngD.value = String(density);
        const targetS = a < 350000 ? 8 : a < 800000 ? 10 : 12;
        speed = targetS/100;
        rngS.value = String(targetS);
      };
      setAdaptiveParams();

      rngD.addEventListener('input', e=> density = Number(e.target.value));
      rngS.addEventListener('input', e=> speed   = Number(e.target.value)/100);
      pauseBt.addEventListener('click', ()=> setPaused(!paused));
      resetBt.addEventListener('click', ()=>{
        const rect=stage.getBoundingClientRect();
        blocks.forEach(b=>{
          const bw=parseFloat(getComputedStyle(b).width), bh=parseFloat(getComputedStyle(b).height);
          b.x=Math.random()*Math.max(10,rect.width-bw);
          b.y=Math.random()*Math.max(10,rect.height-bh);
          b.vx=(Math.random()-.5)*speed*2.0;
          b.vy=(Math.random()-.5)*speed*2.0;
          updateBlockTransform(b);
        });
        generateLines(true);
      });

      // ===== helpers de panel =====
      function fitPanel(){
        if(!panel) return;
        const vh = viewportH();

        // altura máxima segura en móvil vertical
        const headerH = parseFloat(getComputedStyle(document.documentElement).getPropertyValue('--header-h')) || 64;
        const safeTop = (window.visualViewport?.offsetTop || 0);
        const safeBottom = 0; // env(safe-area-inset-bottom) ya se resta en CSS
        panel.style.maxHeight = Math.max(220, vh - headerH - 24 - safeTop - safeBottom) + 'px';

        // si portrait, coloca bajo el botón; si no, esquina superior
        const portrait = (window.innerHeight / Math.max(1, window.innerWidth)) > 1.1;
        if(toggleBtn && portrait){
          const r = toggleBtn.getBoundingClientRect();
          panel.style.top = (r.bottom + 8) + 'px';
          panel.style.right = '12px';
        }else{
          panel.style.top = 'calc(env(safe-area-inset-top) + 12px)';
          panel.style.right = 'calc(env(safe-area-inset-right) + 12px)';
        }

        // apila si hace falta
        const overflow = panel.scrollHeight > panel.clientHeight + 4;
        panel.classList.toggle('tactical--stack', portrait || overflow);
      }

      function togglePanel(){
        const visible = panel.style.display === 'flex';
        panel.style.display = visible ? 'none' : 'flex';
        if(toggleBtn) toggleBtn.setAttribute('aria-expanded', String(!visible));
        if(!visible) requestAnimationFrame(fitPanel);
      }

      // g, gesto superior y botón táctil
      window.addEventListener('keydown', e=>{ if(e.key==='g'||e.key==='G') togglePanel(); });
      let gestureArmed=false, gestureT=0;
      document.addEventListener('touchstart', e=>{
        const t=e.touches[0]; if(t && t.clientY < 32){ gestureArmed=true; gestureT=performance.now(); }
      },{passive:true});
      document.addEventListener('touchend', ()=>{
        if(gestureArmed && performance.now()-gestureT < 800) togglePanel();
        gestureArmed=false;
      });
      if(toggleBtn) toggleBtn.addEventListener('click', togglePanel);

      // pausa por hover/touch
      const pauseOn=()=> setPaused(true), resume=()=> setPaused(false);
      stage.addEventListener('mouseenter',pauseOn);
      stage.addEventListener('mouseleave',resume);
      stage.addEventListener('touchstart',pauseOn,{passive:true});
      stage.addEventListener('touchend',resume);

      // ===== límites dinámicos por DPR y área
      const dpr = Math.min(3, window.devicePixelRatio || 1);
      const maxBlocks = Math.max(8, Math.floor(MAX_BLOCKS_BASE / (dpr>2 ? 1.5 : 1)));

      function addNext(){
        if(idx>=maxBlocks) return;
        const item = urls[idx++];
        const mediaUrl = typeof item === 'string' ? item : item.url;
        const linkHref = typeof item === 'string' ? null : item.link;
        const newTab   = typeof item === 'string' ? false : !!item.newTab;

        const block = document.createElement(linkHref ? 'a' : 'div');
        block.className='aei-block';
        if(linkHref){
          block.href = resolveLink(linkHref);
          if(newTab){ block.target = '_blank'; block.rel = 'noopener'; }
        }
        if(!block.style.zIndex) block.style.zIndex = '1';

        let el;
        if(/\.(mp4|mov)(\?|$)/i.test(mediaUrl)){
          el=document.createElement('video');
          wireVideoEl(el,{autoplay:true});
          el.dataset.src=mediaUrl;
          block.appendChild(el); stage.appendChild(block);
          ioLoad.observe(el); autoPlayOnVisible(el);
        }else{
          el=document.createElement('img');
          el.loading='lazy'; el.decoding='async'; el.src=mediaUrl;
          block.appendChild(el); stage.appendChild(block);
        }

        const rect=stage.getBoundingClientRect();
        const bw=parseFloat(getComputedStyle(block).width), bh=parseFloat(getComputedStyle(block).height);
        block.x=Math.random()*Math.max(10,rect.width-bw);
        block.y=Math.random()*Math.max(10,rect.height-bh);
        block.vx=(Math.random()-.5)*speed*2.0;
        block.vy=(Math.random()-.5)*speed*2.0;
        updateBlockTransform(block);
        makeDraggable(block);
        blocks.push(block);

        statB.textContent = 'blk:'+blocks.length;
        setTimeout(addNext,45);
      }
      addNext();

      function updateBlockTransform(b){ b.style.transform=`translate3d(${b.x}px,${b.y}px,0)`; }
      function clampToStage(b){
        const rect=stage.getBoundingClientRect();
        const bw=parseFloat(getComputedStyle(b).width), bh=parseFloat(getComputedStyle(b).height);
        b.x=Math.min(Math.max(0,b.x), Math.max(0,rect.width-bw));
        b.y=Math.min(Math.max(0,b.y), Math.max(0,rect.height-bh));
      }

      function makeDraggable(el){
        let isDown=false, moved=false, lastX=0, lastY=0;
        const TH=6;
        el.setAttribute('draggable','false'); el.style.userSelect='none';

        const start=(cx,cy)=>{
          isDown=true; moved=false; lastX=cx; lastY=cy;
          el.style.zIndex = String(++Z_STACK);
        };
        const move =(cx,cy)=>{
          if(!isDown) return;
          const dx=cx-lastX, dy=cy-lastY;
          if(!moved && (Math.abs(dx)>TH || Math.abs(dy)>TH)) moved=true;
          el.x+=dx; el.y+=dy; clampToStage(el); updateBlockTransform(el);
          lastX=cx; lastY=cy; drawLines(true);
        };
        const end =()=>{
          isDown=false;
          if(moved){ el._suppressClick=true; setTimeout(()=> el._suppressClick=false,0); }
        };

        // mouse
        el.addEventListener('mousedown',e=>{ e.preventDefault(); start(e.clientX,e.clientY); });
        window.addEventListener('mousemove',e=> move(e.clientX,e.clientY));
        window.addEventListener('mouseup',end);

        // touch
        el.addEventListener('touchstart',e=>{ const t=e.touches[0]; start(t.clientX,t.clientY); },{passive:true});
        el.addEventListener('touchmove', e=>{ if(!isDown) return; e.preventDefault(); const t=e.touches[0]; move(t.clientX,t.clientY); },{passive:false});
        el.addEventListener('touchend',end);

        el.addEventListener('click',e=>{ if(el._suppressClick){ e.preventDefault(); e.stopPropagation(); } });
        el.addEventListener('dragstart',e=> e.preventDefault());
      }

      /* ===== conexiones ===== */
      function generateLines(force=false){
        if(!force && Math.random()<0.35) return;
        currentPairs.length=0;
        const N=blocks.length;
        if(!N) return;
        const p = Math.min(0.35, 0.01 + density/300);
        for(let i=0;i<N;i++){
          for(let j=i+1;j<N;j++){
            if(Math.random()<p) currentPairs.push([blocks[i],blocks[j]]);
          }
        }
      }
      function centerOf(b){
        const r=b.getBoundingClientRect();
        return [b.x + r.width/2, b.y + r.height/2];
      }
      function drawLines(live=false){
        const svg=linesSVG;
        if(!live) svg.innerHTML='';
        const frag=document.createDocumentFragment();
        for(const [a,b] of currentPairs){
          const [x1,y1]=centerOf(a), [x2,y2]=centerOf(b);
          const l=document.createElementNS('http://www.w3.org/2000/svg','line');
          l.setAttribute('x1',x1); l.setAttribute('y1',y1);
          l.setAttribute('x2',x2); l.setAttribute('y2',y2);
          l.classList.add('fx');
          frag.appendChild(l);
        }
        if(!live){ svg.innerHTML=''; svg.appendChild(frag); }
        else { svg.appendChild(frag); }
      }

      // bucle + gobernanza
      let lastT=performance.now(), fps=0, fpsA=0, lowPower=false;
      function applyLowPower(on){
        if(on === lowPower) return;
        lowPower = on;
        embedRoot.classList.toggle('lp', lowPower);
        if(lowPower){
          density = Math.max(4, Math.floor(density*0.7));
          speed   = Math.max(0.06, speed*0.8);
        }
      }
      function capBlocks(){
        const over = blocks.length - maxBlocks;
        for(let i=0; i<over; i++){
          const b = blocks.pop();
          if(b){ b.remove(); }
        }
        statB.textContent = 'blk:'+blocks.length;
      }

      function step(t){
        const dt = Math.max(1, t-lastT); lastT=t;
        const rect=stage.getBoundingClientRect();

        if(!paused){
          for(const b of blocks){
            b.x+=b.vx * (dt/16);
            b.y+=b.vy * (dt/16);
            const bw=parseFloat(getComputedStyle(b).width), bh=parseFloat(getComputedStyle(b).height);
            if(b.x<0 || b.x>rect.width-bw) b.vx*=-1;
            if(b.y<0 || b.y>rect.height-bh) b.vy*=-1;
            clampToStage(b); updateBlockTransform(b);
          }
          if(!nextLineTick || t>nextLineTick){
            generateLines();
            drawLines();
            nextLineTick = t + (300 + Math.random()*400);
          }
        }

        // FPS aprox y control
        fps = 1000/dt; fpsA = fpsA*0.9 + fps*0.1;
        statF.textContent = 'fps:'+Math.max(0, Math.min(240, fpsA)).toFixed(0);
        capBlocks();
        if(fpsA < 28){ applyLowPower(true); }
        else if(fpsA > 45){ applyLowPower(false); }

        requestAnimationFrame(step);
      }
      requestAnimationFrame(step);

      // reflow reactivo
      const ro = new ResizeObserver(()=>{
        for(const b of blocks){ clampToStage(b); updateBlockTransform(b); }
        setAdaptiveParams();
        fitPanel();
      });
      ro.observe(stage);

      // primera adaptación + estado inicial del panel
      fitEmbedToViewport();
      panel.style.display='flex';
      fitPanel();
      setTimeout(()=> panel.style.display='none', 1300);
    }

    /* ================== datos de media (conservados) ================== */


    const aeiMedia = [{"url": "https://attachments.are.na/37040777/c7dc1946380c630ddce24344516012f3.wav?1748490999", "link": "https://open.spotify.com/intl-es/album/6zZqkXJsKN5cZHziLzLUZ4?si=EKy2nCg-T9iCTFjnLXMlkg", "newTab": true}, {"url": "https://attachments.are.na/37040783/19495003557eaa4a2535ca7378c8a393.wav?1748491039", "link": "https://open.spotify.com/intl-es/album/6zZqkXJsKN5cZHziLzLUZ4?si=EKy2nCg-T9iCTFjnLXMlkg", "newTab": true}, {"url": "https://attachments.are.na/37040784/46b8dca0b7961be9a13068a57b1026ff.wav?1748491044", "link": "https://open.spotify.com/intl-es/album/6zZqkXJsKN5cZHziLzLUZ4?si=EKy2nCg-T9iCTFjnLXMlkg", "newTab": true}, {"url": "https://attachments.are.na/37040790/04e42ce8771c58e3ae2a2721fa921313.wav?1748491057", "link": "https://open.spotify.com/intl-es/album/6zZqkXJsKN5cZHziLzLUZ4?si=EKy2nCg-T9iCTFjnLXMlkg", "newTab": true}, {"url": "https://attachments.are.na/37040794/7d02732a7d3ecfbdaf1b240b7d08c7a1.wav?1748491073", "link": "https://open.spotify.com/intl-es/album/6zZqkXJsKN5cZHziLzLUZ4?si=EKy2nCg-T9iCTFjnLXMlkg", "newTab": true}, {"url": "https://attachments.are.na/37040797/ce2bb6134d02b54065b47347f2cea987.wav?1748491097", "link": "https://open.spotify.com/intl-es/album/6zZqkXJsKN5cZHziLzLUZ4?si=EKy2nCg-T9iCTFjnLXMlkg", "newTab": true}, {"url": "https://attachments.are.na/37040800/4a490aff16cefaac91c67cdc3fcf73ee.wav?1748491127", "link": "https://open.spotify.com/intl-es/album/6zZqkXJsKN5cZHziLzLUZ4?si=EKy2nCg-T9iCTFjnLXMlkg", "newTab": true}, {"url": "https://attachments.are.na/37040804/b5ecff758bec22e7b5f8a9a40ae12d15.wav?1748491153", "link": "https://open.spotify.com/intl-es/album/6zZqkXJsKN5cZHziLzLUZ4?si=EKy2nCg-T9iCTFjnLXMlkg", "newTab": true}, {"url": "https://attachments.are.na/37040808/59df8bde12c80a439798fe6696e763e6.wav?1748491181", "link": "https://open.spotify.com/intl-es/album/6zZqkXJsKN5cZHziLzLUZ4?si=EKy2nCg-T9iCTFjnLXMlkg", "newTab": true}, {"url": "https://attachments.are.na/37040811/ff09b66c7ee35b50a12dbc4613989b9f.wav?1748491190", "link": "https://open.spotify.com/intl-es/album/6zZqkXJsKN5cZHziLzLUZ4?si=EKy2nCg-T9iCTFjnLXMlkg", "newTab": true}, {"url": "https://d2w9rnfcy7mm78.cloudfront.net/37040832/original_28275a7281b0fe4175cba66600a7ba4a.jpg?1748491293?bc=0", "link": "https://open.spotify.com/intl-es/album/6zZqkXJsKN5cZHziLzLUZ4?si=EKy2nCg-T9iCTFjnLXMlkg", "newTab": true}, {"url": "https://attachments.are.na/37040835/5954a53112db6976772cc46e0c4b9343.mp4?1748491305", "link": "https://open.spotify.com/intl-es/album/6zZqkXJsKN5cZHziLzLUZ4?si=EKy2nCg-T9iCTFjnLXMlkg", "newTab": true}, {"url": "https://attachments.are.na/37040842/bad798fa35ecd98c57082b28a9b36e03.mp4?1748491329", "link": "https://open.spotify.com/intl-es/album/6zZqkXJsKN5cZHziLzLUZ4?si=EKy2nCg-T9iCTFjnLXMlkg", "newTab": true}, {"url": "https://attachments.are.na/37040843/39a928e5dc378ee5201682083c0b5e80.wav?1748491335", "link": "https://open.spotify.com/intl-es/album/6zZqkXJsKN5cZHziLzLUZ4?si=EKy2nCg-T9iCTFjnLXMlkg", "newTab": true}, {"url": "https://attachments.are.na/37040849/a10f2eff76e903695f9b33691598288d.wav?1748491389", "link": "https://open.spotify.com/intl-es/album/6zZqkXJsKN5cZHziLzLUZ4?si=EKy2nCg-T9iCTFjnLXMlkg", "newTab": true}, {"url": "https://attachments.are.na/37040851/fc98beb29b10551a623171341f7b0bc7.wav?1748491394", "link": "https://open.spotify.com/intl-es/album/6zZqkXJsKN5cZHziLzLUZ4?si=EKy2nCg-T9iCTFjnLXMlkg", "newTab": true}, {"url": "https://attachments.are.na/37040868/eb5effa92629b74d0283a57877a3c974.wav?1748491517", "link": "https://open.spotify.com/intl-es/album/6zZqkXJsKN5cZHziLzLUZ4?si=EKy2nCg-T9iCTFjnLXMlkg", "newTab": true}, {"url": "https://d2w9rnfcy7mm78.cloudfront.net/37040882/original_0a7599d4dfcc3f0ee270a7eb8b136262.jpg?1748491560?bc=0", "link": "https://open.spotify.com/intl-es/album/6zZqkXJsKN5cZHziLzLUZ4?si=EKy2nCg-T9iCTFjnLXMlkg", "newTab": true}, {"url": "https://d2w9rnfcy7mm78.cloudfront.net/37040884/original_65aa0b2e077eb5def557a0fc9d18a1dd.jpg?1748491561?bc=0", "link": "https://open.spotify.com/intl-es/album/6zZqkXJsKN5cZHziLzLUZ4?si=EKy2nCg-T9iCTFjnLXMlkg", "newTab": true}, {"url": "https://d2w9rnfcy7mm78.cloudfront.net/37040885/original_1f018ebe5358128cbc846e520710daaa.jpg?1748491561?bc=0", "link": "https://open.spotify.com/intl-es/album/6zZqkXJsKN5cZHziLzLUZ4?si=EKy2nCg-T9iCTFjnLXMlkg", "newTab": true}, {"url": "https://d2w9rnfcy7mm78.cloudfront.net/37040887/original_f98f6ba62a7f45f1fac570f935d051bf.jpg?1748491564?bc=0", "link": "https://open.spotify.com/intl-es/album/6zZqkXJsKN5cZHziLzLUZ4?si=EKy2nCg-T9iCTFjnLXMlkg", "newTab": true}, {"url": "https://attachments.are.na/37040888/6a4ae43a52acf5f8f4234e1c0de94a2a.mov?1748491565", "link": "https://open.spotify.com/intl-es/album/6zZqkXJsKN5cZHziLzLUZ4?si=EKy2nCg-T9iCTFjnLXMlkg", "newTab": true}, {"url": "https://d2w9rnfcy7mm78.cloudfront.net/37040889/original_f10965cf7e4c6a71da89839aebc51a6a.jpg?1748491567?bc=0", "link": "https://open.spotify.com/intl-es/album/6zZqkXJsKN5cZHziLzLUZ4?si=EKy2nCg-T9iCTFjnLXMlkg", "newTab": true}, {"url": "https://attachments.are.na/37040891/7bf8e1de2a3bf9e45d9e4735fdebeb3e.mov?1748491575", "link": "https://open.spotify.com/intl-es/album/6zZqkXJsKN5cZHziLzLUZ4?si=EKy2nCg-T9iCTFjnLXMlkg", "newTab": true}, {"url": "https://attachments.are.na/37040892/2e81e452efaa91f11f2ae508d29bc961.mov?1748491577", "link": "https://open.spotify.com/intl-es/album/6zZqkXJsKN5cZHziLzLUZ4?si=EKy2nCg-T9iCTFjnLXMlkg", "newTab": true}, {"url": "https://attachments.are.na/37040897/dea24166a8e242d42736a3c4c0250a96.mov?1748491608", "link": "https://open.spotify.com/intl-es/album/6zZqkXJsKN5cZHziLzLUZ4?si=EKy2nCg-T9iCTFjnLXMlkg", "newTab": true}, {"url": "https://d2w9rnfcy7mm78.cloudfront.net/37040908/original_bec509500c86005f6421f5ca16149d82.jpg?1748491662?bc=0", "link": "https://open.spotify.com/intl-es/album/6zZqkXJsKN5cZHziLzLUZ4?si=EKy2nCg-T9iCTFjnLXMlkg", "newTab": true}, {"url": "https://d2w9rnfcy7mm78.cloudfront.net/37040909/original_d05f6804a406276159bcdd6bbd4ffa1b.png?1748491662?bc=0", "link": "https://open.spotify.com/intl-es/album/6zZqkXJsKN5cZHziLzLUZ4?si=EKy2nCg-T9iCTFjnLXMlkg", "newTab": true}, {"url": "https://d2w9rnfcy7mm78.cloudfront.net/37040911/original_efefd7134b89ba0a0502757d2eb634fd.jpg?1748491669?bc=0", "link": "https://open.spotify.com/intl-es/album/6zZqkXJsKN5cZHziLzLUZ4?si=EKy2nCg-T9iCTFjnLXMlkg", "newTab": true}, {"url": "https://attachments.are.na/37040916/d2a159d704c8e4e00fadcd2f0efd3b13.mov?1748491689", "link": "https://open.spotify.com/intl-es/album/6zZqkXJsKN5cZHziLzLUZ4?si=EKy2nCg-T9iCTFjnLXMlkg", "newTab": true}, {"url": "https://attachments.are.na/37040917/3b2feac87d6f471483d63b6289c44a6c.mp4?1748491692", "link": "https://open.spotify.com/intl-es/album/6zZqkXJsKN5cZHziLzLUZ4?si=EKy2nCg-T9iCTFjnLXMlkg", "newTab": true}, {"url": "https://attachments.are.na/37040922/6f953727c46f7045302b9c7ffc93f616.mp4?1748491730", "link": "https://open.spotify.com/intl-es/album/6zZqkXJsKN5cZHziLzLUZ4?si=EKy2nCg-T9iCTFjnLXMlkg", "newTab": true}, {"url": "https://attachments.are.na/37040924/9670f77d5fc576cd2451a721166b5eee.mov?1748491731", "link": "https://open.spotify.com/intl-es/album/6zZqkXJsKN5cZHziLzLUZ4?si=EKy2nCg-T9iCTFjnLXMlkg", "newTab": true}, {"url": "https://attachments.are.na/37040933/a2b9b225b28f3be74fbb059f73bde670.mov?1748491774", "link": "https://open.spotify.com/intl-es/album/6zZqkXJsKN5cZHziLzLUZ4?si=EKy2nCg-T9iCTFjnLXMlkg", "newTab": true}, {"url": "https://d2w9rnfcy7mm78.cloudfront.net/37040945/original_9a400c848787814463e4eddb36fe861c.png?1748491853?bc=0", "link": "https://open.spotify.com/intl-es/album/6zZqkXJsKN5cZHziLzLUZ4?si=EKy2nCg-T9iCTFjnLXMlkg", "newTab": true}, {"url": "https://d2w9rnfcy7mm78.cloudfront.net/37040949/original_faee67152c544f0fd7c945efb69488a0.png?1748491870?bc=0", "link": "https://open.spotify.com/intl-es/album/6zZqkXJsKN5cZHziLzLUZ4?si=EKy2nCg-T9iCTFjnLXMlkg", "newTab": true}, {"url": "https://d2w9rnfcy7mm78.cloudfront.net/37040952/original_7b71385a525459513722fbb3a16c3589.png?1748491883?bc=0", "link": "https://open.spotify.com/intl-es/album/6zZqkXJsKN5cZHziLzLUZ4?si=EKy2nCg-T9iCTFjnLXMlkg", "newTab": true}, {"url": "https://d2w9rnfcy7mm78.cloudfront.net/37040953/original_2ef0d28c648c5c65e2e1d021f4384403.png?1748491891?bc=0", "link": "https://open.spotify.com/intl-es/album/6zZqkXJsKN5cZHziLzLUZ4?si=EKy2nCg-T9iCTFjnLXMlkg", "newTab": true}, {"url": "https://d2w9rnfcy7mm78.cloudfront.net/37041331/original_36a50d3fb7ec6f527bac57816ec33989.png?1748493931?bc=0", "link": "https://open.spotify.com/intl-es/album/6zZqkXJsKN5cZHziLzLUZ4?si=EKy2nCg-T9iCTFjnLXMlkg", "newTab": true}, {"url": "https://d2w9rnfcy7mm78.cloudfront.net/37041332/original_712bb34297170edbd55d4f1ed91d8500.png?1748493931?bc=0", "link": "https://open.spotify.com/intl-es/album/6zZqkXJsKN5cZHziLzLUZ4?si=EKy2nCg-T9iCTFjnLXMlkg", "newTab": true},
    {"url": "https://d2w9rnfcy7mm78.cloudfront.net/24550199/original_b958330a51ad85c9396da0de30d5d8d6.jpg?1699245528?bc=0", "link": "https://open.spotify.com/intl-es/album/6zZqkXJsKN5cZHziLzLUZ4?si=EKy2nCg-T9iCTFjnLXMlkg", "newTab": true}, {"url": "https://d2w9rnfcy7mm78.cloudfront.net/24807579/original_ad0b6b3fafc2e191ea8fdb1a528139e0.png?1700424231?bc=0", "link": "https://open.spotify.com/intl-es/album/6zZqkXJsKN5cZHziLzLUZ4?si=EKy2nCg-T9iCTFjnLXMlkg", "newTab": true}, {"url": "https://d2w9rnfcy7mm78.cloudfront.net/24807663/original_900404b2cf0f0f4ccc14833b6687d5eb.jpg?1700424600?bc=0", "link": "https://open.spotify.com/intl-es/album/6zZqkXJsKN5cZHziLzLUZ4?si=EKy2nCg-T9iCTFjnLXMlkg", "newTab": true}, {"url": "https://d2w9rnfcy7mm78.cloudfront.net/24807713/original_12698197ff86b6dd8ccd0d8111136e16.jpg?1700424888?bc=0", "link": "https://open.spotify.com/intl-es/album/6zZqkXJsKN5cZHziLzLUZ4?si=EKy2nCg-T9iCTFjnLXMlkg", "newTab": true}, {"url": "https://d2w9rnfcy7mm78.cloudfront.net/24830100/original_6febd474d3ee4fdc5b6c9b3c33f5ba47.jpg?1700518231?bc=0", "link": "https://open.spotify.com/intl-es/album/6zZqkXJsKN5cZHziLzLUZ4?si=EKy2nCg-T9iCTFjnLXMlkg", "newTab": true}, {"url": "https://d2w9rnfcy7mm78.cloudfront.net/24829856/original_873748b83d2d196254614cf90ef59ff1.jpg?1700517709?bc=0", "link": "https://open.spotify.com/intl-es/album/6zZqkXJsKN5cZHziLzLUZ4?si=EKy2nCg-T9iCTFjnLXMlkg", "newTab": true}, {"url": "https://d2w9rnfcy7mm78.cloudfront.net/24829854/original_51a8407a7af422a5c64ec7cbf5aa2c58.jpg?1700517708?bc=0", "link": "https://open.spotify.com/intl-es/album/6zZqkXJsKN5cZHziLzLUZ4?si=EKy2nCg-T9iCTFjnLXMlkg", "newTab": true}, {"url": "https://d2w9rnfcy7mm78.cloudfront.net/24830097/original_e0a6fff9002f429f568620c400668732.jpg?1700518231?bc=0", "link": "https://open.spotify.com/intl-es/album/6zZqkXJsKN5cZHziLzLUZ4?si=EKy2nCg-T9iCTFjnLXMlkg", "newTab": true}, {"url": "https://d2w9rnfcy7mm78.cloudfront.net/24830110/original_26ddb3b4a999ee46aaa4a10849dc60af.jpg?1700518252?bc=0", "link": "https://open.spotify.com/intl-es/album/6zZqkXJsKN5cZHziLzLUZ4?si=EKy2nCg-T9iCTFjnLXMlkg", "newTab": true}, {"url": "https://d2w9rnfcy7mm78.cloudfront.net/24830026/original_67496f6e332910f7d71c569388c1f346.jpg?1700517957?bc=0", "link": "https://open.spotify.com/intl-es/album/6zZqkXJsKN5cZHziLzLUZ4?si=EKy2nCg-T9iCTFjnLXMlkg", "newTab": true}, {"url": "https://d2w9rnfcy7mm78.cloudfront.net/24829868/original_2f4800678a243d80520b8f56da2818b3.jpg?1700517719?bc=0", "link": "https://open.spotify.com/intl-es/album/6zZqkXJsKN5cZHziLzLUZ4?si=EKy2nCg-T9iCTFjnLXMlkg", "newTab": true}, {"url": "https://d2w9rnfcy7mm78.cloudfront.net/24814851/original_bbca12fe778ac109f708d20eaed50335.jpg?1700460797?bc=0", "link": "https://open.spotify.com/intl-es/album/6zZqkXJsKN5cZHziLzLUZ4?si=EKy2nCg-T9iCTFjnLXMlkg", "newTab": true}, {"url": "https://d2w9rnfcy7mm78.cloudfront.net/24814829/original_71a8322ac2893769314b28ff6f276127.jpg?1700460736?bc=0", "link": "https://open.spotify.com/intl-es/album/6zZqkXJsKN5cZHziLzLUZ4?si=EKy2nCg-T9iCTFjnLXMlkg", "newTab": true}, {"url": "https://d2w9rnfcy7mm78.cloudfront.net/24807720/original_014b5a2ce1b80a21d07021c4048ea6b0.jpg?1700424892?bc=0", "link": "https://open.spotify.com/intl-es/album/6zZqkXJsKN5cZHziLzLUZ4?si=EKy2nCg-T9iCTFjnLXMlkg", "newTab": true}, {"url": "https://d2w9rnfcy7mm78.cloudfront.net/27295318/original_1dfbe4873fc2e2fe8077b85b64d86b32.jpg?1711946843?bc=0", "link": "https://open.spotify.com/intl-es/album/6zZqkXJsKN5cZHziLzLUZ4?si=EKy2nCg-T9iCTFjnLXMlkg", "newTab": true}, {"url": "https://d2w9rnfcy7mm78.cloudfront.net/24829867/original_7600dd1a13cf37f2d16ebdc7cb14379e.jpg?1700517718?bc=0", "link": "https://open.spotify.com/intl-es/album/6zZqkXJsKN5cZHziLzLUZ4?si=EKy2nCg-T9iCTFjnLXMlkg", "newTab": true}, {"url": "https://attachments.are.na/27295322/ced0fa1a6cd7c32ccf7cb137d1b2965b.mov?1711946913", "link": "https://open.spotify.com/intl-es/album/6zZqkXJsKN5cZHziLzLUZ4?si=EKy2nCg-T9iCTFjnLXMlkg", "newTab": true}, {"url": "https://d2w9rnfcy7mm78.cloudfront.net/27295326/original_36bacaf35a8f23d5a97068ffb21e70e4.jpg?1711946956?bc=0", "link": "https://open.spotify.com/intl-es/album/6zZqkXJsKN5cZHziLzLUZ4?si=EKy2nCg-T9iCTFjnLXMlkg", "newTab": true}, {"url": "https://d2w9rnfcy7mm78.cloudfront.net/27295333/original_7a048143fcd5e672625880650d56fba4.jpg?1711947029?bc=0", "link": "https://open.spotify.com/intl-es/album/6zZqkXJsKN5cZHziLzLUZ4?si=EKy2nCg-T9iCTFjnLXMlkg", "newTab": true}, {"url": "https://d2w9rnfcy7mm78.cloudfront.net/27295334/original_7624263a465a2ae171c0d7d5c95383f4.png?1711947030?bc=0", "link": "https://open.spotify.com/intl-es/album/6zZqkXJsKN5cZHziLzLUZ4?si=EKy2nCg-T9iCTFjnLXMlkg", "newTab": true}, {"url": "https://d2w9rnfcy7mm78.cloudfront.net/27295335/original_8f3202aef1531849e632676307ff3a85.png?1711947031?bc=0", "link": "https://open.spotify.com/intl-es/album/6zZqkXJsKN5cZHziLzLUZ4?si=EKy2nCg-T9iCTFjnLXMlkg", "newTab": true}, {"url": "https://d2w9rnfcy7mm78.cloudfront.net/27295337/original_e147901531e0eccefc085956812af538.jpg?1711947044?bc=0", "link": "https://open.spotify.com/intl-es/album/6zZqkXJsKN5cZHziLzLUZ4?si=EKy2nCg-T9iCTFjnLXMlkg", "newTab": true}, {"url": "https://attachments.are.na/27295338/72d7323aae9a9ad53151301c53b5b2fc.mov?1711947051", "link": "https://open.spotify.com/intl-es/album/6zZqkXJsKN5cZHziLzLUZ4?si=EKy2nCg-T9iCTFjnLXMlkg", "newTab": true}, {"url": "https://d2w9rnfcy7mm78.cloudfront.net/27295341/original_11d2e0e3e2431c0126343f74f0645299.jpg?1711947073?bc=0", "link": "https://open.spotify.com/intl-es/album/6zZqkXJsKN5cZHziLzLUZ4?si=EKy2nCg-T9iCTFjnLXMlkg", "newTab": true}, {"url": "https://attachments.are.na/27295343/01c3fab325037bc7653846202bb8108a.mov?1711947123", "link": "https://open.spotify.com/intl-es/album/6zZqkXJsKN5cZHziLzLUZ4?si=EKy2nCg-T9iCTFjnLXMlkg", "newTab": true}, {"url": "https://d2w9rnfcy7mm78.cloudfront.net/27295351/original_6f349656b30debaaecd182c54edd1ffc.jpg?1711947197?bc=0", "link": "https://open.spotify.com/intl-es/album/6zZqkXJsKN5cZHziLzLUZ4?si=EKy2nCg-T9iCTFjnLXMlkg", "newTab": true}, {"url": "https://d2w9rnfcy7mm78.cloudfront.net/27295353/original_18d2618b5ff83f2b09bb8692a1158ddf.jpg?1711947211?bc=0", "link": "https://open.spotify.com/intl-es/album/6zZqkXJsKN5cZHziLzLUZ4?si=EKy2nCg-T9iCTFjnLXMlkg", "newTab": true}, {"url": "https://d2w9rnfcy7mm78.cloudfront.net/27295354/original_37718b32defddc7647bef361c2f14dcb.jpg?1711947212?bc=0", "link": "https://open.spotify.com/intl-es/album/6zZqkXJsKN5cZHziLzLUZ4?si=EKy2nCg-T9iCTFjnLXMlkg", "newTab": true}, {"url": "https://d2w9rnfcy7mm78.cloudfront.net/27295355/original_f599622efa336f081df3bb4322ae5f06.jpg?1711947212?bc=0", "link": "https://open.spotify.com/intl-es/album/6zZqkXJsKN5cZHziLzLUZ4?si=EKy2nCg-T9iCTFjnLXMlkg", "newTab": true}, {"url": "https://d2w9rnfcy7mm78.cloudfront.net/27295356/original_90627df2643c2fb8913fc8dcc0f23912.jpg?1711947216?bc=0", "link": "https://open.spotify.com/intl-es/album/6zZqkXJsKN5cZHziLzLUZ4?si=EKy2nCg-T9iCTFjnLXMlkg", "newTab": true}, {"url": "https://d2w9rnfcy7mm78.cloudfront.net/27295358/original_fd35fccdeaa0979e0c40c41d6902a00c.jpg?1711947228?bc=0", "link": "https://open.spotify.com/intl-es/album/6zZqkXJsKN5cZHziLzLUZ4?si=EKy2nCg-T9iCTFjnLXMlkg", "newTab": true}, {"url": "https://d2w9rnfcy7mm78.cloudfront.net/27295359/original_4b4fced04498eae20bbdc7f14c436299.jpg?1711947230?bc=0", "link": "https://open.spotify.com/intl-es/album/6zZqkXJsKN5cZHziLzLUZ4?si=EKy2nCg-T9iCTFjnLXMlkg", "newTab": true}, {"url": "https://d2w9rnfcy7mm78.cloudfront.net/27295361/original_cf72c585d2bcf272e564b81e349a1394.jpg?1711947235?bc=0", "link": "https://open.spotify.com/intl-es/album/6zZqkXJsKN5cZHziLzLUZ4?si=EKy2nCg-T9iCTFjnLXMlkg", "newTab": true}, {"url": "https://d2w9rnfcy7mm78.cloudfront.net/27295365/original_c8f0c25d4925ece1437668c462a195d2.jpg?1711947304?bc=0", "link": "https://open.spotify.com/intl-es/album/6zZqkXJsKN5cZHziLzLUZ4?si=EKy2nCg-T9iCTFjnLXMlkg", "newTab": true}, {"url": "https://d2w9rnfcy7mm78.cloudfront.net/27295366/original_704943df495df2eec3a520e479b86315.jpg?1711947306?bc=0", "link": "https://open.spotify.com/intl-es/album/6zZqkXJsKN5cZHziLzLUZ4?si=EKy2nCg-T9iCTFjnLXMlkg", "newTab": true}, {"url": "https://d2w9rnfcy7mm78.cloudfront.net/27295368/original_edbdd229611e8db6fcb988d441f6d72f.jpg?1711947313?bc=0", "link": "https://open.spotify.com/intl-es/album/6zZqkXJsKN5cZHziLzLUZ4?si=EKy2nCg-T9iCTFjnLXMlkg", "newTab": true}, {"url": "https://d2w9rnfcy7mm78.cloudfront.net/27295376/original_c41012589ddc5ce927a4f584d26a0e90.jpg?1711947390?bc=0", "link": "https://open.spotify.com/intl-es/album/6zZqkXJsKN5cZHziLzLUZ4?si=EKy2nCg-T9iCTFjnLXMlkg", "newTab": true}, {"url": "https://d2w9rnfcy7mm78.cloudfront.net/27295377/original_ae32f21d0f2e1ae1f687405fa01bdc2d.jpg?1711947409?bc=0", "link": "https://open.spotify.com/intl-es/album/6zZqkXJsKN5cZHziLzLUZ4?si=EKy2nCg-T9iCTFjnLXMlkg", "newTab": true}, {"url": "https://d2w9rnfcy7mm78.cloudfront.net/27295379/original_a39afc39f2c62dae46299b9e696f43e0.jpg?1711947422?bc=0", "link": "https://open.spotify.com/intl-es/album/6zZqkXJsKN5cZHziLzLUZ4?si=EKy2nCg-T9iCTFjnLXMlkg", "newTab": true}, {"url": "https://attachments.are.na/27295382/7358c9e15579b9e44cf36a0723d5a9dc.mov?1711947446", "link": "https://open.spotify.com/intl-es/album/6zZqkXJsKN5cZHziLzLUZ4?si=EKy2nCg-T9iCTFjnLXMlkg", "newTab": true}, {"url": "https://attachments.are.na/27295386/9dc8b9edbafaae1c4138a5882e4270bf.mov?1711947455", "link": "https://open.spotify.com/intl-es/album/6zZqkXJsKN5cZHziLzLUZ4?si=EKy2nCg-T9iCTFjnLXMlkg", "newTab": true},
    {"url": "https://d2w9rnfcy7mm78.cloudfront.net/37040970/original_f8e95e9c72ebefac577647a3f9b2e426.jpg?1748492059?bc=0", "link": "https://open.spotify.com/intl-es/album/6zZqkXJsKN5cZHziLzLUZ4?si=EKy2nCg-T9iCTFjnLXMlkg", "newTab": true}, {"url": "https://d2w9rnfcy7mm78.cloudfront.net/37040971/original_0440c90fc3e78a05bd2841492295a496.jpg?1748492061?bc=0", "link": "https://open.spotify.com/intl-es/album/6zZqkXJsKN5cZHziLzLUZ4?si=EKy2nCg-T9iCTFjnLXMlkg", "newTab": true}, {"url": "https://d2w9rnfcy7mm78.cloudfront.net/37040972/original_430fd910aeb0c0761b7a84ced9284eec.jpg?1748492063?bc=0", "link": "https://open.spotify.com/intl-es/album/6zZqkXJsKN5cZHziLzLUZ4?si=EKy2nCg-T9iCTFjnLXMlkg", "newTab": true}, {"url": "https://d2w9rnfcy7mm78.cloudfront.net/37040973/original_21ed6d57ccba6df7f9334189fda6a596.jpg?1748492063?bc=0", "link": "https://open.spotify.com/intl-es/album/6zZqkXJsKN5cZHziLzLUZ4?si=EKy2nCg-T9iCTFjnLXMlkg", "newTab": true}, {"url": "https://d2w9rnfcy7mm78.cloudfront.net/37040975/original_9f8ac08f8d777f2d0fd00fdcbd306392.jpg?1748492065?bc=0", "link": "https://open.spotify.com/intl-es/album/6zZqkXJsKN5cZHziLzLUZ4?si=EKy2nCg-T9iCTFjnLXMlkg", "newTab": true}, {"url": "https://d2w9rnfcy7mm78.cloudfront.net/37040978/original_18b77f615e376408954c4bb985f6322c.jpg?1748492064?bc=0", "link": "https://open.spotify.com/intl-es/album/6zZqkXJsKN5cZHziLzLUZ4?si=EKy2nCg-T9iCTFjnLXMlkg", "newTab": true}, {"url": "https://d2w9rnfcy7mm78.cloudfront.net/37040979/original_0f096720ff646013cff0f43455b997eb.jpg?1748492065?bc=0", "link": "https://open.spotify.com/intl-es/album/6zZqkXJsKN5cZHziLzLUZ4?si=EKy2nCg-T9iCTFjnLXMlkg", "newTab": true}, {"url": "https://d2w9rnfcy7mm78.cloudfront.net/37040980/original_ff56e51f1a8dc8d58099c6691fb6215d.jpg?1748492065?bc=0", "link": "https://open.spotify.com/intl-es/album/6zZqkXJsKN5cZHziLzLUZ4?si=EKy2nCg-T9iCTFjnLXMlkg", "newTab": true}, {"url": "https://d2w9rnfcy7mm78.cloudfront.net/37040981/original_ea88af0c0d5837832491e982440b20ee.jpg?1748492065?bc=0", "link": "https://open.spotify.com/intl-es/album/6zZqkXJsKN5cZHziLzLUZ4?si=EKy2nCg-T9iCTFjnLXMlkg", "newTab": true}, {"url": "https://d2w9rnfcy7mm78.cloudfront.net/37040982/original_5aaecf6e40f88ace8f06696109c3aba7.jpg?1748492065?bc=0", "link": "https://open.spotify.com/intl-es/album/6zZqkXJsKN5cZHziLzLUZ4?si=EKy2nCg-T9iCTFjnLXMlkg", "newTab": true}, {"url": "https://d2w9rnfcy7mm78.cloudfront.net/37040983/original_4aeace046ef5db1b4b63faefe94ff70b.jpg?1748492064?bc=0", "link": "https://open.spotify.com/intl-es/album/6zZqkXJsKN5cZHziLzLUZ4?si=EKy2nCg-T9iCTFjnLXMlkg", "newTab": true}, {"url": "https://d2w9rnfcy7mm78.cloudfront.net/37040985/original_490e9a1f27897403f923b1a1a6135d75.jpg?1748492066?bc=0", "link": "https://open.spotify.com/intl-es/album/6zZqkXJsKN5cZHziLzLUZ4?si=EKy2nCg-T9iCTFjnLXMlkg", "newTab": true}, {"url": "https://d2w9rnfcy7mm78.cloudfront.net/37040986/original_932cc595f10a20fd6fd7ca9b0d1eec3a.jpg?1748492066?bc=0", "link": "https://open.spotify.com/intl-es/album/6zZqkXJsKN5cZHziLzLUZ4?si=EKy2nCg-T9iCTFjnLXMlkg", "newTab": true}, {"url": "https://d2w9rnfcy7mm78.cloudfront.net/37040987/original_c9394c356f3d91541625416c3d58da2b.jpg?1748492067?bc=0", "link": "https://open.spotify.com/intl-es/album/6zZqkXJsKN5cZHziLzLUZ4?si=EKy2nCg-T9iCTFjnLXMlkg", "newTab": true}, {"url": "https://d2w9rnfcy7mm78.cloudfront.net/37040988/original_6c4702610e425abace89e32768a119e6.jpg?1748492067?bc=0", "link": "https://open.spotify.com/intl-es/album/6zZqkXJsKN5cZHziLzLUZ4?si=EKy2nCg-T9iCTFjnLXMlkg", "newTab": true}, {"url": "https://d2w9rnfcy7mm78.cloudfront.net/37040989/original_2ff4072ab9f7edef4216441cd67eafdb.jpg?1748492067?bc=0", "link": "https://open.spotify.com/intl-es/album/6zZqkXJsKN5cZHziLzLUZ4?si=EKy2nCg-T9iCTFjnLXMlkg", "newTab": true}, {"url": "https://d2w9rnfcy7mm78.cloudfront.net/37040990/original_42491a92c043d79c47a7d08e32b31f68.jpg?1748492067?bc=0", "link": "https://open.spotify.com/intl-es/album/6zZqkXJsKN5cZHziLzLUZ4?si=EKy2nCg-T9iCTFjnLXMlkg", "newTab": true}, {"url": "https://d2w9rnfcy7mm78.cloudfront.net/37040991/original_7d778fea5769d2eb7cc69d96ef52acef.jpg?1748492067?bc=0", "link": "https://open.spotify.com/intl-es/album/6zZqkXJsKN5cZHziLzLUZ4?si=EKy2nCg-T9iCTFjnLXMlkg", "newTab": true}, {"url": "https://d2w9rnfcy7mm78.cloudfront.net/37040992/original_677e33dd828d7cb28290319d06f96eae.jpg?1748492068?bc=0", "link": "https://open.spotify.com/intl-es/album/6zZqkXJsKN5cZHziLzLUZ4?si=EKy2nCg-T9iCTFjnLXMlkg", "newTab": true}, {"url": "https://d2w9rnfcy7mm78.cloudfront.net/37040993/original_da0bbe580a0d2a8bb238eb0ed0d58a6f.jpg?1748492068?bc=0", "link": "https://open.spotify.com/intl-es/album/6zZqkXJsKN5cZHziLzLUZ4?si=EKy2nCg-T9iCTFjnLXMlkg", "newTab": true}, {"url": "https://d2w9rnfcy7mm78.cloudfront.net/37040994/original_730bba1d9c7f956cf3eb51eb42339d46.jpg?1748492069?bc=0", "link": "https://open.spotify.com/intl-es/album/6zZqkXJsKN5cZHziLzLUZ4?si=EKy2nCg-T9iCTFjnLXMlkg", "newTab": true}, {"url": "https://d2w9rnfcy7mm78.cloudfront.net/37040995/original_a3ea980f3b47ab3961ab1e8e3ca42cd9.jpg?1748492069?bc=0", "link": "https://open.spotify.com/intl-es/album/6zZqkXJsKN5cZHziLzLUZ4?si=EKy2nCg-T9iCTFjnLXMlkg", "newTab": true}, {"url": "https://d2w9rnfcy7mm78.cloudfront.net/37040996/original_6645876c22337a77cb931b37c2979049.jpg?1748492069?bc=0", "link": "https://open.spotify.com/intl-es/album/6zZqkXJsKN5cZHziLzLUZ4?si=EKy2nCg-T9iCTFjnLXMlkg", "newTab": true}, {"url": "https://d2w9rnfcy7mm78.cloudfront.net/37040997/original_e5dbb598a91f19ce27ce0bb18d5ff921.jpg?1748492069?bc=0", "link": "https://open.spotify.com/intl-es/album/6zZqkXJsKN5cZHziLzLUZ4?si=EKy2nCg-T9iCTFjnLXMlkg", "newTab": true}, {"url": "https://d2w9rnfcy7mm78.cloudfront.net/37040998/original_43fa44642725abe5dbaa2372a8aa5fc6.jpg?1748492070?bc=0", "link": "https://open.spotify.com/intl-es/album/6zZqkXJsKN5cZHziLzLUZ4?si=EKy2nCg-T9iCTFjnLXMlkg", "newTab": true}, {"url": "https://d2w9rnfcy7mm78.cloudfront.net/37040999/original_70d04840bca066103699800b38586c79.jpg?1748492070?bc=0", "link": "https://open.spotify.com/intl-es/album/6zZqkXJsKN5cZHziLzLUZ4?si=EKy2nCg-T9iCTFjnLXMlkg", "newTab": true}, {"url": "https://d2w9rnfcy7mm78.cloudfront.net/37041000/original_95215f961ea60744ccbb29a00d419efe.jpg?1748492070?bc=0", "link": "https://open.spotify.com/intl-es/album/6zZqkXJsKN5cZHziLzLUZ4?si=EKy2nCg-T9iCTFjnLXMlkg", "newTab": true}, {"url": "https://d2w9rnfcy7mm78.cloudfront.net/37041001/original_e3ccad4a765863ee94e37e44c70bb5a6.jpg?1748492070?bc=0", "link": "https://open.spotify.com/intl-es/album/6zZqkXJsKN5cZHziLzLUZ4?si=EKy2nCg-T9iCTFjnLXMlkg", "newTab": true}, {"url": "https://d2w9rnfcy7mm78.cloudfront.net/37041002/original_f13e6cc20290f2cc266a5823e9e65b4a.jpg?1748492072?bc=0", "link": "https://open.spotify.com/intl-es/album/6zZqkXJsKN5cZHziLzLUZ4?si=EKy2nCg-T9iCTFjnLXMlkg", "newTab": true}, {"url": "https://d2w9rnfcy7mm78.cloudfront.net/37041003/original_b3801813cce79162e03928e88e3cd68a.jpg?1748492072?bc=0", "link": "https://open.spotify.com/intl-es/album/6zZqkXJsKN5cZHziLzLUZ4?si=EKy2nCg-T9iCTFjnLXMlkg", "newTab": true}, {"url": "https://d2w9rnfcy7mm78.cloudfront.net/37041004/original_db7447e5393e906d785c2b8a209e3f7a.jpg?1748492073?bc=0", "link": "https://open.spotify.com/intl-es/album/6zZqkXJsKN5cZHziLzLUZ4?si=EKy2nCg-T9iCTFjnLXMlkg", "newTab": true}, {"url": "https://d2w9rnfcy7mm78.cloudfront.net/37041005/original_e22025180c6feb40e829ff8bca294a94.jpg?1748492073?bc=0", "link": "https://open.spotify.com/intl-es/album/6zZqkXJsKN5cZHziLzLUZ4?si=EKy2nCg-T9iCTFjnLXMlkg", "newTab": true}, {"url": "https://d2w9rnfcy7mm78.cloudfront.net/37041006/original_091ac170fe75e8dea95cbfaef976a863.jpg?1748492073?bc=0", "link": "https://open.spotify.com/intl-es/album/6zZqkXJsKN5cZHziLzLUZ4?si=EKy2nCg-T9iCTFjnLXMlkg", "newTab": true}, {"url": "https://d2w9rnfcy7mm78.cloudfront.net/37041007/original_c7466720cf2bc44af04ac0417356bd74.jpg?1748492073?bc=0", "link": "https://open.spotify.com/intl-es/album/6zZqkXJsKN5cZHziLzLUZ4?si=EKy2nCg-T9iCTFjnLXMlkg", "newTab": true}]


    const stage = document.getElementById('aeiStage');
    const lines = document.getElementById('aeiLines');
    renderAEI(stage, lines, aeiMedia);

    /* ================== warmup ocioso ================== */
    (function idleWarmup(){
      if(!('requestIdleCallback' in window)) return;
      const warm = () => requestIdleCallback(() => {
        document.querySelectorAll('video[data-src]').forEach(v => { if(!v.src){ v.src = v.dataset.src; v.load(); } });
      }, { timeout:1500 });
      document.addEventListener('DOMContentLoaded', warm, { once:true });
      window.addEventListener('load', warm, { once:true });
    })();
  </script>
</body>
</html>
