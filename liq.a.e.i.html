<!DOCTYPE html>
<html lang="es">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>a.e.i_msh.17.jul-19.ago.25[39^] — visor líquido total</title>
  <link rel="preconnect" href="https://d2w9rnfcy7mm78.cloudfront.net" crossorigin>
  <link rel="preconnect" href="https://attachments.are.na" crossorigin>
  <style>
    :root{ --bg:#fff; --fg:#0a0a0a; --line:rgba(0,0,0,.12); --ease:cubic-bezier(.22,.61,.36,1); }
    *{box-sizing:border-box}
    html,body{margin:0;height:100%;background:var(--bg);color:var(--fg);font-family:"Times New Roman",serif}
    a{color:inherit;text-decoration:none}
    header{position:fixed;top:12px;left:12px;z-index:20}
    header img{width:50px;height:auto;display:block}
    .ui{position:fixed;right:12px;top:12px;z-index:20;display:flex;gap:8px;flex-wrap:wrap;align-items:center}
    .btn,.chip{background:#fff;border:1px solid var(--line);border-radius:999px;padding:.38rem .7rem;font-size:.9rem;cursor:pointer}
    .chip{cursor:default}
    .range{appearance:none;height:4px;width:160px;background:var(--line);border-radius:999px;outline:none}
    .range::-webkit-slider-thumb{appearance:none;width:16px;height:16px;border-radius:50%;background:#000}
    .range::-moz-range-thumb{width:16px;height:16px;border-radius:50%;background:#000;border:none}
    canvas#liq{position:fixed;inset:0;display:block;width:100vw;height:100vh}
    .hint{position:fixed;left:12px;bottom:12px;z-index:20;font-size:.85rem;opacity:.6;background:transparent}
    .hidden{display:none}
  </style>
</head>
<body>
  <header><a href="/" aria-label="xpan"><img src="xpan.svg" alt="xpan" fetchpriority="high"></a></header>

  <div class="ui" id="ui">
    <span class="chip">visor líquido total</span>
    <span class="chip">solo imágenes (CORS)</span>
    <label class="chip">N <input id="nRange" class="range" type="range" min="2" max="8" step="1" value="6"></label>
    <button id="cycleBtn" class="btn">autociclo: on</button>
    <button id="reseedBtn" class="btn">reseed</button>
    <button id="hideBtn" class="btn">ocultar UI (L)</button>
  </div>

  <div class="hint">drag = mover masas · wheel = tamaño · tap/tecla L alterna UI</div>
  <canvas id="liq"></canvas>

  <script src="https://cdnjs.cloudflare.com/ajax/libs/three.js/r128/three.min.js"></script>
  <script id="vs" type="x-shader/x-vertex">varying vec2 vUv;void main(){vUv=uv;gl_Position=vec4(position,1.0);} </script>
  <script id="fs" type="x-shader/x-fragment">
    precision mediump float; varying vec2 vUv;
    // hasta 8 texturas
    uniform sampler2D uTex1,uTex2,uTex3,uTex4,uTex5,uTex6,uTex7,uTex8;
    uniform int uN; // activas
    uniform vec2 uC1,uS1,uC2,uS2,uC3,uS3,uC4,uS4,uC5,uS5,uC6,uS6,uC7,uS7,uC8,uS8; 
    uniform vec2 uPx; uniform float uTime;

    float rectMask(vec2 uv, vec2 c, vec2 s, float feather){ vec2 p=(uv-c)/s+0.5; vec2 d=min(p,1.0-p); float inside=step(0.0, min(d.x,d.y)); float aa=smoothstep(0.0, feather, min(d.x,d.y)); return inside*aa; }
    float blurMask(vec2 uv, vec2 c, vec2 s, float r){ vec2 o=uPx*r; vec2 k[9]; k[0]=vec2(0,0); k[1]=vec2(1,0); k[2]=vec2(-1,0); k[3]=vec2(0,1); k[4]=vec2(0,-1); k[5]=vec2(1,1); k[6]=vec2(-1,1); k[7]=vec2(1,-1); k[8]=vec2(-1,-1); float w[9]; w[0]=1.0; w[1]=0.9; w[2]=0.9; w[3]=0.9; w[4]=0.9; w[5]=0.7; w[6]=0.7; w[7]=0.7; w[8]=0.7; float m=0.0, sum=0.0; for(int i=0;i<9;i++){ float mi=rectMask(uv+vec2(k[i].x*o.x,k[i].y*o.y),c,s,0.02); m+=mi*w[i]; sum+=w[i]; } return m/max(sum,1e-5); }
    vec2 imgUV(vec2 uv, vec2 c, vec2 s){ return (uv-c)/s+0.5; }
    float n2(vec2 p){ return fract(sin(dot(p,vec2(127.1,311.7)))*43758.5453); }
    float noise(vec2 p){ vec2 i=floor(p), f=fract(p); float a=n2(i), b=n2(i+vec2(1,0)), c=n2(i+vec2(0,1)), d=n2(i+vec2(1,1)); vec2 u=f*f*(3.0-2.0*f); return mix(mix(a,b,u.x), mix(c,d,u.x), u.y); }
    vec2 warp(vec2 p, float k){ float t=uTime*0.8; vec2 q=p*vec2(20.0,16.0)+vec2(t,-t*0.7); vec2 d=vec2(noise(q),noise(q+17.3))-0.5; return p + k*0.04*d; }

    vec3 pick(int i, vec2 uv){
      if(i==0) return texture2D(uTex1,uv).rgb; if(i==1) return texture2D(uTex2,uv).rgb; if(i==2) return texture2D(uTex3,uv).rgb; if(i==3) return texture2D(uTex4,uv).rgb; if(i==4) return texture2D(uTex5,uv).rgb; if(i==5) return texture2D(uTex6,uv).rgb; if(i==6) return texture2D(uTex7,uv).rgb; return texture2D(uTex8,uv).rgb;
    }

    void main(){
      vec2 C[8]; vec2 S[8];
      C[0]=uC1;S[0]=uS1; C[1]=uC2;S[1]=uS2; C[2]=uC3;S[2]=uS3; C[3]=uC4;S[3]=uS4; C[4]=uC5;S[4]=uS5; C[5]=uC6;S[5]=uS6; C[6]=uC7;S[6]=uS7; C[7]=uC8;S[7]=uS8;
      float lo=0.30, hi=0.52; float R=16.0; float sum=0.0; float m[8];
      for(int i=0;i<8;i++){ if(i>=uN) break; m[i]=blurMask(vUv,C[i],S[i],R); sum+=m[i]; }
      float field=pow(sum,0.8); float mask=smoothstep(lo,hi,field); if(mask<=0.0) discard;
      float k=smoothstep(hi,hi+0.35,field);
      vec3 acc=vec3(0.0); float wsum=0.0;
      for(int i=0;i<8;i++){
        if(i>=uN) break; vec2 uvi=warp(imgUV(vUv,C[i],S[i]),k);
        bool inside=(uvi.x>=0.0&&uvi.x<=1.0&&uvi.y>=0.0&&uvi.y<=1.0);
        vec3 ci=inside?pick(i,uvi):vec3(0.0);
        float w=smoothstep(lo,hi+0.35,pow(m[i],0.95)); acc+=ci*w; wsum+=w;
      }
      vec3 col=acc/max(wsum,1e-5);
      float rim=smoothstep(hi-0.02,hi+0.00,field)-smoothstep(hi+0.00,hi+0.08,field); col+=rim*0.10;
      gl_FragColor=vec4(col,1.0);
    }
  </script>

  <script>
  const canvas=document.getElementById('liq');
  const ui=document.getElementById('ui');
  const nRange=document.getElementById('nRange');
  const cycleBtn=document.getElementById('cycleBtn');
  const reseedBtn=document.getElementById('reseedBtn');
  const hideBtn=document.getElementById('hideBtn');

  // pool completo (toda la media del a.e.i)
  const aeiMedia=[
    "https://attachments.are.na/38902682/0ad113fe72346cb0e320d672fac7e009.mov?1755663007",
    "https://attachments.are.na/38902606/c4754f13a1d09f36500ded9f69338384.mov?1755662683",
    "https://d2w9rnfcy7mm78.cloudfront.net/38902605/original_13fd98b1144bdcbe3eddebc0f4e6ab32.png?1755662677?bc=0",
    "https://d2w9rnfcy7mm78.cloudfront.net/38902604/original_9e6bc3d928adb1a03bc5bc44c90ed4da.jpg?1755662677?bc=0",
    "https://d2w9rnfcy7mm78.cloudfront.net/38902603/original_712f4ba2f726267ea9452d4828a3ae48.jpg?1755662677?bc=0",
    "https://d2w9rnfcy7mm78.cloudfront.net/38902602/original_63b897a35d098eabba0e996ff1cd8587.jpg?1755662677?bc=0",
    "https://d2w9rnfcy7mm78.cloudfront.net/38902601/original_1199fe90de5e389cf8c9d5fa3da5f560.png?1755662677?bc=0",
    "https://d2w9rnfcy7mm78.cloudfront.net/38902600/original_55eedd41df6caed7ddffdacece0066e3.jpg?1755662676?bc=0",
    "https://d2w9rnfcy7mm78.cloudfront.net/38902599/original_09eb1131c02c8b1a7bd576cfdd7aaf80.png?1755662677?bc=0",
    "https://d2w9rnfcy7mm78.cloudfront.net/38902598/original_b613d722e961515022a11cae6bacbce3.jpg?1755662676?bc=0",
    "https://d2w9rnfcy7mm78.cloudfront.net/38902597/original_c7617720bf1d067cd7d5e9588c007c27.jpg?1755662677?bc=0",
    "https://d2w9rnfcy7mm78.cloudfront.net/38902596/original_36436c20c77489969fe8177500a8e0f2.png?1755662676?bc=0",
    "https://d2w9rnfcy7mm78.cloudfront.net/38902595/original_ebbe40e6f8d5c9e3fba5d3d1e3cd14e1.jpg?1755662676?bc=0",
    "https://d2w9rnfcy7mm78.cloudfront.net/38902594/original_aa37e32e361f371cfea89d239fe6af6b.png?1755662676?bc=0",
    "https://d2w9rnfcy7mm78.cloudfront.net/38902593/original_7d72e45a109946fb50c21f85734a48ef.jpg?1755662676?bc=0",
    "https://d2w9rnfcy7mm78.cloudfront.net/38902592/original_965eeb42511fb679e3db4df5463a9f66.jpg?1755662676?bc=0",
    "https://d2w9rnfcy7mm78.cloudfront.net/38902591/original_e03b2f9b8483efa54a77c55e4ab89fcd.jpg?1755662676?bc=0",
    "https://d2w9rnfcy7mm78.cloudfront.net/38902590/original_781bc941fed21d7e55a5153bd31a3139.jpg?1755662675?bc=0",
    "https://d2w9rnfcy7mm78.cloudfront.net/38902589/original_2ff1b991f092214615ce1f96c22ced4c.jpg?1755662675?bc=0",
    "https://d2w9rnfcy7mm78.cloudfront.net/38902588/original_ac58a167437b1fd560f2382948667ecb.jpg?1755662675?bc=0",
    "https://d2w9rnfcy7mm78.cloudfront.net/38902587/original_c4fc7f7a4062bb6f6598a96bf53bae46.jpg?1755662675?bc=0",
    "https://d2w9rnfcy7mm78.cloudfront.net/38902586/original_a12a5a222e1898a8895c1fa34a0865a0.png?1755662674?bc=0",
    "https://d2w9rnfcy7mm78.cloudfront.net/38902585/original_5a80cb11de1e26b00014d98e6037846c.jpg?1755662673?bc=0",
    "https://d2w9rnfcy7mm78.cloudfront.net/38902584/original_e9799eb7deff4093be9caefab97ad4f9.jpg?1755662674?bc=0",
    "https://d2w9rnfcy7mm78.cloudfront.net/38902583/original_08970f0fa19147f6b8cf39d5a0d3efb9.jpg?1755662674?bc=0",
    "https://d2w9rnfcy7mm78.cloudfront.net/38902582/original_56502bf33b2e727c2c566914b00b1461.jpg?1755662674?bc=0",
    "https://attachments.are.na/38902730/352c729e3a82dd18a32ee27aa035266e.mov?1755663318",
    "https://attachments.are.na/38902728/9b0c11e118754aaa2ba7daffd77408e3.mov?1755663314",
    "https://d2w9rnfcy7mm78.cloudfront.net/38902726/original_6289b10147df5716069e242da845de85.jpg?1755663300?bc=0",
    "https://d2w9rnfcy7mm78.cloudfront.net/38902725/original_52d57b757725a78819ebed125e935506.png?1755663300?bc=0",
    "https://d2w9rnfcy7mm78.cloudfront.net/38902724/original_9ed4f32f3e3490cab445f9174e131813.jpg?1755663300?bc=0",
    "https://d2w9rnfcy7mm78.cloudfront.net/38902723/original_b5720c32ba87b7d3fad27a81ccf0ffd6.jpg?1755663300?bc=0",
    "https://d2w9rnfcy7mm78.cloudfront.net/38902722/original_a01cdf7a731fe3e277537035257c6cc2.jpg?1755663300?bc=0",
    "https://d2w9rnfcy7mm78.cloudfront.net/38902721/original_ee28d6648bcc4e31dc4bfa19398cea14.jpg?1755663300?bc=0",
    "https://d2w9rnfcy7mm78.cloudfront.net/38902720/original_98b962e1a712e76ed58f513bb3b49e4a.jpg?1755663299?bc=0"
  ];

  // CORS: proxy solo para imágenes
  function prox(u){ try{ const url=new URL(u); const host=url.hostname; const isImg=/\.(png|jpe?g|webp)(\?|$)/i.test(u); if(!isImg) return u; if(host.includes('cloudfront.net')||host.includes('are.na')){ return 'https://images.weserv.nl/?url='+encodeURIComponent(url.hostname+url.pathname+url.search)+'&n=-1'; } return u; }catch{ return u; } }

  const imagePool=aeiMedia.filter(u=>/\.(png|jpe?g|webp)(\?|$)/i.test(u)).map(prox);
  if(!imagePool.length){ console.warn('Sin imágenes con CORS.'); }

  // ——— THREE setup ———
  const renderer=new THREE.WebGLRenderer({canvas,antialias:true});
  renderer.setPixelRatio(Math.min(devicePixelRatio||1,2));
  const scene=new THREE.Scene();
  const cam=new THREE.OrthographicCamera(-1,1,1,-1,0,1);
  const loader=new THREE.TextureLoader(); loader.setCrossOrigin('anonymous');

  function resize(){ const w=innerWidth,h=innerHeight; renderer.setSize(w,h,false); if(uniforms) uniforms.uPx.value.set(1/w,1/h); }
  addEventListener('resize',resize,{passive:true}); resize();

  const uniforms={
    uTex1:{value:null},uTex2:{value:null},uTex3:{value:null},uTex4:{value:null},uTex5:{value:null},uTex6:{value:null},uTex7:{value:null},uTex8:{value:null},
    uN:{value:6},
    uC1:{value:new THREE.Vector2(.25,.52)},uS1:{value:new THREE.Vector2(.30,.30)},
    uC2:{value:new THREE.Vector2(.75,.48)},uS2:{value:new THREE.Vector2(.30,.30)},
    uC3:{value:new THREE.Vector2(.50,.25)},uS3:{value:new THREE.Vector2(.28,.28)},
    uC4:{value:new THREE.Vector2(.50,.75)},uS4:{value:new THREE.Vector2(.28,.28)},
    uC5:{value:new THREE.Vector2(.15,.25)},uS5:{value:new THREE.Vector2(.24,.24)},
    uC6:{value:new THREE.Vector2(.85,.75)},uS6:{value:new THREE.Vector2(.24,.24)},
    uC7:{value:new THREE.Vector2(.20,.80)},uS7:{value:new THREE.Vector2(.22,.22)},
    uC8:{value:new THREE.Vector2(.80,.20)},uS8:{value:new THREE.Vector2(.22,.22)},
    uPx:{value:new THREE.Vector2(1/innerWidth,1/innerHeight)}, uTime:{value:0}
  };

  const mat=new THREE.ShaderMaterial({
    uniforms, vertexShader:document.getElementById('vs').textContent,
    fragmentShader:document.getElementById('fs').textContent, transparent:false,
    depthTest:false, depthWrite:false, blending:THREE.NoBlending
  });
  scene.add(new THREE.Mesh(new THREE.PlaneGeometry(2,2),mat));

  function makeImageTexture(url){ const t=loader.load(url); t.minFilter=t.magFilter=THREE.LinearFilter; return t; }
  function setTex(i, tex){ uniforms['uTex'+i].value=tex; }

  const playlist=[...imagePool];
  let cursor=0; const activeN=()=>uniforms.uN.value;

  function fillInitial(){ const n=activeN(); for(let i=1;i<=n;i++){ const url=playlist[cursor++ % playlist.length]; setTex(i, makeImageTexture(url)); } }
  fillInitial();

  let cycling=true; cycleBtn.onclick=()=>{ cycling=!cycling; cycleBtn.textContent='autociclo: '+(cycling?'on':'off'); };
  reseedBtn.onclick=()=>{ randomizeBlobs(); };
  hideBtn.onclick=toggleUI; function toggleUI(){ ui.classList.toggle('hidden'); }
  addEventListener('keydown',e=>{ if(e.key==='l'||e.key==='L'){ toggleUI(); } });

  nRange.oninput=()=>{ uniforms.uN.value=parseInt(nRange.value,10); };

  function stepCycle(){ if(!cycling||!playlist.length) return; const slot=(Math.floor(performance.now()/5000)%activeN())+1; const url=playlist[cursor++ % playlist.length]; setTex(slot, makeImageTexture(url)); }
  setInterval(stepCycle, 1600);

  const blobs=[
    {c:uniforms.uC1.value,s:uniforms.uS1.value},
    {c:uniforms.uC2.value,s:uniforms.uS2.value},
    {c:uniforms.uC3.value,s:uniforms.uS3.value},
    {c:uniforms.uC4.value,s:uniforms.uS4.value},
    {c:uniforms.uC5.value,s:uniforms.uS5.value},
    {c:uniforms.uC6.value,s:uniforms.uS6.value},
    {c:uniforms.uC7.value,s:uniforms.uS7.value},
    {c:uniforms.uC8.value,s:uniforms.uS8.value}
  ];

  function randomizeBlobs(){ for(const b of blobs){ b.c.set(Math.random()*0.8+0.1, Math.random()*0.8+0.1); b.s.set(0.22+Math.random()*0.12, 0.22+Math.random()*0.12); } }

  let dragging=null; function uvFromEvent(e){ return new THREE.Vector2(e.clientX/renderer.domElement.clientWidth, 1 - e.clientY/renderer.domElement.clientHeight); }
  function hit(uv){ const n=activeN(); for(let i=0;i<n;i++){ const b=blobs[i]; const p=uv.clone().sub(b.c).divide(b.s).addScalar(0.5); if(p.x>=0&&p.x<=1&&p.y>=0&&p.y<=1) return b; } return null; }
  canvas.addEventListener('pointerdown',e=>{ const uv=uvFromEvent(e); dragging=hit(uv); });
  addEventListener('pointermove',e=>{ if(!dragging) return; const uv=uvFromEvent(e); dragging.c.set(uv.x,uv.y); });
  addEventListener('pointerup',()=>dragging=null);
  addEventListener('pointercancel',()=>dragging=null);
  addEventListener('wheel',e=>{ if(!dragging) return; const t=e.deltaY>0?0.96:1.04; dragging.s.multiplyScalar(t); });

  renderer.setAnimationLoop((t)=>{ uniforms.uTime.value=t*0.001; renderer.setClearColor(0xffffff,1); renderer.render(scene,cam); });
  </script>
</body>
</html>
